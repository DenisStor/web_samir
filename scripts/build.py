#!/usr/bin/env python3
"""
Build script –¥–ª—è —Å–±–æ—Ä–∫–∏ index.html –∏–∑ —Å–µ–∫—Ü–∏–π –∏ admin.bundle.js –∏–∑ –º–æ–¥—É–ª–µ–π.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    python3 build.py              # –°–æ–±—Ä–∞—Ç—å index.html –∏ admin.bundle.js
    python3 build.py --watch      # –°–æ–±—Ä–∞—Ç—å –∏ —Å–ª–µ–¥–∏—Ç—å –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
    python3 build.py --admin-only # –°–æ–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ admin.bundle.js

–ü–æ—Ä—è–¥–æ–∫ —Å–µ–∫—Ü–∏–π –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤ SECTIONS.
–ü–æ—Ä—è–¥–æ–∫ –º–æ–¥—É–ª–µ–π admin –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤ ADMIN_MODULES.
"""

import os
import sys
import time
from pathlib import Path

# –ü–æ—Ä—è–¥–æ–∫ —Å–µ–∫—Ü–∏–π –¥–ª—è —Å–±–æ—Ä–∫–∏ index.html
SECTIONS = [
    'head.html',
    'navigation.html',
    'marquee.html',
    'hero.html',
    'services.html',
    'podology.html',
    'masters.html',
    'location.html',
    'social.html',
    'blog.html',
    'faq.html',
    'booking.html',
    'blog-modal.html',
    'footer.html',
    'scripts.html',
]

# –ü–æ—Ä—è–¥–æ–∫ –º–æ–¥—É–ª–µ–π admin –¥–ª—è —Å–±–æ—Ä–∫–∏ admin.bundle.js
# –í–ê–ñ–ù–û: –ø–æ—Ä—è–¥–æ–∫ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ —Ä–∞–Ω—å—à–µ –∑–∞–≤–∏—Å—è—â–∏—Ö –º–æ–¥—É–ª–µ–π
ADMIN_MODULES = [
    # Core modules (–±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
    'state.js',
    'toast.js',
    'api.js',
    'auth.js',
    'navigation.js',
    'modals.js',
    'image-upload.js',
    'wysiwyg.js',

    # Renderers
    'renderers/stats.js',
    'renderers/masters.js',
    'renderers/services.js',
    'renderers/articles.js',
    'renderers/faq.js',
    'renderers/social.js',

    # Forms
    'forms/master-form.js',
    'forms/service-form.js',
    'forms/article-form.js',
    'forms/faq-form.js',

    # Main entry point (–ø–æ—Å–ª–µ–¥–Ω–∏–π, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Å–µ—Ö)
    'index.js',
]

# –ü—É—Ç–∏
BASE_DIR = Path(__file__).parent.parent  # –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ (–Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ scripts/)
SRC_DIR = BASE_DIR / 'src'
SECTIONS_DIR = SRC_DIR / 'sections'
OUTPUT_FILE = BASE_DIR / 'index.html'  # –í –∫–æ—Ä–Ω–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
ADMIN_MODULES_DIR = SRC_DIR / 'js' / 'admin'
ADMIN_BUNDLE_FILE = SRC_DIR / 'js' / 'admin.bundle.js'


def build():
    """–°–æ–±–∏—Ä–∞–µ—Ç index.html –∏–∑ —Å–µ–∫—Ü–∏–π."""
    parts = []

    for section in SECTIONS:
        section_path = SECTIONS_DIR / section
        if not section_path.exists():
            print(f'‚ö†Ô∏è  –°–µ–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {section}')
            continue

        content = section_path.read_text(encoding='utf-8')
        parts.append(content)

    # –°–æ–±–∏—Ä–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π HTML
    html = '\n'.join(parts)

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    OUTPUT_FILE.write_text(html, encoding='utf-8')
    print(f'‚úÖ –°–æ–±—Ä–∞–Ω index.html ({len(html):,} –±–∞–π—Ç)')

    return html


def build_admin():
    """–°–æ–±–∏—Ä–∞–µ—Ç admin.bundle.js –∏–∑ –º–æ–¥—É–ª–µ–π."""
    parts = []

    # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–∞–Ω–¥–ª–∞
    header = '''/**
 * Say's Barbers Admin Panel Bundle
 * Auto-generated by build.py - DO NOT EDIT DIRECTLY
 * Edit individual modules in src/js/admin/ instead
 */

'''
    parts.append(header)

    for module in ADMIN_MODULES:
        module_path = ADMIN_MODULES_DIR / module
        if not module_path.exists():
            print(f'‚ö†Ô∏è  –ú–æ–¥—É–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω: {module}')
            continue

        content = module_path.read_text(encoding='utf-8')
        # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –∏–º–µ–Ω–µ–º —Ñ–∞–π–ª–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        parts.append(f'\n// ============= {module} =============\n')
        parts.append(content)

    # –°–æ–±–∏—Ä–∞–µ–º –±–∞–Ω–¥–ª
    bundle = '\n'.join(parts)

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    ADMIN_BUNDLE_FILE.write_text(bundle, encoding='utf-8')
    print(f'‚úÖ –°–æ–±—Ä–∞–Ω admin.bundle.js ({len(bundle):,} –±–∞–π—Ç, {len(ADMIN_MODULES)} –º–æ–¥—É–ª–µ–π)')

    return bundle


def get_admin_modules_mtime():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ admin –º–æ–¥—É–ª–µ–π."""
    max_mtime = 0
    for module in ADMIN_MODULES:
        module_path = ADMIN_MODULES_DIR / module
        if module_path.exists():
            mtime = module_path.stat().st_mtime
            if mtime > max_mtime:
                max_mtime = mtime
    return max_mtime


def get_sections_mtime():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–µ–∫—Ü–∏–π."""
    max_mtime = 0
    for section in SECTIONS:
        section_path = SECTIONS_DIR / section
        if section_path.exists():
            mtime = section_path.stat().st_mtime
            if mtime > max_mtime:
                max_mtime = mtime
    return max_mtime


def watch():
    """–°–ª–µ–¥–∏—Ç –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ —Å–µ–∫—Ü–∏—è—Ö –∏ admin –º–æ–¥—É–ª—è—Ö, –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏."""
    print('üëÄ –†–µ–∂–∏–º –Ω–∞–±–ª—é–¥–µ–Ω–∏—è. –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞.')

    last_sections_mtime = 0
    last_admin_mtime = 0

    try:
        while True:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ü–∏–π
            current_sections_mtime = get_sections_mtime()
            if current_sections_mtime > last_sections_mtime:
                if last_sections_mtime > 0:
                    print('üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–µ–∫—Ü–∏—è—Ö, –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞...')
                build()
                last_sections_mtime = current_sections_mtime

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ admin –º–æ–¥—É–ª–µ–π
            current_admin_mtime = get_admin_modules_mtime()
            if current_admin_mtime > last_admin_mtime:
                if last_admin_mtime > 0:
                    print('üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ admin –º–æ–¥—É–ª—è—Ö, –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞...')
                build_admin()
                last_admin_mtime = current_admin_mtime

            time.sleep(1)
    except KeyboardInterrupt:
        print('\nüëã –ù–∞–±–ª—é–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.')


def build_all():
    """–°–æ–±–∏—Ä–∞–µ—Ç –∏ index.html –∏ admin.bundle.js."""
    build()
    build_admin()


if __name__ == '__main__':
    if '--watch' in sys.argv or '-w' in sys.argv:
        build_all()
        watch()
    elif '--admin-only' in sys.argv:
        build_admin()
    elif '--html-only' in sys.argv:
        build()
    else:
        build_all()
