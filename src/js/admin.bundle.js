/**
 * Say's Barbers Admin Panel Bundle
 * Auto-generated by build.py - DO NOT EDIT DIRECTLY
 * Edit individual modules in src/js/admin/ instead
 */



// ============= state.js =============

/**
 * Admin Panel State Module
 * Централизованное хранилище состояния приложения
 */

var AdminState = {
    // Данные
    masters: [],
    services: { categories: [], podology: { services: [] } },
    articles: [],
    faq: [],
    social: { social: [], phone: '', email: '', address: '' },

    // UI состояние
    currentSection: 'stats',
    isLoading: false,
    editingItem: null,

    // Методы для работы с состоянием
    reset: function() {
        this.masters = [];
        this.services = { categories: [], podology: { services: [] } };
        this.articles = [];
        this.faq = [];
        this.social = { social: [], phone: '', email: '', address: '' };
        this.editingItem = null;
    },

    setMasters: function(data) {
        this.masters = data || [];
    },

    setServices: function(data) {
        this.services = data || { categories: [], podology: { services: [] } };
    },

    setArticles: function(data) {
        this.articles = data || [];
    },

    setFaq: function(data) {
        this.faq = data || [];
    },

    setSocial: function(data) {
        this.social = data || { social: [], phone: '', email: '', address: '' };
    },

    // Найти элемент по ID
    findMaster: function(id) {
        return this.masters.find(function(m) { return m.id === id; });
    },

    findArticle: function(id) {
        return this.articles.find(function(a) { return a.id === id; });
    },

    findFaq: function(id) {
        return this.faq.find(function(f) { return f.id === id; });
    },

    findSocialLink: function(id) {
        var links = this.social.social || [];
        return links.find(function(s) { return s.id === id; });
    }
};

// Экспорт
window.AdminState = AdminState;


// ============= toast.js =============

/**
 * Toast Notifications Module
 * Система уведомлений для админ-панели
 */

var AdminToast = (function() {
    'use strict';

    var container = null;

    /**
     * Инициализация контейнера
     */
    function init() {
        container = document.getElementById('toastContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container';
            document.body.appendChild(container);
        }
    }

    /**
     * Показать уведомление
     * @param {string} message - текст сообщения
     * @param {string} type - тип уведомления: 'success', 'error', 'warning', 'info'
     * @param {number} duration - длительность показа в мс (по умолчанию 3000)
     */
    function show(message, type, duration) {
        type = type || 'success';
        duration = duration || 3000;

        if (!container) init();

        var toast = document.createElement('div');
        toast.className = 'toast toast-' + type;

        var icon = getIcon(type);
        toast.innerHTML = '<span class="toast-icon">' + icon + '</span>' +
                          '<span class="toast-message">' + escapeHtml(message) + '</span>';

        container.appendChild(toast);

        // Анимация появления
        setTimeout(function() {
            toast.classList.add('show');
        }, 10);

        // Автоматическое скрытие
        setTimeout(function() {
            toast.classList.remove('show');
            setTimeout(function() {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, duration);

        return toast;
    }

    /**
     * Получить иконку для типа уведомления
     */
    function getIcon(type) {
        var icons = {
            success: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
            error: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
            warning: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
            info: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'
        };
        return icons[type] || icons.info;
    }

    /**
     * Escape HTML для безопасности
     */
    function escapeHtml(text) {
        if (typeof window.escapeHtml === 'function') {
            return window.escapeHtml(text);
        }
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Shorthand методы
    function success(message, duration) {
        return show(message, 'success', duration);
    }

    function error(message, duration) {
        return show(message, 'error', duration);
    }

    function warning(message, duration) {
        return show(message, 'warning', duration);
    }

    function info(message, duration) {
        return show(message, 'info', duration);
    }

    // Публичный API
    return {
        init: init,
        show: show,
        success: success,
        error: error,
        warning: warning,
        info: info
    };
})();

// Глобальная функция для совместимости
function showToast(message, type, duration) {
    return AdminToast.show(message, type, duration);
}

// Экспорт
window.AdminToast = AdminToast;
window.showToast = showToast;


// ============= api.js =============

/**
 * Admin API Module
 * Клиент для работы с серверным API
 */

var AdminAPI = (function() {
    'use strict';

    var AUTH_TOKEN_KEY = 'says_admin_token';

    // =================================================================
    // TOKEN MANAGEMENT
    // =================================================================

    function getToken() {
        return sessionStorage.getItem(AUTH_TOKEN_KEY);
    }

    function setToken(token) {
        if (token) {
            sessionStorage.setItem(AUTH_TOKEN_KEY, token);
        } else {
            sessionStorage.removeItem(AUTH_TOKEN_KEY);
        }
    }

    function getAuthHeaders() {
        var token = getToken();
        var headers = { 'Content-Type': 'application/json' };
        if (token) {
            headers['Authorization'] = 'Bearer ' + token;
        }
        return headers;
    }

    // =================================================================
    // HTTP METHODS
    // =================================================================

    /**
     * GET запрос
     */
    async function get(endpoint) {
        try {
            var response = await fetch('/api/' + endpoint);
            if (!response.ok) throw new Error('HTTP ' + response.status);
            return response.json();
        } catch (error) {
            console.error('API GET ' + endpoint + ' error:', error);
            return {};
        }
    }

    /**
     * POST запрос (требует авторизации)
     */
    async function save(endpoint, data) {
        try {
            var response = await fetch('/api/' + endpoint, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(data)
            });

            // Обработка unauthorized
            if (response.status === 401) {
                setToken(null);
                if (typeof showToast === 'function') {
                    showToast('Сессия истекла. Пожалуйста, войдите снова.', 'error');
                }
                location.reload();
                throw new Error('Unauthorized');
            }

            if (!response.ok) {
                var errorData = await response.json().catch(function() { return {}; });
                throw new Error(errorData.error || 'HTTP ' + response.status);
            }
            return response.json();
        } catch (error) {
            console.error('API POST ' + endpoint + ' error:', error);
            throw error;
        }
    }

    /**
     * Загрузка изображения (base64)
     */
    async function upload(imageData) {
        try {
            var response = await fetch('/api/upload', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ image: imageData })
            });

            if (response.status === 401) {
                setToken(null);
                if (typeof showToast === 'function') {
                    showToast('Сессия истекла. Пожалуйста, войдите снова.', 'error');
                }
                location.reload();
                throw new Error('Unauthorized');
            }

            if (!response.ok) {
                var errorData = await response.json().catch(function() { return {}; });
                throw new Error(errorData.error || 'HTTP ' + response.status);
            }
            return response.json();
        } catch (error) {
            console.error('Upload error:', error);
            throw error;
        }
    }

    /**
     * Удаление файла
     */
    async function deleteFile(filename) {
        try {
            var response = await fetch('/api/upload/' + filename, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                setToken(null);
                if (typeof showToast === 'function') {
                    showToast('Сессия истекла. Пожалуйста, войдите снова.', 'error');
                }
                location.reload();
                throw new Error('Unauthorized');
            }

            if (!response.ok) {
                var errorData = await response.json().catch(function() { return {}; });
                throw new Error(errorData.error || 'HTTP ' + response.status);
            }
            return response.json();
        } catch (error) {
            console.error('Delete file error:', error);
            throw error;
        }
    }

    // =================================================================
    // AUTHENTICATION
    // =================================================================

    /**
     * Вход в систему
     */
    async function login(password) {
        try {
            var response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: password })
            });

            var data = await response.json();

            if (response.status === 429) {
                throw new Error('Слишком много попыток. Попробуйте позже.');
            }

            if (!response.ok) {
                throw new Error(data.error || 'Неверный пароль');
            }

            return data;
        } catch (error) {
            console.error('Login error:', error);
            throw error;
        }
    }

    /**
     * Выход из системы
     */
    async function logout() {
        try {
            await fetch('/api/auth/logout', {
                method: 'POST',
                headers: getAuthHeaders()
            });
        } catch (error) {
            console.error('Logout error:', error);
        }
        setToken(null);
    }

    /**
     * Проверка авторизации
     */
    async function checkAuth() {
        try {
            var token = getToken();
            if (!token) return false;

            var response = await fetch('/api/auth/check', {
                method: 'POST',
                headers: getAuthHeaders()
            });

            var data = await response.json();
            return data.valid === true;
        } catch (error) {
            console.error('Auth check error:', error);
            return false;
        }
    }

    // =================================================================
    // DATA LOADING
    // =================================================================

    /**
     * Загрузка всех данных
     */
    async function loadAllData() {
        var results = await Promise.all([
            get('masters'),
            get('services'),
            get('articles'),
            get('faq'),
            get('social'),
            get('stats')
        ]);

        return {
            masters: results[0],
            services: results[1],
            articles: results[2],
            faq: results[3],
            social: results[4],
            stats: results[5]
        };
    }

    // Публичный API
    return {
        // Token management
        getToken: getToken,
        setToken: setToken,

        // HTTP methods
        get: get,
        save: save,
        upload: upload,
        deleteFile: deleteFile,

        // Auth
        login: login,
        logout: logout,
        checkAuth: checkAuth,

        // Data
        loadAllData: loadAllData
    };
})();

// Экспорт
window.AdminAPI = AdminAPI;


// ============= auth.js =============

/**
 * Admin Authentication Module
 * Управление входом и выходом из админ-панели
 */

var AdminAuth = (function() {
    'use strict';

    /**
     * Показать админ-панель
     */
    function showAdminPanel() {
        document.body.classList.add('authenticated');
    }

    /**
     * Скрыть админ-панель
     */
    function hideAdminPanel() {
        document.body.classList.remove('authenticated');
    }

    /**
     * Инициализация формы входа
     */
    function initLoginForm(onSuccess) {
        var loginForm = document.getElementById('loginForm');
        var loginError = document.getElementById('loginError');
        var passwordInput = document.getElementById('password');
        var togglePassword = document.getElementById('togglePassword');

        if (!loginForm) return;

        // Toggle password visibility
        if (togglePassword) {
            togglePassword.addEventListener('click', function() {
                var type = passwordInput.type === 'password' ? 'text' : 'password';
                passwordInput.type = type;

                var eyeIcon = togglePassword.querySelector('.eye-icon');
                var eyeOffIcon = togglePassword.querySelector('.eye-off-icon');

                if (type === 'text') {
                    eyeIcon.style.display = 'none';
                    eyeOffIcon.style.display = 'block';
                } else {
                    eyeIcon.style.display = 'block';
                    eyeOffIcon.style.display = 'none';
                }
            });
        }

        // Handle login form submit
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            var password = passwordInput.value;
            var submitBtn = loginForm.querySelector('button[type="submit"]');

            // Disable button during request
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Вход...';
            }

            try {
                var result = await AdminAPI.login(password);

                if (result.success && result.token) {
                    AdminAPI.setToken(result.token);
                    showAdminPanel();
                    loginError.classList.remove('visible');
                    loginError.textContent = '';

                    // Callback for successful login
                    if (typeof onSuccess === 'function') {
                        onSuccess();
                    }
                }
            } catch (error) {
                loginError.textContent = error.message || 'Неверный пароль';
                loginError.classList.add('visible');
                passwordInput.value = '';
                passwordInput.focus();

                // Shake animation
                var loginCard = loginForm.closest('.login-card');
                if (loginCard) {
                    loginCard.style.animation = 'none';
                    loginCard.offsetHeight; // Trigger reflow
                    loginCard.style.animation = 'shake 0.5s ease';
                }
            } finally {
                // Re-enable button
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Войти';
                }
            }
        });

        // Enter key handler
        passwordInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                loginForm.dispatchEvent(new Event('submit'));
            }
        });
    }

    /**
     * Инициализация кнопки выхода
     */
    function initLogoutButton() {
        var logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async function() {
                if (confirm('Вы уверены, что хотите выйти?')) {
                    await AdminAPI.logout();
                    hideAdminPanel();
                    location.reload();
                }
            });
        }
    }

    /**
     * Проверка авторизации и инициализация
     */
    async function init(onAuthenticated, onNotAuthenticated) {
        var isAuthenticated = await AdminAPI.checkAuth();

        if (isAuthenticated) {
            showAdminPanel();
            if (typeof onAuthenticated === 'function') {
                onAuthenticated();
            }
        } else {
            AdminAPI.setToken(null);
            if (typeof onNotAuthenticated === 'function') {
                onNotAuthenticated();
            }
        }
    }

    // Публичный API
    return {
        init: init,
        showAdminPanel: showAdminPanel,
        hideAdminPanel: hideAdminPanel,
        initLoginForm: initLoginForm,
        initLogoutButton: initLogoutButton
    };
})();

// Экспорт
window.AdminAuth = AdminAuth;


// ============= navigation.js =============

/**
 * Admin Navigation Module
 * Управление навигацией между секциями админ-панели
 */

var AdminNavigation = (function() {
    'use strict';

    var currentSection = 'stats';
    var sectionTitles = {
        'stats': 'Статистика',
        'masters': 'Мастера',
        'services': 'Услуги',
        'articles': 'Статьи',
        'principles': 'Принципы',
        'faq': 'FAQ',
        'social': 'Соцсети'
    };

    /**
     * Переключение на секцию
     */
    function switchSection(sectionId) {
        // Скрыть все секции
        var sections = document.querySelectorAll('.admin-section');
        sections.forEach(function(section) {
            section.classList.remove('active');
        });

        // Показать выбранную секцию
        var targetSection = document.getElementById(sectionId + '-section');
        if (targetSection) {
            targetSection.classList.add('active');
        }

        // Обновить активный пункт меню
        var navItems = document.querySelectorAll('.sidebar-nav a');
        navItems.forEach(function(item) {
            item.classList.remove('active');
            if (item.getAttribute('data-section') === sectionId) {
                item.classList.add('active');
            }
        });

        // Обновить заголовок
        var pageTitle = document.getElementById('pageTitle');
        if (pageTitle) {
            pageTitle.textContent = sectionTitles[sectionId] || sectionId;
        }

        currentSection = sectionId;

        // Обновить состояние
        if (window.AdminState) {
            window.AdminState.currentSection = sectionId;
        }
    }

    /**
     * Получить текущую секцию
     */
    function getCurrentSection() {
        return currentSection;
    }

    /**
     * Инициализация навигации
     */
    function init() {
        var navItems = document.querySelectorAll('.sidebar-nav a[data-section]');
        navItems.forEach(function(item) {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                var sectionId = this.getAttribute('data-section');
                if (sectionId) {
                    switchSection(sectionId);
                }
            });
        });
    }

    // Публичный API
    return {
        init: init,
        switchSection: switchSection,
        getCurrentSection: getCurrentSection,
        sectionTitles: sectionTitles
    };
})();

// Экспорт
window.AdminNavigation = AdminNavigation;


// ============= modals.js =============

/**
 * Admin Modals Module
 * Управление модальными окнами
 */

var AdminModals = (function() {
    'use strict';

    var currentModal = null;

    /**
     * Открыть модальное окно
     */
    function open(modalId) {
        var modal = document.getElementById(modalId);
        if (!modal) {
            console.error('Modal not found:', modalId);
            return;
        }

        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        currentModal = modal;

        // Обработчик закрытия по Escape
        document.addEventListener('keydown', handleEscape);

        // Обработчик закрытия по клику на оверлей
        modal.addEventListener('click', handleOverlayClick);
    }

    /**
     * Закрыть модальное окно
     */
    function close(modalId) {
        var modal = modalId ? document.getElementById(modalId) : currentModal;
        if (!modal) return;

        modal.classList.remove('active');
        document.body.style.overflow = '';

        // Удаляем обработчики
        document.removeEventListener('keydown', handleEscape);
        modal.removeEventListener('click', handleOverlayClick);

        currentModal = null;

        // Сброс формы если есть
        var form = modal.querySelector('form');
        if (form) {
            form.reset();
        }
    }

    /**
     * Закрыть текущее модальное окно
     */
    function closeCurrent() {
        if (currentModal) {
            close();
        }
    }

    /**
     * Обработчик нажатия Escape
     */
    function handleEscape(e) {
        if (e.key === 'Escape') {
            closeCurrent();
        }
    }

    /**
     * Обработчик клика по оверлею
     */
    function handleOverlayClick(e) {
        if (e.target.classList.contains('modal') || e.target.classList.contains('modal-overlay')) {
            closeCurrent();
        }
    }

    /**
     * Установить заголовок модального окна
     */
    function setTitle(modalId, title) {
        var modal = document.getElementById(modalId);
        if (!modal) return;

        var titleEl = modal.querySelector('.modal-title');
        if (titleEl) {
            titleEl.textContent = title;
        }
    }

    /**
     * Инициализация кнопок закрытия
     */
    function init() {
        // Инициализация кнопок закрытия
        var closeButtons = document.querySelectorAll('.modal-close, [data-modal-close]');
        closeButtons.forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                closeCurrent();
            });
        });

        // Инициализация кнопок открытия
        var openButtons = document.querySelectorAll('[data-modal-open]');
        openButtons.forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                var modalId = this.getAttribute('data-modal-open');
                if (modalId) {
                    open(modalId);
                }
            });
        });
    }

    // Публичный API
    return {
        init: init,
        open: open,
        close: close,
        closeCurrent: closeCurrent,
        setTitle: setTitle
    };
})();

// Глобальные функции для совместимости
function openModal(modalId) {
    AdminModals.open(modalId);
}

function closeModal(modalId) {
    AdminModals.close(modalId);
}

// Экспорт
window.AdminModals = AdminModals;
window.openModal = openModal;
window.closeModal = closeModal;


// ============= image-upload.js =============

/**
 * Admin Image Upload Module
 * Загрузка и обработка изображений
 */

var AdminImageUpload = (function() {
    'use strict';

    var MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
    var ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];

    /**
     * Валидация файла
     */
    function validateFile(file) {
        if (!file) {
            return { valid: false, error: 'Файл не выбран' };
        }

        if (!ALLOWED_TYPES.includes(file.type)) {
            return { valid: false, error: 'Недопустимый формат. Разрешены: JPG, PNG, GIF, WebP' };
        }

        if (file.size > MAX_FILE_SIZE) {
            return { valid: false, error: 'Файл слишком большой. Максимум 10MB' };
        }

        return { valid: true };
    }

    /**
     * Преобразовать файл в base64
     */
    function fileToBase64(file) {
        return new Promise(function(resolve, reject) {
            var reader = new FileReader();
            reader.onload = function() {
                resolve(reader.result);
            };
            reader.onerror = function() {
                reject(new Error('Ошибка чтения файла'));
            };
            reader.readAsDataURL(file);
        });
    }

    /**
     * Загрузить файл на сервер
     */
    async function uploadFile(file) {
        // Валидация
        var validation = validateFile(file);
        if (!validation.valid) {
            throw new Error(validation.error);
        }

        // Преобразование в base64
        var base64 = await fileToBase64(file);

        // Загрузка на сервер
        var result = await AdminAPI.upload(base64);

        if (result.success) {
            return result;
        } else {
            throw new Error(result.error || 'Ошибка загрузки');
        }
    }

    /**
     * Удалить файл с сервера
     */
    async function deleteFile(url) {
        if (!url) return;

        // Извлекаем имя файла из URL
        var filename = url.split('/').pop();
        if (!filename) return;

        try {
            await AdminAPI.deleteFile(filename);
        } catch (error) {
            console.error('Error deleting file:', error);
        }
    }

    /**
     * Инициализация поля загрузки изображения
     */
    function initUploadField(inputId, previewId, options) {
        options = options || {};
        var input = document.getElementById(inputId);
        var preview = document.getElementById(previewId);

        if (!input) return;

        input.addEventListener('change', async function(e) {
            var file = e.target.files[0];
            if (!file) return;

            // Валидация
            var validation = validateFile(file);
            if (!validation.valid) {
                if (typeof showToast === 'function') {
                    showToast(validation.error, 'error');
                }
                input.value = '';
                return;
            }

            // Показать превью локально
            if (preview) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    if (preview.tagName === 'IMG') {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    } else {
                        preview.style.backgroundImage = 'url(' + e.target.result + ')';
                    }
                };
                reader.readAsDataURL(file);
            }

            // Callback
            if (typeof options.onChange === 'function') {
                options.onChange(file);
            }
        });
    }

    /**
     * Создать кнопку удаления для изображения
     */
    function createRemoveButton(container, onRemove) {
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-icon danger image-remove-btn';
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
        btn.title = 'Удалить изображение';

        btn.addEventListener('click', function(e) {
            e.preventDefault();
            if (typeof onRemove === 'function') {
                onRemove();
            }
        });

        container.appendChild(btn);
        return btn;
    }

    // Публичный API
    return {
        validateFile: validateFile,
        fileToBase64: fileToBase64,
        uploadFile: uploadFile,
        deleteFile: deleteFile,
        initUploadField: initUploadField,
        createRemoveButton: createRemoveButton,
        MAX_FILE_SIZE: MAX_FILE_SIZE,
        ALLOWED_TYPES: ALLOWED_TYPES
    };
})();

// Экспорт
window.AdminImageUpload = AdminImageUpload;


// ============= wysiwyg.js =============

/**
 * Admin WYSIWYG Editor Module
 * Современный редактор для статей с использованием Selection API
 * Заменяет deprecated document.execCommand на Selection/Range API
 */

var AdminWYSIWYG = (function() {
    'use strict';

    var editor = null;
    var toolbar = null;

    // =================================================================
    // SELECTION HELPERS
    // =================================================================

    /**
     * Получить текущее выделение
     */
    function getSelection() {
        return window.getSelection();
    }

    /**
     * Сохранить текущее выделение
     */
    function saveSelection() {
        var sel = getSelection();
        if (sel.rangeCount > 0) {
            return sel.getRangeAt(0).cloneRange();
        }
        return null;
    }

    /**
     * Восстановить выделение
     */
    function restoreSelection(range) {
        if (range) {
            var sel = getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }
    }

    /**
     * Проверить, находится ли выделение внутри редактора
     */
    function isSelectionInEditor() {
        if (!editor) return false;
        var sel = getSelection();
        if (!sel.rangeCount) return false;

        var range = sel.getRangeAt(0);
        return editor.contains(range.commonAncestorContainer);
    }

    // =================================================================
    // FORMATTING WITH SELECTION API
    // =================================================================

    /**
     * Обернуть выделенный текст в тег
     */
    function wrapSelection(tagName, attributes) {
        var sel = getSelection();
        if (!sel.rangeCount || !isSelectionInEditor()) return false;

        var range = sel.getRangeAt(0);

        // Если ничего не выделено, не делаем ничего
        if (range.collapsed) return false;

        // Создаём элемент-обёртку
        var wrapper = document.createElement(tagName);
        if (attributes) {
            for (var attr in attributes) {
                if (attributes.hasOwnProperty(attr)) {
                    wrapper.setAttribute(attr, attributes[attr]);
                }
            }
        }

        try {
            // Извлекаем содержимое и оборачиваем
            var content = range.extractContents();
            wrapper.appendChild(content);
            range.insertNode(wrapper);

            // Выделяем вставленный элемент
            range.selectNodeContents(wrapper);
            sel.removeAllRanges();
            sel.addRange(range);

            return true;
        } catch (e) {
            console.warn('wrapSelection failed:', e);
            return false;
        }
    }

    /**
     * Удалить форматирование с тегом
     */
    function unwrapSelection(tagName) {
        var sel = getSelection();
        if (!sel.rangeCount || !isSelectionInEditor()) return false;

        var range = sel.getRangeAt(0);
        var container = range.commonAncestorContainer;

        // Находим родительский элемент с нужным тегом
        var parent = container.nodeType === Node.TEXT_NODE ? container.parentNode : container;

        while (parent && parent !== editor) {
            if (parent.tagName && parent.tagName.toLowerCase() === tagName.toLowerCase()) {
                // Разворачиваем элемент
                var fragment = document.createDocumentFragment();
                while (parent.firstChild) {
                    fragment.appendChild(parent.firstChild);
                }
                parent.parentNode.replaceChild(fragment, parent);
                return true;
            }
            parent = parent.parentNode;
        }

        return false;
    }

    /**
     * Проверить, применён ли стиль к выделению
     */
    function isFormatApplied(tagName) {
        var sel = getSelection();
        if (!sel.rangeCount) return false;

        var container = sel.getRangeAt(0).commonAncestorContainer;
        var parent = container.nodeType === Node.TEXT_NODE ? container.parentNode : container;

        while (parent && parent !== editor) {
            if (parent.tagName && parent.tagName.toLowerCase() === tagName.toLowerCase()) {
                return true;
            }
            parent = parent.parentNode;
        }

        return false;
    }

    /**
     * Переключить форматирование (toggle)
     */
    function toggleFormat(tagName, attributes) {
        if (isFormatApplied(tagName)) {
            unwrapSelection(tagName);
        } else {
            wrapSelection(tagName, attributes);
        }
    }

    // =================================================================
    // BLOCK FORMATTING
    // =================================================================

    /**
     * Применить блочное форматирование
     */
    function formatBlock(tagName) {
        var sel = getSelection();
        if (!sel.rangeCount || !isSelectionInEditor()) return;

        var range = sel.getRangeAt(0);
        var container = range.commonAncestorContainer;

        // Находим блочный родительский элемент
        var blockParent = container.nodeType === Node.TEXT_NODE ? container.parentNode : container;

        while (blockParent && blockParent !== editor) {
            var display = window.getComputedStyle(blockParent).display;
            if (display === 'block' || display === 'list-item') {
                break;
            }
            blockParent = blockParent.parentNode;
        }

        if (blockParent && blockParent !== editor) {
            // Создаём новый блочный элемент
            var newBlock = document.createElement(tagName);
            newBlock.innerHTML = blockParent.innerHTML;
            blockParent.parentNode.replaceChild(newBlock, blockParent);

            // Восстанавливаем курсор
            range.selectNodeContents(newBlock);
            range.collapse(false);
            sel.removeAllRanges();
            sel.addRange(range);
        }
    }

    // =================================================================
    // LIST FORMATTING
    // =================================================================

    /**
     * Создать или удалить список
     */
    function toggleList(listType) {
        var sel = getSelection();
        if (!sel.rangeCount || !isSelectionInEditor()) return;

        var range = sel.getRangeAt(0);
        var container = range.commonAncestorContainer;

        // Проверяем, находимся ли уже в списке
        var listParent = container;
        while (listParent && listParent !== editor) {
            if (listParent.tagName === 'UL' || listParent.tagName === 'OL') {
                // Удаляем список
                unwrapList(listParent);
                return;
            }
            listParent = listParent.parentNode;
        }

        // Создаём новый список
        createList(listType);
    }

    /**
     * Создать список из выделенного текста
     */
    function createList(listType) {
        var sel = getSelection();
        if (!sel.rangeCount) return;

        var range = sel.getRangeAt(0);
        var content = range.extractContents();

        // Создаём список
        var list = document.createElement(listType);
        var li = document.createElement('li');

        // Если есть текст, добавляем его
        if (content.textContent.trim()) {
            // Разбиваем по строкам
            var text = content.textContent;
            var lines = text.split('\n').filter(function(line) {
                return line.trim();
            });

            if (lines.length > 1) {
                lines.forEach(function(line) {
                    var item = document.createElement('li');
                    item.textContent = line.trim();
                    list.appendChild(item);
                });
            } else {
                li.appendChild(content);
                list.appendChild(li);
            }
        } else {
            li.innerHTML = '<br>';
            list.appendChild(li);
        }

        range.insertNode(list);

        // Ставим курсор в первый элемент
        var firstLi = list.querySelector('li');
        if (firstLi) {
            range.selectNodeContents(firstLi);
            range.collapse(false);
            sel.removeAllRanges();
            sel.addRange(range);
        }
    }

    /**
     * Удалить список
     */
    function unwrapList(listElement) {
        var fragment = document.createDocumentFragment();
        var items = listElement.querySelectorAll('li');

        items.forEach(function(li, index) {
            var p = document.createElement('p');
            p.innerHTML = li.innerHTML;
            fragment.appendChild(p);
        });

        listElement.parentNode.replaceChild(fragment, listElement);
    }

    // =================================================================
    // LINK HANDLING
    // =================================================================

    /**
     * Вставить ссылку
     */
    function insertLink() {
        var url = prompt('Введите URL ссылки:', 'https://');
        if (!url) return;

        var sel = getSelection();
        if (!sel.rangeCount || !isSelectionInEditor()) return;

        var range = sel.getRangeAt(0);

        if (range.collapsed) {
            // Нет выделения - создаём ссылку с URL как текстом
            var link = document.createElement('a');
            link.href = url;
            link.textContent = url;
            range.insertNode(link);
        } else {
            // Оборачиваем выделенный текст
            wrapSelection('a', { href: url });
        }
    }

    /**
     * Удалить ссылку
     */
    function removeLink() {
        unwrapSelection('a');
    }

    // =================================================================
    // MAIN FORMAT FUNCTION
    // =================================================================

    /**
     * Форматирование выделенного текста
     * Заменяет deprecated document.execCommand
     */
    function formatText(command, value) {
        if (!editor) return;

        // Фокусируем редактор
        editor.focus();

        switch (command) {
            // Инлайн форматирование
            case 'bold':
                toggleFormat('strong');
                break;
            case 'italic':
                toggleFormat('em');
                break;
            case 'underline':
                toggleFormat('u');
                break;
            case 'strikeThrough':
                toggleFormat('s');
                break;

            // Блочное форматирование
            case 'h2':
            case 'formatBlock':
                formatBlock(value || 'h2');
                break;
            case 'h3':
                formatBlock('h3');
                break;
            case 'quote':
                formatBlock('blockquote');
                break;

            // Списки
            case 'ul':
            case 'insertUnorderedList':
                toggleList('ul');
                break;
            case 'ol':
            case 'insertOrderedList':
                toggleList('ol');
                break;

            // Ссылки
            case 'link':
            case 'createLink':
                insertLink();
                break;
            case 'unlink':
                removeLink();
                break;

            // Очистка форматирования
            case 'removeFormat':
                removeAllFormatting();
                break;

            // Fallback на execCommand для неподдерживаемых команд
            default:
                try {
                    document.execCommand(command, false, value || null);
                } catch (e) {
                    console.warn('Unsupported command:', command);
                }
        }

        // Обновляем состояние тулбара
        updateToolbarState();
    }

    /**
     * Удалить всё форматирование
     */
    function removeAllFormatting() {
        var sel = getSelection();
        if (!sel.rangeCount || !isSelectionInEditor()) return;

        var range = sel.getRangeAt(0);
        var text = range.toString();

        if (text) {
            range.deleteContents();
            var textNode = document.createTextNode(text);
            range.insertNode(textNode);

            range.selectNodeContents(textNode);
            sel.removeAllRanges();
            sel.addRange(range);
        }
    }

    /**
     * Обновить состояние кнопок тулбара
     */
    function updateToolbarState() {
        if (!toolbar) return;

        var buttons = toolbar.querySelectorAll('.toolbar-btn');
        buttons.forEach(function(btn) {
            btn.classList.remove('active');
        });

        // Проверяем активные стили
        if (isFormatApplied('strong') || isFormatApplied('b')) {
            var boldBtn = toolbar.querySelector('[data-command="bold"]');
            if (boldBtn) boldBtn.classList.add('active');
        }
        if (isFormatApplied('em') || isFormatApplied('i')) {
            var italicBtn = toolbar.querySelector('[data-command="italic"]');
            if (italicBtn) italicBtn.classList.add('active');
        }
        if (isFormatApplied('u')) {
            var underlineBtn = toolbar.querySelector('[data-command="underline"]');
            if (underlineBtn) underlineBtn.classList.add('active');
        }
    }

    // =================================================================
    // INITIALIZATION
    // =================================================================

    /**
     * Инициализация редактора
     */
    function init(editorId, toolbarId) {
        editor = typeof editorId === 'string' ? document.getElementById(editorId) : editorId;
        toolbar = typeof toolbarId === 'string' ? document.getElementById(toolbarId) : toolbarId;

        if (!editor) {
            console.error('WYSIWYG editor not found:', editorId);
            return;
        }

        // Делаем редактор редактируемым
        editor.setAttribute('contenteditable', 'true');

        // Инициализация кнопок тулбара
        if (toolbar) {
            initToolbar();
        }

        // Обработчики событий
        editor.addEventListener('paste', handlePaste);
        editor.addEventListener('keyup', updateToolbarState);
        editor.addEventListener('mouseup', updateToolbarState);
    }

    /**
     * Инициализация тулбара
     */
    function initToolbar() {
        var buttons = toolbar.querySelectorAll('[data-command]');
        buttons.forEach(function(btn) {
            btn.addEventListener('mousedown', function(e) {
                e.preventDefault(); // Предотвращаем потерю фокуса
            });

            btn.addEventListener('click', function(e) {
                e.preventDefault();
                var command = this.getAttribute('data-command');
                var value = this.getAttribute('data-value');

                formatText(command, value);

                // Фокус обратно на редактор
                editor.focus();
            });
        });
    }

    /**
     * Обработка вставки - очистка форматирования
     */
    function handlePaste(e) {
        e.preventDefault();

        var text = '';
        if (e.clipboardData || window.clipboardData) {
            // Пытаемся получить HTML
            var html = (e.clipboardData || window.clipboardData).getData('text/html');
            if (html && typeof DOMPurify !== 'undefined') {
                // Очищаем HTML через DOMPurify
                text = DOMPurify.sanitize(html, {
                    ALLOWED_TAGS: ['p', 'br', 'strong', 'b', 'em', 'i', 'u', 'a', 'ul', 'ol', 'li', 'h2', 'h3', 'blockquote'],
                    ALLOWED_ATTR: ['href']
                });
            } else {
                // Fallback - только текст
                text = (e.clipboardData || window.clipboardData).getData('text/plain');
                // Заменяем переносы строк на <br>
                text = text.replace(/\n/g, '<br>');
            }
        }

        // Вставляем очищенный контент
        var sel = getSelection();
        if (sel.rangeCount) {
            var range = sel.getRangeAt(0);
            range.deleteContents();

            var fragment = document.createRange().createContextualFragment(text);
            range.insertNode(fragment);

            // Перемещаем курсор в конец
            range.collapse(false);
            sel.removeAllRanges();
            sel.addRange(range);
        }
    }

    /**
     * Получить HTML контент редактора
     */
    function getContent() {
        if (!editor) return '';

        var content = editor.innerHTML;

        // Очищаем через DOMPurify если доступен
        if (typeof DOMPurify !== 'undefined') {
            content = DOMPurify.sanitize(content);
        }

        return content;
    }

    /**
     * Установить HTML контент редактора
     */
    function setContent(html) {
        if (!editor) return;

        // Очищаем через DOMPurify если доступен
        if (typeof DOMPurify !== 'undefined') {
            html = DOMPurify.sanitize(html);
        }

        editor.innerHTML = html || '';
    }

    /**
     * Очистить редактор
     */
    function clear() {
        if (editor) {
            editor.innerHTML = '';
        }
    }

    /**
     * Получить текущий редактор
     */
    function getEditor() {
        return editor;
    }

    // Публичный API
    return {
        init: init,
        formatText: formatText,
        insertLink: insertLink,
        removeLink: removeLink,
        getContent: getContent,
        setContent: setContent,
        clear: clear,
        getEditor: getEditor,
        updateToolbarState: updateToolbarState,
        // Для тестирования
        isFormatApplied: isFormatApplied,
        saveSelection: saveSelection,
        restoreSelection: restoreSelection
    };
})();

// Экспорт
window.AdminWYSIWYG = AdminWYSIWYG;


// ============= renderers/stats.js =============

/**
 * Admin Stats Renderer
 * Рендеринг статистики посещений
 */

var AdminStatsRenderer = (function() {
    'use strict';

    var elements = {};

    /**
     * Инициализация элементов
     */
    function init() {
        elements = {
            totalViews: document.getElementById('totalViews'),
            todayViews: document.getElementById('todayViews'),
            weekViews: document.getElementById('weekViews'),
            monthViews: document.getElementById('monthViews'),
            uniqueVisitors: document.getElementById('uniqueVisitors'),
            topSections: document.getElementById('topSections'),
            chartCanvas: document.getElementById('statsChart')
        };
    }

    /**
     * Рендеринг статистики
     */
    function render(stats) {
        if (!stats) return;

        // Основные метрики
        if (elements.totalViews) {
            elements.totalViews.textContent = formatNumber(stats.total_views || 0);
        }
        if (elements.todayViews) {
            elements.todayViews.textContent = formatNumber(stats.today_views || 0);
        }
        if (elements.weekViews) {
            elements.weekViews.textContent = formatNumber(stats.week_views || 0);
        }
        if (elements.monthViews) {
            elements.monthViews.textContent = formatNumber(stats.month_views || 0);
        }
        if (elements.uniqueVisitors) {
            elements.uniqueVisitors.textContent = formatNumber(stats.unique_visitors || 0);
        }

        // Топ секций
        if (elements.topSections && stats.sections) {
            renderTopSections(stats.sections);
        }

        // График
        if (elements.chartCanvas && stats.chart_data) {
            renderChart(stats.chart_data);
        }
    }

    /**
     * Рендеринг топ секций
     */
    function renderTopSections(sections) {
        var sectionNames = {
            'hero': 'Главная',
            'services': 'Услуги',
            'masters': 'Мастера',
            'quality': 'Качество',
            'blog': 'Блог',
            'faq': 'FAQ',
            'booking': 'Запись',
            'podology': 'Подология',
            'location': 'Контакты'
        };

        // Сортировка по просмотрам
        var sortedSections = Object.entries(sections)
            .sort(function(a, b) { return b[1] - a[1]; })
            .slice(0, 5);

        if (sortedSections.length === 0) {
            elements.topSections.innerHTML = '<p class="empty-message">Нет данных о просмотрах секций</p>';
            return;
        }

        var maxViews = sortedSections[0][1];

        var html = sortedSections.map(function(item) {
            var key = item[0];
            var views = item[1];
            var name = sectionNames[key] || key;
            var percent = maxViews > 0 ? Math.round((views / maxViews) * 100) : 0;

            return '<div class="section-stat-item">' +
                '<div class="section-stat-info">' +
                    '<span class="section-name">' + escapeHtml(name) + '</span>' +
                    '<span class="section-views">' + formatNumber(views) + '</span>' +
                '</div>' +
                '<div class="section-stat-bar">' +
                    '<div class="section-stat-fill" style="width: ' + percent + '%"></div>' +
                '</div>' +
            '</div>';
        }).join('');

        elements.topSections.innerHTML = html;
    }

    /**
     * Рендеринг графика (простая реализация без библиотек)
     */
    function renderChart(chartData) {
        var canvas = elements.chartCanvas;
        if (!canvas || !canvas.getContext) return;

        var ctx = canvas.getContext('2d');
        var width = canvas.width;
        var height = canvas.height;
        var padding = 40;

        // Очистка
        ctx.clearRect(0, 0, width, height);

        if (!chartData || chartData.length === 0) return;

        // Находим максимальное значение
        var maxViews = Math.max.apply(null, chartData.map(function(d) { return d.views; }));
        if (maxViews === 0) maxViews = 1;

        var chartWidth = width - padding * 2;
        var chartHeight = height - padding * 2;
        var barWidth = chartWidth / chartData.length;

        // Рисуем бары
        ctx.fillStyle = '#00ff88';

        chartData.forEach(function(data, index) {
            var barHeight = (data.views / maxViews) * chartHeight;
            var x = padding + index * barWidth + barWidth * 0.1;
            var y = height - padding - barHeight;
            var w = barWidth * 0.8;

            ctx.fillRect(x, y, w, barHeight);
        });

        // Подписи дат
        ctx.fillStyle = '#a0a0a0';
        ctx.font = '10px Manrope';
        ctx.textAlign = 'center';

        chartData.forEach(function(data, index) {
            if (index % 2 === 0) { // Каждая вторая дата
                var x = padding + index * barWidth + barWidth / 2;
                var date = new Date(data.date);
                var label = date.getDate() + '.' + (date.getMonth() + 1);
                ctx.fillText(label, x, height - 10);
            }
        });
    }

    /**
     * Форматирование числа
     */
    function formatNumber(num) {
        if (num >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
        }
        if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }
        return String(num);
    }

    /**
     * Escape HTML
     */
    function escapeHtml(text) {
        if (typeof window.escapeHtml === 'function') {
            return window.escapeHtml(text);
        }
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Публичный API
    return {
        init: init,
        render: render
    };
})();

// Экспорт
window.AdminStatsRenderer = AdminStatsRenderer;


// ============= renderers/masters.js =============

/**
 * Admin Masters Renderer
 * Рендеринг списка мастеров
 */

var AdminMastersRenderer = (function() {
    'use strict';

    var container = null;

    /**
     * Инициализация
     */
    function init() {
        container = document.getElementById('mastersGrid');
    }

    /**
     * Получить название уровня мастера
     */
    function getBadgeLabel(badge) {
        var labels = {
            'green': 'Green',
            'pink': 'Pink',
            'blue': 'Dark Blue'
        };
        return labels[badge] || 'Green';
    }

    /**
     * Рендеринг списка мастеров
     */
    function render() {
        if (!container) {
            container = document.getElementById('mastersGrid');
            if (!container) return;
        }

        var masters = AdminState.masters || [];

        if (masters.length === 0) {
            container.innerHTML = '<p class="empty-message">Нет мастеров. Нажмите "Добавить" чтобы создать.</p>';
            return;
        }

        var html = masters.map(function(master) {
            var photoHtml = master.photo
                ? '<img src="' + master.photo + '" alt="' + escapeHtml(master.name) + '">'
                : (master.initial || master.name.charAt(0));

            return '<div class="master-card" data-id="' + master.id + '">' +
                '<div class="master-card-header">' +
                    '<div class="master-avatar ' + (master.photo ? 'has-photo' : '') + '">' +
                        photoHtml +
                    '</div>' +
                    '<div class="master-info">' +
                        '<h3 class="master-name">' + escapeHtml(master.name) + '</h3>' +
                        '<div class="master-role">' + escapeHtml(master.role || 'Мастер') + '</div>' +
                        '<span class="master-badge badge-' + (master.badge || 'green') + '">' + getBadgeLabel(master.badge) + '</span>' +
                    '</div>' +
                '</div>' +
                '<p class="master-specialization">' + escapeHtml(master.specialization || '') + '</p>' +
                '<div class="master-card-actions">' +
                    '<button class="btn btn-secondary" data-action="edit-master" data-id="' + master.id + '">' +
                        SharedIcons.get('edit') +
                        'Редактировать' +
                    '</button>' +
                    '<button class="btn btn-icon danger" data-action="delete-master" data-id="' + master.id + '" title="Удалить">' +
                        SharedIcons.get('delete') +
                    '</button>' +
                '</div>' +
            '</div>';
        }).join('');

        container.innerHTML = html;
    }

    /**
     * Escape HTML
     */
    function escapeHtml(text) {
        if (!text) return '';
        if (typeof window.escapeHtml === 'function') {
            return window.escapeHtml(text);
        }
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Публичный API
    return {
        init: init,
        render: render,
        getBadgeLabel: getBadgeLabel
    };
})();

// Экспорт
window.AdminMastersRenderer = AdminMastersRenderer;


// ============= renderers/services.js =============

/**
 * Admin Services Renderer
 * Рендеринг списка услуг
 */

var AdminServicesRenderer = (function() {
    'use strict';

    var servicesList = null;
    var podologyList = null;

    /**
     * Инициализация
     */
    function init() {
        servicesList = document.getElementById('servicesList');
        podologyList = document.getElementById('podologyList');
    }

    /**
     * Рендеринг услуг категории
     */
    function render() {
        if (!servicesList) {
            servicesList = document.getElementById('servicesList');
            if (!servicesList) return;
        }

        var currentCategory = AdminState.currentCategory || 'main';
        var services = AdminState.services || {};
        var category = null;

        if (services.categories) {
            category = services.categories.find(function(c) {
                return c.id === currentCategory;
            });
        }

        if (!category || !category.services || category.services.length === 0) {
            servicesList.innerHTML = '<p class="empty-message">Нет услуг в этой категории</p>';
            return;
        }

        var html = category.services.map(function(service, index) {
            return '<div class="service-item" data-id="' + service.id + '">' +
                '<span class="service-name">' + escapeHtml(service.name) + '</span>' +
                '<div class="service-prices">' +
                    '<span class="price-tag price-green">' + (service.priceGreen || 0) + ' ₽</span>' +
                    '<span class="price-tag price-pink">' + (service.pricePink || 0) + ' ₽</span>' +
                    '<span class="price-tag price-blue">' + (service.priceBlue || 0) + ' ₽</span>' +
                '</div>' +
                '<div class="service-actions">' +
                    '<button class="btn btn-icon" data-action="edit-service" data-category="' + currentCategory + '" data-index="' + index + '" title="Редактировать">' +
                        SharedIcons.get('edit') +
                    '</button>' +
                    '<button class="btn btn-icon danger" data-action="delete-service" data-category="' + currentCategory + '" data-index="' + index + '" title="Удалить">' +
                        SharedIcons.get('delete') +
                    '</button>' +
                '</div>' +
            '</div>';
        }).join('');

        servicesList.innerHTML = html;
    }

    /**
     * Рендеринг услуг подологии
     */
    function renderPodology() {
        if (!podologyList) {
            podologyList = document.getElementById('podologyList');
            if (!podologyList) return;
        }

        var services = AdminState.services || {};
        var podologyServices = (services.podology && services.podology.services) || [];

        if (podologyServices.length === 0) {
            podologyList.innerHTML = '<p class="empty-message">Нет услуг подологии</p>';
            return;
        }

        var html = podologyServices.map(function(service, index) {
            return '<div class="service-item" data-id="' + service.id + '">' +
                '<span class="service-name">' + escapeHtml(service.name) + '</span>' +
                '<div class="service-prices">' +
                    '<span class="price-tag price-single">' + escapeHtml(service.price) + '</span>' +
                '</div>' +
                '<div class="service-actions">' +
                    '<button class="btn btn-icon" data-action="edit-podology" data-index="' + index + '" title="Редактировать">' +
                        SharedIcons.get('edit') +
                    '</button>' +
                    '<button class="btn btn-icon danger" data-action="delete-podology" data-index="' + index + '" title="Удалить">' +
                        SharedIcons.get('delete') +
                    '</button>' +
                '</div>' +
            '</div>';
        }).join('');

        podologyList.innerHTML = html;
    }

    /**
     * Escape HTML
     */
    function escapeHtml(text) {
        if (!text) return '';
        if (typeof window.escapeHtml === 'function') {
            return window.escapeHtml(text);
        }
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Публичный API
    return {
        init: init,
        render: render,
        renderPodology: renderPodology
    };
})();

// Экспорт
window.AdminServicesRenderer = AdminServicesRenderer;


// ============= renderers/articles.js =============

/**
 * Admin Articles Renderer
 * Рендеринг списка статей
 */

var AdminArticlesRenderer = (function() {
    'use strict';

    var container = null;

    /**
     * Инициализация
     */
    function init() {
        container = document.getElementById('articlesGrid');
    }

    /**
     * Форматирование даты
     */
    function formatDate(dateStr) {
        if (!dateStr) return '';
        try {
            var date = new Date(dateStr);
            return date.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        } catch (e) {
            return dateStr;
        }
    }

    /**
     * Рендеринг списка статей
     */
    function render() {
        if (!container) {
            container = document.getElementById('articlesGrid');
            if (!container) return;
        }

        var articles = AdminState.articles || [];

        if (articles.length === 0) {
            container.innerHTML = '<p class="empty-message">Нет статей. Нажмите "Добавить" чтобы создать.</p>';
            return;
        }

        var html = articles.map(function(article) {
            var imageHtml = article.image
                ? '<img src="' + article.image + '" alt="' + escapeHtml(article.title) + '">'
                : SharedIcons.get('image');

            return '<div class="article-card" data-id="' + article.id + '">' +
                '<div class="article-image">' +
                    imageHtml +
                '</div>' +
                '<div class="article-content">' +
                    '<div class="article-meta">' +
                        '<span class="article-tag">' + escapeHtml(article.tag || 'Статья') + '</span>' +
                        '<span class="article-date">' + formatDate(article.date) + '</span>' +
                    '</div>' +
                    '<h3 class="article-title">' + escapeHtml(article.title) + '</h3>' +
                    '<p class="article-excerpt">' + escapeHtml(article.excerpt || '') + '</p>' +
                    '<div class="article-actions">' +
                        '<button class="btn btn-secondary" data-action="edit-article" data-id="' + article.id + '">' +
                            SharedIcons.get('edit') +
                            'Редактировать' +
                        '</button>' +
                        '<button class="btn btn-icon danger" data-action="delete-article" data-id="' + article.id + '" title="Удалить">' +
                            SharedIcons.get('delete') +
                        '</button>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }).join('');

        container.innerHTML = html;
    }

    /**
     * Escape HTML
     */
    function escapeHtml(text) {
        if (!text) return '';
        if (typeof window.escapeHtml === 'function') {
            return window.escapeHtml(text);
        }
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Публичный API
    return {
        init: init,
        render: render,
        formatDate: formatDate
    };
})();

// Экспорт
window.AdminArticlesRenderer = AdminArticlesRenderer;


// ============= renderers/faq.js =============

/**
 * Admin FAQ Renderer
 * Рендеринг списка FAQ
 */

var AdminFaqRenderer = (function() {
    'use strict';

    var container = null;

    /**
     * Инициализация
     */
    function init() {
        container = document.getElementById('faqList');
    }

    /**
     * Рендеринг списка FAQ
     */
    function render() {
        if (!container) {
            container = document.getElementById('faqList');
            if (!container) return;
        }

        var faq = AdminState.faq || [];

        if (faq.length === 0) {
            container.innerHTML = '<p class="empty-message">Нет вопросов. Нажмите "Добавить" чтобы создать.</p>';
            return;
        }

        var html = faq.map(function(item) {
            return '<div class="faq-admin-item" data-id="' + item.id + '">' +
                '<div class="faq-admin-content">' +
                    '<h3 class="faq-admin-question">' + escapeHtml(item.question) + '</h3>' +
                    '<p class="faq-admin-answer">' + escapeHtml(item.answer) + '</p>' +
                '</div>' +
                '<div class="faq-admin-actions">' +
                    '<button class="btn btn-secondary" data-action="edit-faq" data-id="' + item.id + '">' +
                        SharedIcons.get('edit') +
                        'Редактировать' +
                    '</button>' +
                    '<button class="btn btn-icon danger" data-action="delete-faq" data-id="' + item.id + '" title="Удалить">' +
                        SharedIcons.get('delete') +
                    '</button>' +
                '</div>' +
            '</div>';
        }).join('');

        container.innerHTML = html;
    }

    /**
     * Escape HTML
     */
    function escapeHtml(text) {
        if (!text) return '';
        if (typeof window.escapeHtml === 'function') {
            return window.escapeHtml(text);
        }
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Публичный API
    return {
        init: init,
        render: render
    };
})();

// Экспорт
window.AdminFaqRenderer = AdminFaqRenderer;


// ============= renderers/social.js =============

/**
 * Admin Social Renderer
 * Рендеринг соцсетей и контактов
 */

var AdminSocialRenderer = (function() {
    'use strict';

    var elements = {};

    /**
     * Инициализация
     */
    function init() {
        elements = {
            socialLinksList: document.getElementById('socialLinksList'),
            contactPhone: document.getElementById('contactPhone'),
            contactEmail: document.getElementById('contactEmail'),
            contactAddress: document.getElementById('contactAddress')
        };
    }

    /**
     * Рендеринг соцсетей и контактов
     */
    function render() {
        var social = AdminState.social || {};

        // Заполняем контактную информацию
        if (elements.contactPhone) {
            elements.contactPhone.value = social.phone || '';
        }
        if (elements.contactEmail) {
            elements.contactEmail.value = social.email || '';
        }
        if (elements.contactAddress) {
            elements.contactAddress.value = social.address || '';
        }

        // Рендерим список соцсетей
        if (!elements.socialLinksList) {
            elements.socialLinksList = document.getElementById('socialLinksList');
            if (!elements.socialLinksList) return;
        }

        var socialLinks = social.social || [];

        if (socialLinks.length === 0) {
            elements.socialLinksList.innerHTML = '<p class="empty-message">Нет настроенных соцсетей</p>';
            return;
        }

        var html = socialLinks.map(function(link) {
            var inactiveClass = link.active ? '' : 'inactive';
            var toggleClass = link.active ? 'active' : '';
            var toggleText = link.active ? 'Вкл' : 'Выкл';

            return '<div class="social-link-item ' + inactiveClass + '" data-id="' + link.id + '">' +
                '<div class="social-link-icon ' + link.icon + '">' +
                    SharedIcons.getSocial(link.icon) +
                '</div>' +
                '<div class="social-link-info">' +
                    '<div class="social-link-name">' + escapeHtml(link.name) + '</div>' +
                    '<input type="text" ' +
                        'class="social-link-url-input" ' +
                        'data-social-id="' + link.id + '" ' +
                        'value="' + escapeHtml(link.url || '') + '" ' +
                        'placeholder="Введите URL для ' + escapeHtml(link.name) + '">' +
                '</div>' +
                '<div class="social-link-toggle">' +
                    '<div class="toggle ' + toggleClass + '" data-social-id="' + link.id + '" data-action="toggle-social"></div>' +
                    '<span>' + toggleText + '</span>' +
                '</div>' +
            '</div>';
        }).join('');

        elements.socialLinksList.innerHTML = html;
    }

    /**
     * Переключение активности соцсети
     */
    function toggleActive(id) {
        var social = AdminState.social;
        if (!social || !social.social) return;

        var link = social.social.find(function(s) {
            return s.id === id;
        });

        if (link) {
            link.active = !link.active;
            render();
        }
    }

    /**
     * Сохранение соцсетей
     */
    async function save() {
        var social = AdminState.social;

        // Собираем данные из формы
        if (elements.contactPhone) {
            social.phone = elements.contactPhone.value.trim();
        }
        if (elements.contactEmail) {
            social.email = elements.contactEmail.value.trim();
        }
        if (elements.contactAddress) {
            social.address = elements.contactAddress.value.trim();
        }

        // Собираем URL соцсетей из инпутов
        var urlInputs = document.querySelectorAll('.social-link-url-input');
        urlInputs.forEach(function(input) {
            var socialId = input.dataset.socialId;
            if (social.social) {
                var link = social.social.find(function(s) {
                    return s.id === socialId;
                });
                if (link) {
                    link.url = input.value.trim();
                }
            }
        });

        try {
            await AdminAPI.save('social', social);
            showToast('Настройки сохранены', 'success');
        } catch (error) {
            console.error('Error saving social:', error);
            showToast('Ошибка сохранения', 'error');
        }
    }

    /**
     * Escape HTML
     */
    function escapeHtml(text) {
        if (!text) return '';
        if (typeof window.escapeHtml === 'function') {
            return window.escapeHtml(text);
        }
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Публичный API
    return {
        init: init,
        render: render,
        toggleActive: toggleActive,
        save: save
    };
})();

// Экспорт
window.AdminSocialRenderer = AdminSocialRenderer;


// ============= forms/master-form.js =============

/**
 * Admin Master Form
 * Форма добавления/редактирования мастера
 */

var AdminMasterForm = (function() {
    'use strict';

    /**
     * Показать форму мастера
     */
    function show(master) {
        AdminState.editingItem = master || null;

        var title = master ? 'Редактировать мастера' : 'Добавить мастера';
        var principles = (master && master.principles) || ['', '', '', ''];

        var principlesHtml = principles.map(function(p, i) {
            return '<div class="principle-item">' +
                '<input type="text" class="form-input principle-input" value="' + escapeHtml(p) + '" placeholder="Принцип ' + (i + 1) + '">' +
                '<button type="button" class="btn btn-icon danger" data-action="remove-principle">' +
                    SharedIcons.get('close') +
                '</button>' +
            '</div>';
        }).join('');

        var html = '<form id="masterForm" class="admin-form">' +
            '<div class="form-group">' +
                '<label class="form-label">Фото</label>' +
                '<div class="image-upload ' + (master && master.photo ? 'has-image' : '') + '" id="masterPhotoUpload">' +
                    (master && master.photo ? '<img src="' + master.photo + '" alt="Фото">' : '') +
                    '<input type="file" accept="image/*" data-upload-target="masterPhoto">' +
                    SharedIcons.get('upload') +
                    '<span>Нажмите для загрузки фото</span>' +
                    (master && master.photo ? '<button type="button" class="remove-image" data-action="remove-image" data-target="masterPhoto">' + SharedIcons.get('close') + '</button>' : '') +
                '</div>' +
                '<input type="hidden" id="masterPhoto" value="' + (master && master.photo ? master.photo : '') + '">' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Имя *</label>' +
                '<input type="text" class="form-input" id="masterName" value="' + escapeHtml(master && master.name || '') + '" placeholder="Введите имя мастера" required>' +
            '</div>' +
            '<div class="form-row form-row-2">' +
                '<div class="form-group">' +
                    '<label class="form-label">Инициал</label>' +
                    '<input type="text" class="form-input" id="masterInitial" value="' + escapeHtml(master && master.initial || '') + '" placeholder="С" maxlength="1">' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label">Уровень</label>' +
                    '<select class="form-select" id="masterBadge">' +
                        '<option value="green" ' + (master && master.badge === 'green' ? 'selected' : '') + '>Green (начальный)</option>' +
                        '<option value="pink" ' + (master && master.badge === 'pink' ? 'selected' : '') + '>Pink (средний)</option>' +
                        '<option value="blue" ' + (master && master.badge === 'blue' ? 'selected' : '') + '>Dark Blue (высший)</option>' +
                    '</select>' +
                '</div>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Должность</label>' +
                '<input type="text" class="form-input" id="masterRole" value="' + escapeHtml(master && master.role || '') + '" placeholder="Мастер">' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Специализация</label>' +
                '<textarea class="form-textarea" id="masterSpecialization" placeholder="Описание специализации мастера...">' + escapeHtml(master && master.specialization || '') + '</textarea>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Принципы работы</label>' +
                '<div class="principles-list" id="principlesList">' +
                    principlesHtml +
                '</div>' +
                '<button type="button" class="btn btn-secondary add-principle" data-action="add-principle">' +
                    SharedIcons.get('plus') +
                    'Добавить принцип' +
                '</button>' +
            '</div>' +
        '</form>';

        AdminModals.setTitle('modal', title);
        var modalBody = document.getElementById('modalBody');
        if (modalBody) {
            modalBody.innerHTML = html;
        }
        AdminModals.open('modal');
    }

    /**
     * Сохранить мастера
     */
    async function save() {
        var nameEl = document.getElementById('masterName');
        var name = nameEl ? nameEl.value.trim() : '';

        if (!name) {
            showToast('Введите имя мастера', 'error');
            return;
        }

        var initialEl = document.getElementById('masterInitial');
        var badgeEl = document.getElementById('masterBadge');
        var roleEl = document.getElementById('masterRole');
        var specEl = document.getElementById('masterSpecialization');
        var photoEl = document.getElementById('masterPhoto');

        var initial = initialEl ? initialEl.value.trim() : '';
        var badge = badgeEl ? badgeEl.value : 'green';
        var role = roleEl ? roleEl.value.trim() : 'Мастер';
        var specialization = specEl ? specEl.value.trim() : '';
        var photo = photoEl ? photoEl.value : null;

        var principles = [];
        var principleInputs = document.querySelectorAll('.principle-input');
        principleInputs.forEach(function(input) {
            var val = input.value.trim();
            if (val) {
                principles.push(val);
            }
        });

        var masterData = {
            id: AdminState.editingItem ? AdminState.editingItem.id : 'master_' + Date.now(),
            name: name,
            initial: initial || name.charAt(0),
            badge: badge,
            role: role || 'Мастер',
            specialization: specialization,
            principles: principles,
            photo: photo,
            active: true
        };

        var masters = AdminState.masters || [];

        if (AdminState.editingItem) {
            var index = masters.findIndex(function(m) {
                return m.id === AdminState.editingItem.id;
            });
            if (index !== -1) {
                masters[index] = masterData;
            }
        } else {
            masters.push(masterData);
        }

        try {
            await AdminAPI.save('masters', { masters: masters });
            AdminState.setMasters(masters);
            showToast('Мастер сохранён', 'success');
            AdminModals.close('modal');
            AdminMastersRenderer.render();
        } catch (error) {
            showToast('Ошибка сохранения: ' + error.message, 'error');
        }
    }

    /**
     * Удалить мастера
     */
    async function remove(id) {
        if (!confirm('Вы уверены, что хотите удалить этого мастера?')) {
            return;
        }

        var masters = AdminState.masters.filter(function(m) {
            return m.id !== id;
        });

        try {
            await AdminAPI.save('masters', { masters: masters });
            AdminState.setMasters(masters);
            showToast('Мастер удалён', 'success');
            AdminMastersRenderer.render();
        } catch (error) {
            showToast('Ошибка удаления: ' + error.message, 'error');
        }
    }

    /**
     * Добавить поле принципа
     */
    function addPrinciple() {
        var list = document.getElementById('principlesList');
        if (!list) return;

        var count = list.querySelectorAll('.principle-item').length;

        var div = document.createElement('div');
        div.className = 'principle-item';
        div.innerHTML = '<input type="text" class="form-input principle-input" value="" placeholder="Принцип ' + (count + 1) + '">' +
            '<button type="button" class="btn btn-icon danger" data-action="remove-principle">' +
                SharedIcons.get('close') +
            '</button>';

        list.appendChild(div);
    }

    /**
     * Удалить поле принципа
     */
    function removePrinciple(button) {
        var item = button.closest('.principle-item');
        if (item) {
            item.remove();
        }
    }

    /**
     * Escape HTML
     */
    function escapeHtml(text) {
        if (!text) return '';
        if (typeof window.escapeHtml === 'function') {
            return window.escapeHtml(text);
        }
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Публичный API
    return {
        show: show,
        save: save,
        remove: remove,
        addPrinciple: addPrinciple,
        removePrinciple: removePrinciple
    };
})();

// Экспорт
window.AdminMasterForm = AdminMasterForm;


// ============= forms/service-form.js =============

/**
 * Admin Service Form
 * Форма добавления/редактирования услуги
 */

var AdminServiceForm = (function() {
    'use strict';

    /**
     * Показать форму услуги
     */
    function show(categoryId, index) {
        categoryId = categoryId || AdminState.currentCategory || 'main';

        var services = AdminState.services || {};
        var category = null;
        var service = null;

        if (services.categories) {
            category = services.categories.find(function(c) {
                return c.id === categoryId;
            });
        }

        if (category && index !== null && index !== undefined) {
            service = category.services[index];
        }

        AdminState.editingItem = {
            categoryId: categoryId,
            index: index,
            service: service
        };

        var title = service ? 'Редактировать услугу' : 'Добавить услугу';

        var html = '<form id="serviceForm" class="admin-form">' +
            '<div class="form-group">' +
                '<label class="form-label">Название услуги *</label>' +
                '<input type="text" class="form-input" id="serviceName" value="' + escapeHtml(service && service.name || '') + '" placeholder="Введите название услуги" required>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Цены по уровням мастеров</label>' +
                '<div class="form-row">' +
                    '<div class="form-group">' +
                        '<label class="form-label price-label-green">Green</label>' +
                        '<input type="number" class="form-input" id="priceGreen" value="' + (service && service.priceGreen || '') + '" placeholder="1000">' +
                    '</div>' +
                    '<div class="form-group">' +
                        '<label class="form-label price-label-pink">Pink</label>' +
                        '<input type="number" class="form-input" id="pricePink" value="' + (service && service.pricePink || '') + '" placeholder="1300">' +
                    '</div>' +
                    '<div class="form-group">' +
                        '<label class="form-label price-label-blue">Dark Blue</label>' +
                        '<input type="number" class="form-input" id="priceBlue" value="' + (service && service.priceBlue || '') + '" placeholder="1500">' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</form>';

        AdminModals.setTitle('modal', title);
        var modalBody = document.getElementById('modalBody');
        if (modalBody) {
            modalBody.innerHTML = html;
        }
        AdminModals.open('modal');
    }

    /**
     * Показать форму услуги подологии
     */
    function showPodology(index) {
        var services = AdminState.services || {};
        var podologyServices = (services.podology && services.podology.services) || [];
        var service = null;

        if (index !== null && index !== undefined) {
            service = podologyServices[index];
        }

        AdminState.editingItem = {
            type: 'podology',
            index: index,
            service: service
        };

        var title = service ? 'Редактировать услугу' : 'Добавить услугу подологии';

        var html = '<form id="podologyForm" class="admin-form">' +
            '<div class="form-group">' +
                '<label class="form-label">Название услуги *</label>' +
                '<input type="text" class="form-input" id="podologyName" value="' + escapeHtml(service && service.name || '') + '" placeholder="Введите название услуги" required>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Цена</label>' +
                '<input type="text" class="form-input" id="podologyPrice" value="' + escapeHtml(service && service.price || '') + '" placeholder="от 2000 ₽">' +
            '</div>' +
        '</form>';

        AdminModals.setTitle('modal', title);
        var modalBody = document.getElementById('modalBody');
        if (modalBody) {
            modalBody.innerHTML = html;
        }
        AdminModals.open('modal');
    }

    /**
     * Получить название категории
     */
    function getCategoryName(id) {
        var names = {
            main: 'Основные услуги',
            complex: 'Комплексные услуги',
            additional: 'Дополнительные услуги'
        };
        return names[id] || id;
    }

    /**
     * Сохранить услугу
     */
    async function save() {
        var editing = AdminState.editingItem || {};
        var categoryId = editing.categoryId;
        var index = editing.index;

        var nameEl = document.getElementById('serviceName');
        var name = nameEl ? nameEl.value.trim() : '';

        if (!name) {
            showToast('Введите название услуги', 'error');
            return;
        }

        var greenEl = document.getElementById('priceGreen');
        var pinkEl = document.getElementById('pricePink');
        var blueEl = document.getElementById('priceBlue');

        var priceGreen = parseInt(greenEl ? greenEl.value : 0) || 0;
        var pricePink = parseInt(pinkEl ? pinkEl.value : 0) || 0;
        var priceBlue = parseInt(blueEl ? blueEl.value : 0) || 0;

        var serviceData = {
            id: editing.service ? editing.service.id : Date.now(),
            name: name,
            priceGreen: priceGreen,
            pricePink: pricePink,
            priceBlue: priceBlue
        };

        var services = AdminState.services || {};

        // Ensure categories exist
        if (!services.categories) {
            services.categories = [];
        }

        var category = services.categories.find(function(c) {
            return c.id === categoryId;
        });

        if (!category) {
            category = {
                id: categoryId,
                name: getCategoryName(categoryId),
                services: []
            };
            services.categories.push(category);
        }

        if (!category.services) {
            category.services = [];
        }

        if (index !== null && index !== undefined) {
            category.services[index] = serviceData;
        } else {
            category.services.push(serviceData);
        }

        try {
            await AdminAPI.save('services', services);
            AdminState.setServices(services);
            showToast('Услуга сохранена', 'success');
            AdminModals.close('modal');
            AdminServicesRenderer.render();
        } catch (error) {
            showToast('Ошибка сохранения: ' + error.message, 'error');
        }
    }

    /**
     * Сохранить услугу подологии
     */
    async function savePodology() {
        var editing = AdminState.editingItem || {};
        var index = editing.index;

        var nameEl = document.getElementById('podologyName');
        var name = nameEl ? nameEl.value.trim() : '';

        if (!name) {
            showToast('Введите название услуги', 'error');
            return;
        }

        var priceEl = document.getElementById('podologyPrice');
        var price = priceEl ? priceEl.value.trim() : 'Уточняйте';

        var serviceData = {
            id: editing.service ? editing.service.id : Date.now(),
            name: name,
            price: price || 'Уточняйте'
        };

        var services = AdminState.services || {};

        if (!services.podology) {
            services.podology = { services: [] };
        }
        if (!services.podology.services) {
            services.podology.services = [];
        }

        if (index !== null && index !== undefined) {
            services.podology.services[index] = serviceData;
        } else {
            services.podology.services.push(serviceData);
        }

        try {
            await AdminAPI.save('services', services);
            AdminState.setServices(services);
            showToast('Услуга сохранена', 'success');
            AdminModals.close('modal');
            AdminServicesRenderer.renderPodology();
        } catch (error) {
            showToast('Ошибка сохранения: ' + error.message, 'error');
        }
    }

    /**
     * Удалить услугу
     */
    async function remove(categoryId, index) {
        if (!confirm('Вы уверены, что хотите удалить эту услугу?')) {
            return;
        }

        var services = AdminState.services || {};
        var category = services.categories && services.categories.find(function(c) {
            return c.id === categoryId;
        });

        if (category && category.services) {
            category.services.splice(index, 1);
        }

        try {
            await AdminAPI.save('services', services);
            AdminState.setServices(services);
            showToast('Услуга удалена', 'success');
            AdminServicesRenderer.render();
        } catch (error) {
            showToast('Ошибка удаления: ' + error.message, 'error');
        }
    }

    /**
     * Удалить услугу подологии
     */
    async function removePodology(index) {
        if (!confirm('Вы уверены, что хотите удалить эту услугу?')) {
            return;
        }

        var services = AdminState.services || {};

        if (services.podology && services.podology.services) {
            services.podology.services.splice(index, 1);
        }

        try {
            await AdminAPI.save('services', services);
            AdminState.setServices(services);
            showToast('Услуга удалена', 'success');
            AdminServicesRenderer.renderPodology();
        } catch (error) {
            showToast('Ошибка удаления: ' + error.message, 'error');
        }
    }

    /**
     * Escape HTML
     */
    function escapeHtml(text) {
        if (!text) return '';
        if (typeof window.escapeHtml === 'function') {
            return window.escapeHtml(text);
        }
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Публичный API
    return {
        show: show,
        showPodology: showPodology,
        save: save,
        savePodology: savePodology,
        remove: remove,
        removePodology: removePodology
    };
})();

// Экспорт
window.AdminServiceForm = AdminServiceForm;


// ============= forms/article-form.js =============

/**
 * Admin Article Form
 * Форма добавления/редактирования статьи
 */

var AdminArticleForm = (function() {
    'use strict';

    /**
     * Показать форму статьи
     */
    function show(article) {
        AdminState.editingItem = article || null;

        var title = article ? 'Редактировать статью' : 'Добавить статью';
        var today = new Date().toISOString().split('T')[0];

        var html = '<form id="articleForm" class="admin-form">' +
            '<div class="form-group">' +
                '<label class="form-label">Изображение</label>' +
                '<div class="image-upload ' + (article && article.image ? 'has-image' : '') + '" id="articleImageUpload">' +
                    (article && article.image ? '<img src="' + article.image + '" alt="Изображение">' : '') +
                    '<input type="file" accept="image/*" data-upload-target="articleImage">' +
                    SharedIcons.get('upload') +
                    '<span>Нажмите для загрузки изображения</span>' +
                    (article && article.image ? '<button type="button" class="remove-image" data-action="remove-image" data-target="articleImage">' + SharedIcons.get('close') + '</button>' : '') +
                '</div>' +
                '<input type="hidden" id="articleImage" value="' + (article && article.image ? article.image : '') + '">' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Заголовок *</label>' +
                '<input type="text" class="form-input" id="articleTitle" value="' + escapeHtml(article && article.title || '') + '" placeholder="Введите заголовок статьи" required>' +
            '</div>' +
            '<div class="form-row form-row-2">' +
                '<div class="form-group">' +
                    '<label class="form-label">Тег/Категория</label>' +
                    '<input type="text" class="form-input" id="articleTag" value="' + escapeHtml(article && article.tag || '') + '" placeholder="Уход за волосами">' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label">Дата публикации</label>' +
                    '<input type="date" class="form-input" id="articleDate" value="' + (article && article.date || today) + '">' +
                '</div>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Краткое описание</label>' +
                '<textarea class="form-textarea" id="articleExcerpt" placeholder="Краткое описание для превью статьи...">' + escapeHtml(article && article.excerpt || '') + '</textarea>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Полный текст статьи</label>' +
                '<div class="editor-toolbar">' +
                    '<button type="button" class="toolbar-btn" data-command="bold" title="Жирный (Ctrl+B)"><strong>B</strong></button>' +
                    '<button type="button" class="toolbar-btn" data-command="italic" title="Курсив (Ctrl+I)"><em>I</em></button>' +
                    '<button type="button" class="toolbar-btn" data-command="underline" title="Подчёркнутый (Ctrl+U)"><u>U</u></button>' +
                    '<span class="toolbar-divider"></span>' +
                    '<button type="button" class="toolbar-btn" data-command="h2" title="Заголовок">H2</button>' +
                    '<button type="button" class="toolbar-btn" data-command="h3" title="Подзаголовок">H3</button>' +
                    '<span class="toolbar-divider"></span>' +
                    '<button type="button" class="toolbar-btn" data-command="ul" title="Маркированный список">•</button>' +
                    '<button type="button" class="toolbar-btn" data-command="ol" title="Нумерованный список">1.</button>' +
                    '<span class="toolbar-divider"></span>' +
                    '<button type="button" class="toolbar-btn" data-command="link" title="Ссылка">🔗</button>' +
                    '<button type="button" class="toolbar-btn" data-command="removeFormat" title="Очистить форматирование">✕</button>' +
                '</div>' +
                '<div class="wysiwyg-editor" id="articleContent" contenteditable="true" data-placeholder="Начните писать текст статьи...">' + (article && article.content || '') + '</div>' +
            '</div>' +
        '</form>';

        AdminModals.setTitle('modal', title);
        var modalBody = document.getElementById('modalBody');
        if (modalBody) {
            modalBody.innerHTML = html;
        }
        AdminModals.open('modal');

        // Инициализация редактора
        initEditor();
    }

    /**
     * Инициализация WYSIWYG редактора
     */
    function initEditor() {
        var editor = document.getElementById('articleContent');
        if (!editor) return;

        // Инициализация тулбара
        var toolbar = document.querySelector('.editor-toolbar');
        if (toolbar) {
            toolbar.addEventListener('mousedown', function(e) {
                var btn = e.target.closest('.toolbar-btn');
                if (btn) {
                    e.preventDefault();
                    var command = btn.dataset.command;
                    if (command) {
                        AdminWYSIWYG.formatText(command);
                    }
                }
            });
        }

        // Горячие клавиши
        editor.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key.toLowerCase()) {
                    case 'b':
                        e.preventDefault();
                        AdminWYSIWYG.formatText('bold');
                        break;
                    case 'i':
                        e.preventDefault();
                        AdminWYSIWYG.formatText('italic');
                        break;
                    case 'u':
                        e.preventDefault();
                        AdminWYSIWYG.formatText('underline');
                        break;
                }
            }
        });

        // Очистка форматирования при вставке
        editor.addEventListener('paste', function(e) {
            e.preventDefault();
            var text = (e.clipboardData || window.clipboardData).getData('text/plain');
            var selection = window.getSelection();
            if (!selection.rangeCount) return;

            selection.deleteFromDocument();

            var lines = text.split('\n');
            var fragment = document.createDocumentFragment();

            lines.forEach(function(line, index) {
                fragment.appendChild(document.createTextNode(line));
                if (index < lines.length - 1) {
                    fragment.appendChild(document.createElement('br'));
                }
            });

            selection.getRangeAt(0).insertNode(fragment);
            selection.collapseToEnd();
        });
    }

    /**
     * Сохранить статью
     */
    async function save() {
        var titleEl = document.getElementById('articleTitle');
        var title = titleEl ? titleEl.value.trim() : '';

        if (!title) {
            showToast('Введите заголовок статьи', 'error');
            return;
        }

        var tagEl = document.getElementById('articleTag');
        var dateEl = document.getElementById('articleDate');
        var excerptEl = document.getElementById('articleExcerpt');
        var contentEl = document.getElementById('articleContent');
        var imageEl = document.getElementById('articleImage');

        var tag = tagEl ? tagEl.value.trim() : 'Статья';
        var date = dateEl ? dateEl.value : new Date().toISOString().split('T')[0];
        var excerpt = excerptEl ? excerptEl.value.trim() : '';
        var content = contentEl ? contentEl.innerHTML.trim() : '';
        var image = imageEl ? imageEl.value : null;

        var articleData = {
            id: AdminState.editingItem ? AdminState.editingItem.id : 'article_' + Date.now(),
            title: title,
            tag: tag || 'Статья',
            date: date,
            excerpt: excerpt,
            content: content,
            image: image,
            active: true
        };

        var articles = AdminState.articles || [];

        if (AdminState.editingItem) {
            var index = articles.findIndex(function(a) {
                return a.id === AdminState.editingItem.id;
            });
            if (index !== -1) {
                articles[index] = articleData;
            }
        } else {
            articles.push(articleData);
        }

        try {
            await AdminAPI.save('articles', { articles: articles });
            AdminState.setArticles(articles);
            showToast('Статья сохранена', 'success');
            AdminModals.close('modal');
            AdminArticlesRenderer.render();
        } catch (error) {
            showToast('Ошибка сохранения: ' + error.message, 'error');
        }
    }

    /**
     * Удалить статью
     */
    async function remove(id) {
        if (!confirm('Вы уверены, что хотите удалить эту статью?')) {
            return;
        }

        var articles = AdminState.articles.filter(function(a) {
            return a.id !== id;
        });

        try {
            await AdminAPI.save('articles', { articles: articles });
            AdminState.setArticles(articles);
            showToast('Статья удалена', 'success');
            AdminArticlesRenderer.render();
        } catch (error) {
            showToast('Ошибка удаления: ' + error.message, 'error');
        }
    }

    /**
     * Escape HTML
     */
    function escapeHtml(text) {
        if (!text) return '';
        if (typeof window.escapeHtml === 'function') {
            return window.escapeHtml(text);
        }
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Публичный API
    return {
        show: show,
        save: save,
        remove: remove
    };
})();

// Экспорт
window.AdminArticleForm = AdminArticleForm;


// ============= forms/faq-form.js =============

/**
 * Admin FAQ Form
 * Форма добавления/редактирования FAQ
 */

var AdminFaqForm = (function() {
    'use strict';

    /**
     * Показать форму FAQ
     */
    function show(faqItem) {
        AdminState.editingItem = faqItem || null;

        var title = faqItem ? 'Редактировать вопрос' : 'Добавить вопрос';

        var html = '<form id="faqForm" class="admin-form">' +
            '<div class="form-group">' +
                '<label class="form-label">Вопрос *</label>' +
                '<input type="text" class="form-input" id="faqQuestion" value="' + escapeHtml(faqItem && faqItem.question || '') + '" placeholder="Введите вопрос" required>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Ответ *</label>' +
                '<textarea class="form-textarea" id="faqAnswer" placeholder="Введите ответ на вопрос..." rows="5">' + escapeHtml(faqItem && faqItem.answer || '') + '</textarea>' +
            '</div>' +
        '</form>';

        AdminModals.setTitle('modal', title);
        var modalBody = document.getElementById('modalBody');
        if (modalBody) {
            modalBody.innerHTML = html;
        }
        AdminModals.open('modal');
    }

    /**
     * Сохранить FAQ
     */
    async function save() {
        var questionEl = document.getElementById('faqQuestion');
        var question = questionEl ? questionEl.value.trim() : '';

        if (!question) {
            showToast('Введите вопрос', 'error');
            return;
        }

        var answerEl = document.getElementById('faqAnswer');
        var answer = answerEl ? answerEl.value.trim() : '';

        if (!answer) {
            showToast('Введите ответ', 'error');
            return;
        }

        var faqData = {
            id: AdminState.editingItem ? AdminState.editingItem.id : 'faq_' + Date.now(),
            question: question,
            answer: answer
        };

        var faq = AdminState.faq || [];

        if (AdminState.editingItem) {
            var index = faq.findIndex(function(f) {
                return f.id === AdminState.editingItem.id;
            });
            if (index !== -1) {
                faq[index] = faqData;
            }
        } else {
            faq.push(faqData);
        }

        try {
            await AdminAPI.save('faq', { faq: faq });
            AdminState.setFaq(faq);
            showToast('Вопрос сохранён', 'success');
            AdminModals.close('modal');
            AdminFaqRenderer.render();
        } catch (error) {
            showToast('Ошибка сохранения: ' + error.message, 'error');
        }
    }

    /**
     * Удалить FAQ
     */
    async function remove(id) {
        if (!confirm('Вы уверены, что хотите удалить этот вопрос?')) {
            return;
        }

        var faq = AdminState.faq.filter(function(f) {
            return f.id !== id;
        });

        try {
            await AdminAPI.save('faq', { faq: faq });
            AdminState.setFaq(faq);
            showToast('Вопрос удалён', 'success');
            AdminFaqRenderer.render();
        } catch (error) {
            showToast('Ошибка удаления: ' + error.message, 'error');
        }
    }

    /**
     * Escape HTML
     */
    function escapeHtml(text) {
        if (!text) return '';
        if (typeof window.escapeHtml === 'function') {
            return window.escapeHtml(text);
        }
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Публичный API
    return {
        show: show,
        save: save,
        remove: remove
    };
})();

// Экспорт
window.AdminFaqForm = AdminFaqForm;


// ============= index.js =============

/**
 * Admin Panel Main Entry Point
 * Инициализация и координация всех модулей
 */

var AdminPanel = (function() {
    'use strict';

    // DOM элементы
    var elements = {};

    /**
     * Инициализация DOM элементов
     */
    function initElements() {
        elements = {
            // Navigation
            navItems: document.querySelectorAll('.nav-item'),
            sections: document.querySelectorAll('.section'),
            pageTitle: document.getElementById('pageTitle'),
            pageDescription: document.getElementById('pageDescription'),
            addNewBtn: document.getElementById('addNewBtn'),

            // Service tabs
            serviceTabs: document.querySelectorAll('.tab'),

            // Modals
            modalOverlay: document.getElementById('modalOverlay'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modalTitle'),
            modalBody: document.getElementById('modalBody'),
            modalClose: document.getElementById('modalClose'),
            modalCancel: document.getElementById('modalCancel'),
            modalSave: document.getElementById('modalSave'),

            // Delete modal
            deleteModalOverlay: document.getElementById('deleteModalOverlay'),
            deleteMessage: document.getElementById('deleteMessage'),
            deleteModalClose: document.getElementById('deleteModalClose'),
            deleteCancel: document.getElementById('deleteCancel'),
            deleteConfirm: document.getElementById('deleteConfirm'),

            // Social
            saveSocialBtn: document.getElementById('saveSocialBtn'),

            // Toast
            toastContainer: document.getElementById('toastContainer')
        };
    }

    /**
     * Загрузка всех данных
     */
    async function loadData() {
        console.log('Loading data...');

        try {
            var data = await AdminAPI.loadAllData();

            // Обновляем состояние
            AdminState.setMasters(data.masters.masters || []);
            AdminState.setServices(data.services || {});
            AdminState.setArticles(data.articles.articles || []);
            AdminState.setFaq(data.faq.faq || []);
            AdminState.setSocial(data.social || {});

            // Рендеринг
            renderCurrentSection();

            // Статистика
            if (data.stats) {
                AdminStatsRenderer.render(data.stats);
            }

            showToast('Данные загружены', 'success');
            console.log('Data loaded successfully');
        } catch (error) {
            console.error('Error loading data:', error);
            showToast('Ошибка загрузки данных', 'error');
        }
    }

    /**
     * Рендеринг текущей секции
     */
    function renderCurrentSection() {
        var section = AdminState.currentSection;

        switch (section) {
            case 'stats':
                loadStats();
                break;
            case 'masters':
                AdminMastersRenderer.render();
                break;
            case 'services':
                AdminServicesRenderer.render();
                break;
            case 'podology':
                AdminServicesRenderer.renderPodology();
                break;
            case 'articles':
                AdminArticlesRenderer.render();
                break;
            case 'faq':
                AdminFaqRenderer.render();
                break;
            case 'social':
                AdminSocialRenderer.render();
                break;
        }
    }

    /**
     * Загрузка статистики
     */
    async function loadStats() {
        try {
            var stats = await AdminAPI.get('stats');
            AdminStatsRenderer.render(stats);
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    // =================================================================
    // NAVIGATION
    // =================================================================

    /**
     * Переключение секции
     */
    function switchSection(section) {
        AdminState.currentSection = section;

        // Обновляем навигацию
        elements.navItems.forEach(function(item) {
            item.classList.toggle('active', item.dataset.section === section);
        });

        // Скрываем все секции
        elements.sections.forEach(function(sec) {
            sec.classList.remove('active');
        });

        // Конфигурация секций
        var sectionConfig = {
            stats: {
                element: '#statsSection',
                title: 'Статистика',
                description: 'Аналитика посещений сайта',
                hideAddBtn: true
            },
            masters: {
                element: '#mastersSection',
                title: 'Мастера',
                description: 'Управление командой барберов',
                addText: 'Добавить мастера'
            },
            services: {
                element: '#servicesSection',
                title: 'Услуги',
                description: 'Прайс-лист барбершопа',
                addText: 'Добавить услугу'
            },
            podology: {
                element: '#podologySection',
                title: 'Подология',
                description: 'Услуги подологического кабинета',
                addText: 'Добавить услугу'
            },
            articles: {
                element: '#articlesSection',
                title: 'Статьи',
                description: 'Блог и полезные материалы',
                addText: 'Добавить статью'
            },
            faq: {
                element: '#faqSection',
                title: 'FAQ',
                description: 'Часто задаваемые вопросы',
                addText: 'Добавить вопрос'
            },
            social: {
                element: '#socialSection',
                title: 'Соцсети и контакты',
                description: 'Настройка социальных сетей и контактной информации',
                hideAddBtn: true
            }
        };

        var config = sectionConfig[section];
        if (config) {
            var sectionEl = document.querySelector(config.element);
            if (sectionEl) {
                sectionEl.classList.add('active');
            }

            if (elements.pageTitle) {
                elements.pageTitle.textContent = config.title;
            }
            if (elements.pageDescription) {
                elements.pageDescription.textContent = config.description;
            }

            // Кнопка добавления
            if (elements.addNewBtn) {
                elements.addNewBtn.style.display = config.hideAddBtn ? 'none' : 'flex';
                var addBtnText = elements.addNewBtn.querySelector('span');
                if (addBtnText && config.addText) {
                    addBtnText.textContent = config.addText;
                }
            }
        }

        renderCurrentSection();
    }

    /**
     * Переключение категории услуг
     */
    function switchServiceCategory(category) {
        AdminState.currentCategory = category;

        elements.serviceTabs.forEach(function(tab) {
            tab.classList.toggle('active', tab.dataset.category === category);
        });

        AdminServicesRenderer.render();
    }

    // =================================================================
    // EVENT DELEGATION
    // =================================================================

    /**
     * Инициализация делегирования событий
     */
    function initEventDelegation() {
        // Глобальный обработчик кликов
        document.addEventListener('click', function(e) {
            var target = e.target.closest('[data-action]');
            if (!target) return;

            var action = target.getAttribute('data-action');
            var id = target.getAttribute('data-id');
            var category = target.getAttribute('data-category');
            var index = target.getAttribute('data-index');

            switch (action) {
                // Masters
                case 'edit-master':
                    editMaster(id);
                    break;
                case 'delete-master':
                    AdminMasterForm.remove(id);
                    break;

                // Services
                case 'edit-service':
                    AdminServiceForm.show(category, parseInt(index));
                    break;
                case 'delete-service':
                    AdminServiceForm.remove(category, parseInt(index));
                    break;

                // Podology
                case 'edit-podology':
                    AdminServiceForm.showPodology(parseInt(index));
                    break;
                case 'delete-podology':
                    AdminServiceForm.removePodology(parseInt(index));
                    break;

                // Articles
                case 'edit-article':
                    editArticle(id);
                    break;
                case 'delete-article':
                    AdminArticleForm.remove(id);
                    break;

                // FAQ
                case 'edit-faq':
                    editFaq(id);
                    break;
                case 'delete-faq':
                    AdminFaqForm.remove(id);
                    break;

                // Social
                case 'toggle-social':
                    var socialId = target.getAttribute('data-social-id');
                    AdminSocialRenderer.toggleActive(socialId);
                    break;

                // Image upload
                case 'remove-image':
                    var imageTarget = target.getAttribute('data-target');
                    removeImage(imageTarget);
                    break;

                // Master principles
                case 'add-principle':
                    AdminMasterForm.addPrinciple();
                    break;
                case 'remove-principle':
                    AdminMasterForm.removePrinciple(target);
                    break;
            }
        });

        // Обработчик загрузки изображений
        document.addEventListener('change', function(e) {
            var target = e.target;
            if (target.matches('[data-upload-target]')) {
                var inputId = target.getAttribute('data-upload-target');
                handleImageUpload(e, inputId);
            }
        });
    }

    // =================================================================
    // CRUD HELPERS
    // =================================================================

    function editMaster(id) {
        var master = AdminState.findMaster(id);
        if (master) {
            AdminMasterForm.show(master);
        }
    }

    function editArticle(id) {
        var article = AdminState.findArticle(id);
        if (article) {
            AdminArticleForm.show(article);
        }
    }

    function editFaq(id) {
        var faqItem = AdminState.findFaq(id);
        if (faqItem) {
            AdminFaqForm.show(faqItem);
        }
    }

    // =================================================================
    // IMAGE HANDLING
    // =================================================================

    async function handleImageUpload(event, inputId) {
        var file = event.target.files && event.target.files[0];
        if (!file) return;

        if (!file.type.startsWith('image/')) {
            showToast('Пожалуйста, выберите изображение', 'error');
            return;
        }

        if (file.size > 5 * 1024 * 1024) {
            showToast('Файл слишком большой (максимум 5 МБ)', 'error');
            return;
        }

        showToast('Загрузка изображения...', 'success');

        try {
            var result = await AdminImageUpload.uploadFile(file);

            if (result.success) {
                var input = document.getElementById(inputId);
                if (input) {
                    input.value = result.url;
                }

                var uploadDiv = event.target.closest('.image-upload');
                if (uploadDiv) {
                    uploadDiv.classList.add('has-image');

                    var img = uploadDiv.querySelector('img');
                    if (!img) {
                        img = document.createElement('img');
                        uploadDiv.appendChild(img);
                    }
                    img.src = result.url;
                    img.alt = 'Загруженное изображение';

                    if (!uploadDiv.querySelector('.remove-image')) {
                        var removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.className = 'remove-image';
                        removeBtn.setAttribute('data-action', 'remove-image');
                        removeBtn.setAttribute('data-target', inputId);
                        removeBtn.innerHTML = SharedIcons.get('close');
                        uploadDiv.appendChild(removeBtn);
                    }
                }

                showToast('Изображение загружено', 'success');
            } else {
                showToast('Ошибка загрузки: ' + (result.error || 'Неизвестная ошибка'), 'error');
            }
        } catch (error) {
            console.error('Upload error:', error);
            showToast('Ошибка загрузки изображения', 'error');
        }
    }

    function removeImage(inputId) {
        var input = document.getElementById(inputId);
        if (input) {
            input.value = '';
        }

        var uploadDiv = document.getElementById(inputId + 'Upload');
        if (!uploadDiv && input) {
            uploadDiv = input.closest('.form-group').querySelector('.image-upload');
        }

        if (uploadDiv) {
            uploadDiv.classList.remove('has-image');
            var img = uploadDiv.querySelector('img');
            if (img) img.remove();
            var removeBtn = uploadDiv.querySelector('.remove-image');
            if (removeBtn) removeBtn.remove();
        }
    }

    // =================================================================
    // EVENT LISTENERS
    // =================================================================

    function initEventListeners() {
        // Navigation
        elements.navItems.forEach(function(item) {
            item.addEventListener('click', function() {
                switchSection(item.dataset.section);
            });
        });

        // Service tabs
        elements.serviceTabs.forEach(function(tab) {
            tab.addEventListener('click', function() {
                switchServiceCategory(tab.dataset.category);
            });
        });

        // Add new button
        if (elements.addNewBtn) {
            elements.addNewBtn.addEventListener('click', function() {
                switch (AdminState.currentSection) {
                    case 'masters':
                        AdminMasterForm.show();
                        break;
                    case 'services':
                        AdminServiceForm.show(AdminState.currentCategory);
                        break;
                    case 'podology':
                        AdminServiceForm.showPodology();
                        break;
                    case 'articles':
                        AdminArticleForm.show();
                        break;
                    case 'faq':
                        AdminFaqForm.show();
                        break;
                }
            });
        }

        // Modal controls
        if (elements.modalClose) {
            elements.modalClose.addEventListener('click', function() {
                AdminModals.close('modal');
            });
        }
        if (elements.modalCancel) {
            elements.modalCancel.addEventListener('click', function() {
                AdminModals.close('modal');
            });
        }
        if (elements.modalOverlay) {
            elements.modalOverlay.addEventListener('click', function(e) {
                if (e.target === elements.modalOverlay) {
                    AdminModals.close('modal');
                }
            });
        }

        // Modal save
        if (elements.modalSave) {
            elements.modalSave.addEventListener('click', function() {
                switch (AdminState.currentSection) {
                    case 'masters':
                        AdminMasterForm.save();
                        break;
                    case 'services':
                        AdminServiceForm.save();
                        break;
                    case 'podology':
                        AdminServiceForm.savePodology();
                        break;
                    case 'articles':
                        AdminArticleForm.save();
                        break;
                    case 'faq':
                        AdminFaqForm.save();
                        break;
                }
            });
        }

        // Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                AdminModals.closeCurrent();
            }
        });

        // Save social button
        if (elements.saveSocialBtn) {
            elements.saveSocialBtn.addEventListener('click', function() {
                AdminSocialRenderer.save();
            });
        }
    }

    // =================================================================
    // INITIALIZATION
    // =================================================================

    /**
     * Инициализация админ-панели после логина
     */
    function initAdminPanel() {
        console.log('Admin Panel initializing...');

        initElements();

        // Инициализация модулей
        AdminModals.init();
        AdminStatsRenderer.init();
        AdminMastersRenderer.init();
        AdminServicesRenderer.init();
        AdminArticlesRenderer.init();
        AdminFaqRenderer.init();
        AdminSocialRenderer.init();

        // Инициализация логаута
        AdminAuth.initLogoutButton();

        // Event listeners
        initEventListeners();
        initEventDelegation();

        // Загрузка данных и переход на статистику
        loadData();
        switchSection('stats');

        console.log('Admin Panel initialized');
    }

    /**
     * Главная точка входа
     */
    async function init() {
        await AdminAuth.init(
            // onAuthenticated
            function() {
                initAdminPanel();
            },
            // onNotAuthenticated
            function() {
                AdminAuth.initLoginForm(function() {
                    initAdminPanel();
                });
            }
        );
    }

    // Запуск при готовности DOM
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // Публичный API (для совместимости с onclick в HTML)
    return {
        // Navigation
        switchSection: switchSection,
        switchServiceCategory: switchServiceCategory,

        // Masters
        editMaster: editMaster,
        deleteMaster: function(id) { AdminMasterForm.remove(id); },
        showMasterForm: function(id) {
            var master = id ? AdminState.findMaster(id) : null;
            AdminMasterForm.show(master);
        },

        // Services
        editService: function(categoryId, index) {
            AdminServiceForm.show(categoryId, index);
        },
        deleteService: function(categoryId, index) {
            AdminServiceForm.remove(categoryId, index);
        },
        editPodologyService: function(index) {
            AdminServiceForm.showPodology(index);
        },
        deletePodologyService: function(index) {
            AdminServiceForm.removePodology(index);
        },

        // Articles
        editArticle: editArticle,
        deleteArticle: function(id) { AdminArticleForm.remove(id); },
        showArticleForm: function(id) {
            var article = id ? AdminState.findArticle(id) : null;
            AdminArticleForm.show(article);
        },

        // FAQ
        editFaq: editFaq,
        deleteFaq: function(id) { AdminFaqForm.remove(id); },
        showFaqForm: function(id) {
            var faqItem = id ? AdminState.findFaq(id) : null;
            AdminFaqForm.show(faqItem);
        },

        // Social
        toggleSocialActive: function(id) {
            AdminSocialRenderer.toggleActive(id);
        },
        saveSocial: function() {
            AdminSocialRenderer.save();
        },

        // Image handling
        handleImageUpload: handleImageUpload,
        removeImage: removeImage,

        // Master principles
        addPrinciple: function() { AdminMasterForm.addPrinciple(); },
        removePrinciple: function(btn) { AdminMasterForm.removePrinciple(btn); },

        // WYSIWYG
        formatText: function(command) {
            AdminWYSIWYG.formatText(command);
        },

        // Reload
        loadData: loadData
    };
})();

// Экспорт
window.AdminPanel = AdminPanel;
