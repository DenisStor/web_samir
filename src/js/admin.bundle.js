/**
 * Say's Barbers Admin Panel Bundle
 * Auto-generated by build.py - DO NOT EDIT DIRECTLY
 * Edit individual modules in src/js/admin/ instead
 */



// ============= shared/config.js =============

/**
 * Config Module - Централизованный доступ к конфигурации
 * @module AppConfig
 */
(function() {
    'use strict';

    // Дефолтные значения (fallback если config.json не загружен)
    var defaults = {
        site: {
            name: "Say's Barbers",
            domain: 'saysbarbers.ru',
            phone: '+7 (911) 070-11-07',
            telegram: 'https://t.me/saysbarbers'
        },
        api: {
            baseUrl: '/api',
            timeout: 30000
        },
        auth: {
            sessionTimeoutHours: 24,
            maxLoginAttempts: 5,
            lockoutMinutes: 15
        },
        ui: {
            toastDuration: 3000,
            debounceDelay: 300,
            animationDuration: 300,
            maxImageSize: 5242880,
            maxUploadImages: 10
        },
        colors: {
            danger: '#ff4757',
            dangerHover: '#ff3344',
            dangerLight: '#ff6b6b',
            dangerSubtle: 'rgba(255, 71, 87, 0.15)'
        },
        idPrefixes: {
            master: 'master_',
            article: 'article_',
            product: 'product_',
            category: 'category_',
            legal: 'legal_',
            faq: 'faq_'
        }
    };

    var config = null;
    var loaded = false;
    var loadPromise = null;

    /**
     * Получить значение из вложенного объекта по пути
     * @param {Object} obj - Объект для поиска
     * @param {string} path - Путь вида 'site.name' или 'ui.toastDuration'
     * @returns {*} Найденное значение или undefined
     */
    function getNestedValue(obj, path) {
        if (!obj || !path) return undefined;

        var parts = path.split('.');
        var value = obj;

        for (var i = 0; i < parts.length; i++) {
            if (value && typeof value === 'object' && parts[i] in value) {
                value = value[parts[i]];
            } else {
                return undefined;
            }
        }
        return value;
    }

    /**
     * Получить значение конфигурации по пути
     * @param {string} path - Путь к значению (например 'site.name', 'ui.toastDuration')
     * @param {*} [defaultValue] - Значение по умолчанию если не найдено
     * @returns {*} Значение конфигурации
     * @example
     * AppConfig.get('site.name') // "Say's Barbers"
     * AppConfig.get('ui.toastDuration', 3000) // 3000
     */
    function get(path, defaultValue) {
        // Сначала ищем в загруженном конфиге
        var value = getNestedValue(config, path);
        if (value !== undefined) return value;

        // Затем в дефолтах
        value = getNestedValue(defaults, path);
        if (value !== undefined) return value;

        // Возвращаем переданный default
        return defaultValue;
    }

    /**
     * Асинхронная загрузка конфигурации
     * @returns {Promise<Object>} Загруженная конфигурация
     */
    function load() {
        if (loaded) return Promise.resolve(config);
        if (loadPromise) return loadPromise;

        loadPromise = fetch('/config.json')
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Config not found');
                }
                return response.json();
            })
            .then(function(data) {
                config = data;
                loaded = true;
                return config;
            })
            .catch(function(error) {
                console.warn('AppConfig: Using defaults, config.json not loaded:', error.message);
                config = defaults;
                loaded = true;
                return config;
            });

        return loadPromise;
    }

    /**
     * Проверить, загружен ли конфиг
     * @returns {boolean}
     */
    function isLoaded() {
        return loaded;
    }

    /**
     * Получить все дефолтные значения
     * @returns {Object}
     */
    function getDefaults() {
        return defaults;
    }

    // Экспорт
    window.AppConfig = {
        get: get,
        load: load,
        isLoaded: isLoaded,
        getDefaults: getDefaults
    };

})();


// ============= shared/helpers.js =============

/**
 * Shared Helpers Module
 * Общие утилиты для всех частей приложения
 * @module SharedHelpers
 */
(function() {
    'use strict';

    // =================================================================
    // XSS PROTECTION
    // =================================================================

    /**
     * Escape HTML entities для защиты от XSS
     * @param {string|null|undefined} text - Текст для экранирования
     * @returns {string} Экранированный текст
     * @example
     * escapeHtml('<script>alert("xss")</script>') // '&lt;script&gt;alert("xss")&lt;/script&gt;'
     */
    function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        var str = String(text);
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    /**
     * Escape для HTML атрибутов (включая одинарные кавычки)
     * Используется в onclick и других атрибутах с одинарными кавычками
     * @param {string|null|undefined} text - Текст для экранирования
     * @returns {string} Экранированный текст
     * @example
     * escapeAttr("test'value") // 'test&#39;value'
     */
    function escapeAttr(text) {
        if (text === null || text === undefined) return '';
        return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // =================================================================
    // ID GENERATION
    // =================================================================

    /**
     * Генерация уникального ID с префиксом
     * @param {string} [prefix='item'] - Префикс ID (например 'master', 'product')
     * @returns {string} Уникальный ID вида prefix_timestamp_random
     * @example
     * generateId('master') // 'master_1705312847123_k8j2m9n3x'
     */
    function generateId(prefix) {
        var p = prefix || 'item';
        return p + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // =================================================================
    // DEBOUNCE / THROTTLE
    // =================================================================

    /**
     * Debounce - отложенный вызов функции
     * @param {Function} func - Функция для отложенного вызова
     * @param {number} wait - Время ожидания в мс
     * @returns {Function} Debounced функция
     * @example
     * var debouncedSearch = debounce(search, 300);
     * input.addEventListener('input', debouncedSearch);
     */
    function debounce(func, wait) {
        var timeout;
        return function() {
            var context = this;
            var args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(function() {
                func.apply(context, args);
            }, wait);
        };
    }

    /**
     * Throttle через requestAnimationFrame
     * @param {Function} func - Функция для throttle
     * @returns {Function} Throttled функция
     * @example
     * var throttledScroll = throttleRAF(onScroll);
     * window.addEventListener('scroll', throttledScroll, { passive: true });
     */
    function throttleRAF(func) {
        var rafId = null;
        return function() {
            var context = this;
            var args = arguments;
            if (rafId) return;
            rafId = requestAnimationFrame(function() {
                func.apply(context, args);
                rafId = null;
            });
        };
    }

    // =================================================================
    // FORMAT UTILITIES
    // =================================================================

    /**
     * Форматирование цены в рубли
     * @param {number|string} price - Цена
     * @returns {string} Отформатированная цена
     * @example
     * formatPrice(1500) // '1 500 ₽'
     */
    function formatPrice(price) {
        var num = parseInt(price, 10);
        if (isNaN(num)) return '0 ₽';
        return num.toLocaleString('ru-RU') + ' ₽';
    }

    /**
     * Форматирование даты
     * @param {string|Date} date - Дата
     * @param {Object} [options] - Опции форматирования
     * @returns {string} Отформатированная дата
     */
    function formatDate(date, options) {
        if (!date) return '';
        var d = typeof date === 'string' ? new Date(date) : date;
        if (isNaN(d.getTime())) return '';

        var defaultOptions = {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        };

        return d.toLocaleDateString('ru-RU', options || defaultOptions);
    }

    // =================================================================
    // EXPORT
    // =================================================================

    window.SharedHelpers = {
        // XSS
        escapeHtml: escapeHtml,
        escapeAttr: escapeAttr,

        // ID
        generateId: generateId,

        // Timing
        debounce: debounce,
        throttleRAF: throttleRAF,

        // Formatting
        formatPrice: formatPrice,
        formatDate: formatDate
    };

    // Глобальные алиасы для обратной совместимости
    window.escapeHtml = escapeHtml;
    window.escapeAttr = escapeAttr;
    window.generateId = generateId;
    window.debounce = debounce;

})();


// ============= state.js =============

/**
 * Admin Panel State Module
 * Централизованное хранилище состояния приложения
 */

var AdminState = {
    // Данные
    masters: [],
    services: { categories: [], podology: { services: [] } },
    articles: [],
    faq: [],
    social: { social: [], phone: '', email: '', address: '' },
    // Shop данные
    shopCategories: [],
    products: [],
    // Legal данные
    legalDocuments: [],

    // UI состояние
    currentSection: 'stats',
    isLoading: false,
    editingItem: null,

    // Методы для работы с состоянием
    reset: function() {
        this.masters = [];
        this.services = { categories: [], podology: { services: [] } };
        this.articles = [];
        this.faq = [];
        this.social = { social: [], phone: '', email: '', address: '' };
        this.shopCategories = [];
        this.products = [];
        this.legalDocuments = [];
        this.editingItem = null;
    },

    // Вспомогательная функция сортировки по order
    _sortByOrder: function(items) {
        if (!items || !Array.isArray(items)) return items;
        return items.slice().sort(function(a, b) {
            var orderA = typeof a.order === 'number' ? a.order : Infinity;
            var orderB = typeof b.order === 'number' ? b.order : Infinity;
            return orderA - orderB;
        });
    },

    setMasters: function(data) {
        this.masters = this._sortByOrder(data || []);
    },

    setServices: function(data) {
        this.services = data || { categories: [], podology: { services: [] } };
    },

    setArticles: function(data) {
        this.articles = this._sortByOrder(data || []);
    },

    setFaq: function(data) {
        this.faq = this._sortByOrder(data || []);
    },

    setSocial: function(data) {
        this.social = data || { social: [], phone: '', email: '', address: '' };
    },

    // Найти элемент по ID
    findMaster: function(id) {
        return this.masters.find(function(m) { return m.id === id; });
    },

    findArticle: function(id) {
        return this.articles.find(function(a) { return a.id === id; });
    },

    findFaq: function(id) {
        return this.faq.find(function(f) { return f.id === id; });
    },

    findSocialLink: function(id) {
        var links = this.social.social || [];
        return links.find(function(s) { return s.id === id; });
    },

    // Shop методы
    setShopCategories: function(data) {
        this.shopCategories = this._sortByOrder(data || []);
    },

    setProducts: function(data) {
        this.products = this._sortByOrder(data || []);
    },

    findShopCategory: function(id) {
        return this.shopCategories.find(function(c) { return c.id === id; });
    },

    findProduct: function(id) {
        return this.products.find(function(p) { return p.id === id; });
    },

    // Legal методы
    setLegalDocuments: function(data) {
        this.legalDocuments = data || [];
    },

    findLegalDocument: function(id) {
        return this.legalDocuments.find(function(d) { return d.id === id; });
    }
};

// Экспорт
window.AdminState = AdminState;


// ============= toast.js =============

/**
 * Toast Notifications Module
 * Система уведомлений для админ-панели
 */

var AdminToast = (function() {
    'use strict';

    var container = null;

    /**
     * Инициализация контейнера
     */
    function init() {
        container = document.getElementById('toastContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container';
            document.body.appendChild(container);
        }
    }

    /**
     * Показать уведомление
     * @param {string} message - текст сообщения
     * @param {string} type - тип уведомления: 'success', 'error', 'warning', 'info'
     * @param {number} duration - длительность показа в мс (по умолчанию 3000)
     */
    function show(message, type, duration) {
        type = type || 'success';
        duration = duration || 3000;

        if (!container) init();

        var toast = document.createElement('div');
        toast.className = 'toast toast-' + type;

        var icon = getIcon(type);
        toast.innerHTML = '<span class="toast-icon">' + icon + '</span>' +
                          '<span class="toast-message">' + window.escapeHtml(message) + '</span>';

        container.appendChild(toast);

        // Анимация появления
        setTimeout(function() {
            toast.classList.add('show');
        }, 10);

        // Автоматическое скрытие
        setTimeout(function() {
            toast.classList.remove('show');
            setTimeout(function() {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, duration);

        return toast;
    }

    /**
     * Получить иконку для типа уведомления
     */
    function getIcon(type) {
        var icons = {
            success: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
            error: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
            warning: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
            info: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'
        };
        return icons[type] || icons.info;
    }

    // Shorthand методы
    function success(message, duration) {
        return show(message, 'success', duration);
    }

    function error(message, duration) {
        return show(message, 'error', duration);
    }

    function warning(message, duration) {
        return show(message, 'warning', duration);
    }

    function info(message, duration) {
        return show(message, 'info', duration);
    }

    // Публичный API
    return {
        init: init,
        show: show,
        success: success,
        error: error,
        warning: warning,
        info: info
    };
})();

// Глобальная функция для совместимости
function showToast(message, type, duration) {
    return AdminToast.show(message, type, duration);
}

// Экспорт
window.AdminToast = AdminToast;
window.showToast = showToast;


// ============= api.js =============

/**
 * Admin API Module
 * Клиент для работы с серверным API
 */

var AdminAPI = (function() {
    'use strict';

    var AUTH_TOKEN_KEY = 'says_admin_token';
    var sessionExpiredHandled = false; // Предотвращает повторную обработку

    // =================================================================
    // TOKEN MANAGEMENT
    // =================================================================

    function getToken() {
        return sessionStorage.getItem(AUTH_TOKEN_KEY);
    }

    function setToken(token) {
        if (token) {
            sessionStorage.setItem(AUTH_TOKEN_KEY, token);
            sessionExpiredHandled = false; // Сбрасываем флаг при новом токене
        } else {
            sessionStorage.removeItem(AUTH_TOKEN_KEY);
        }
    }

    /**
     * Обработка истекшей сессии (вызывается однократно)
     */
    function handleSessionExpired() {
        if (sessionExpiredHandled) return;
        sessionExpiredHandled = true;

        setToken(null);
        if (typeof showToast === 'function') {
            showToast('Сессия истекла. Пожалуйста, войдите снова.', 'error');
        }

        // Показываем форму логина вместо reload
        if (typeof AdminAuth !== 'undefined' && typeof AdminAuth.showLoginForm === 'function') {
            AdminAuth.showLoginForm();
        } else {
            // Fallback: показываем модальное окно или перезагружаем страницу с задержкой
            setTimeout(function() {
                sessionExpiredHandled = false;
                location.reload();
            }, 2000);
        }
    }

    function getAuthHeaders() {
        var token = getToken();
        var headers = { 'Content-Type': 'application/json' };
        if (token) {
            headers['Authorization'] = 'Bearer ' + token;
        }
        return headers;
    }

    // =================================================================
    // HTTP METHODS
    // =================================================================

    /**
     * GET запрос
     */
    async function get(endpoint) {
        try {
            var response = await fetch('/api/' + endpoint);
            if (!response.ok) throw new Error('HTTP ' + response.status);
            return response.json();
        } catch (error) {
            console.error('API GET ' + endpoint + ' error:', error);
            return null;
        }
    }

    /**
     * POST запрос (требует авторизации)
     */
    async function save(endpoint, data) {
        try {
            var response = await fetch('/api/' + endpoint, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(data)
            });

            // Обработка unauthorized
            if (response.status === 401) {
                handleSessionExpired();
                throw new Error('Unauthorized');
            }

            if (!response.ok) {
                var errorData = await response.json().catch(function() { return {}; });
                throw new Error(errorData.error || 'HTTP ' + response.status);
            }
            return response.json();
        } catch (error) {
            console.error('API POST ' + endpoint + ' error:', error);
            throw error;
        }
    }

    /**
     * Загрузка изображения (base64)
     */
    async function upload(imageData) {
        try {
            var response = await fetch('/api/upload', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ image: imageData })
            });

            if (response.status === 401) {
                handleSessionExpired();
                throw new Error('Unauthorized');
            }

            if (!response.ok) {
                var errorData = await response.json().catch(function() { return {}; });
                throw new Error(errorData.error || 'HTTP ' + response.status);
            }
            return response.json();
        } catch (error) {
            console.error('Upload error:', error);
            throw error;
        }
    }

    /**
     * Удаление файла
     */
    async function deleteFile(filename) {
        try {
            var response = await fetch('/api/upload/' + filename, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                handleSessionExpired();
                throw new Error('Unauthorized');
            }

            if (!response.ok) {
                var errorData = await response.json().catch(function() { return {}; });
                throw new Error(errorData.error || 'HTTP ' + response.status);
            }
            return response.json();
        } catch (error) {
            console.error('Delete file error:', error);
            throw error;
        }
    }

    // =================================================================
    // AUTHENTICATION
    // =================================================================

    /**
     * Вход в систему
     */
    async function login(password) {
        try {
            var response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: password })
            });

            var data = await response.json();

            if (response.status === 429) {
                throw new Error('Слишком много попыток. Попробуйте позже.');
            }

            if (!response.ok) {
                throw new Error(data.error || 'Неверный пароль');
            }

            return data;
        } catch (error) {
            console.error('Login error:', error);
            throw error;
        }
    }

    /**
     * Выход из системы
     */
    async function logout() {
        try {
            await fetch('/api/auth/logout', {
                method: 'POST',
                headers: getAuthHeaders()
            });
        } catch (error) {
            console.error('Logout error:', error);
        }
        setToken(null);
    }

    /**
     * Проверка авторизации
     */
    async function checkAuth() {
        try {
            var token = getToken();
            if (!token) return false;

            var response = await fetch('/api/auth/check', {
                method: 'POST',
                headers: getAuthHeaders()
            });

            var data = await response.json();
            return data.valid === true;
        } catch (error) {
            console.error('Auth check error:', error);
            return false;
        }
    }

    // =================================================================
    // DATA LOADING
    // =================================================================

    /**
     * Загрузка всех данных
     */
    async function loadAllData() {
        var results = await Promise.all([
            get('masters'),
            get('services'),
            get('articles'),
            get('faq'),
            get('social'),
            get('stats'),
            get('shop/categories'),
            get('shop/products'),
            get('legal')
        ]);

        return {
            masters: results[0],
            services: results[1],
            articles: results[2],
            faq: results[3],
            social: results[4],
            stats: results[5],
            shopCategories: results[6],
            products: results[7],
            legal: results[8]
        };
    }

    // Публичный API
    return {
        // Token management
        getToken: getToken,
        setToken: setToken,

        // HTTP methods
        get: get,
        save: save,
        upload: upload,
        deleteFile: deleteFile,

        // Auth
        login: login,
        logout: logout,
        checkAuth: checkAuth,

        // Data
        loadAllData: loadAllData
    };
})();

// Экспорт
window.AdminAPI = AdminAPI;


// ============= auth.js =============

/**
 * Admin Authentication Module
 * Управление входом и выходом из админ-панели
 */

var AdminAuth = (function() {
    'use strict';

    /**
     * Показать админ-панель
     */
    function showAdminPanel() {
        document.body.classList.add('authenticated');
    }

    /**
     * Скрыть админ-панель
     */
    function hideAdminPanel() {
        document.body.classList.remove('authenticated');
    }

    /**
     * Инициализация формы входа
     */
    function initLoginForm(onSuccess) {
        var loginForm = document.getElementById('loginForm');
        var loginError = document.getElementById('loginError');
        var passwordInput = document.getElementById('password');
        var togglePassword = document.getElementById('togglePassword');

        if (!loginForm) return;

        // Toggle password visibility
        if (togglePassword) {
            togglePassword.addEventListener('click', function() {
                var type = passwordInput.type === 'password' ? 'text' : 'password';
                passwordInput.type = type;

                var eyeIcon = togglePassword.querySelector('.eye-icon');
                var eyeOffIcon = togglePassword.querySelector('.eye-off-icon');

                if (type === 'text') {
                    eyeIcon.style.display = 'none';
                    eyeOffIcon.style.display = 'block';
                } else {
                    eyeIcon.style.display = 'block';
                    eyeOffIcon.style.display = 'none';
                }
            });
        }

        // Handle login form submit
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            var password = passwordInput.value;
            var submitBtn = loginForm.querySelector('button[type="submit"]');

            // Disable button during request
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Вход...';
            }

            try {
                var result = await AdminAPI.login(password);

                if (result.success && result.token) {
                    AdminAPI.setToken(result.token);
                    showAdminPanel();
                    loginError.classList.remove('visible');
                    loginError.textContent = '';

                    // Callback for successful login
                    if (typeof onSuccess === 'function') {
                        onSuccess();
                    }
                }
            } catch (error) {
                loginError.textContent = error.message || 'Неверный пароль';
                loginError.classList.add('visible');
                passwordInput.value = '';
                passwordInput.focus();

                // Shake animation
                var loginCard = loginForm.closest('.login-card');
                if (loginCard) {
                    loginCard.style.animation = 'none';
                    loginCard.offsetHeight; // Trigger reflow
                    loginCard.style.animation = 'shake 0.5s ease';
                }
            } finally {
                // Re-enable button
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Войти';
                }
            }
        });

        // Enter key handler
        passwordInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                loginForm.dispatchEvent(new Event('submit'));
            }
        });
    }

    /**
     * Инициализация кнопки выхода
     */
    function initLogoutButton() {
        var logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async function() {
                if (confirm('Вы уверены, что хотите выйти?')) {
                    await AdminAPI.logout();
                    hideAdminPanel();
                    location.reload();
                }
            });
        }
    }

    /**
     * Проверка авторизации и инициализация
     */
    async function init(onAuthenticated, onNotAuthenticated) {
        var isAuthenticated = await AdminAPI.checkAuth();

        if (isAuthenticated) {
            showAdminPanel();
            if (typeof onAuthenticated === 'function') {
                onAuthenticated();
            }
        } else {
            AdminAPI.setToken(null);
            if (typeof onNotAuthenticated === 'function') {
                onNotAuthenticated();
            }
        }
    }

    // Публичный API
    return {
        init: init,
        showAdminPanel: showAdminPanel,
        hideAdminPanel: hideAdminPanel,
        initLoginForm: initLoginForm,
        initLogoutButton: initLogoutButton
    };
})();

// Экспорт
window.AdminAuth = AdminAuth;


// ============= navigation.js =============

/**
 * Admin Navigation Module
 * Управление навигацией между секциями админ-панели
 */

var AdminNavigation = (function() {
    'use strict';

    var currentSection = 'stats';
    var sectionTitles = {
        'stats': 'Статистика',
        'masters': 'Мастера',
        'services': 'Услуги',
        'articles': 'Статьи',
        'principles': 'Принципы',
        'faq': 'FAQ',
        'social': 'Соцсети'
    };

    /**
     * Переключение на секцию
     */
    function switchSection(sectionId) {
        // Скрыть все секции
        var sections = document.querySelectorAll('.admin-section');
        sections.forEach(function(section) {
            section.classList.remove('active');
        });

        // Показать выбранную секцию
        var targetSection = document.getElementById(sectionId + '-section');
        if (targetSection) {
            targetSection.classList.add('active');
        }

        // Обновить активный пункт меню
        var navItems = document.querySelectorAll('.sidebar-nav a');
        navItems.forEach(function(item) {
            item.classList.remove('active');
            if (item.getAttribute('data-section') === sectionId) {
                item.classList.add('active');
            }
        });

        // Обновить заголовок
        var pageTitle = document.getElementById('pageTitle');
        if (pageTitle) {
            pageTitle.textContent = sectionTitles[sectionId] || sectionId;
        }

        currentSection = sectionId;

        // Обновить состояние
        if (window.AdminState) {
            window.AdminState.currentSection = sectionId;
        }
    }

    /**
     * Получить текущую секцию
     */
    function getCurrentSection() {
        return currentSection;
    }

    /**
     * Инициализация навигации
     */
    function init() {
        var navItems = document.querySelectorAll('.sidebar-nav a[data-section]');
        navItems.forEach(function(item) {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                var sectionId = this.getAttribute('data-section');
                if (sectionId) {
                    switchSection(sectionId);
                }
            });
        });
    }

    // Публичный API
    return {
        init: init,
        switchSection: switchSection,
        getCurrentSection: getCurrentSection,
        sectionTitles: sectionTitles
    };
})();

// Экспорт
window.AdminNavigation = AdminNavigation;


// ============= modals.js =============

/**
 * Admin Modals Module
 * Управление модальными окнами
 */

var AdminModals = (function() {
    'use strict';

    var currentModal = null;
    var escapeHandlerBound = false;
    var overlayClickHandlerBound = false;
    var boundCloseHandlers = []; // Хранение ссылок на обработчики для cleanup
    var boundOpenHandlers = [];  // Хранение ссылок на обработчики для cleanup

    /**
     * Открыть модальное окно
     */
    function open(modalId) {
        // Для modal и deleteModal - активируем overlay
        var overlayId = modalId === 'modal' ? 'modalOverlay' :
                        modalId === 'deleteModal' ? 'deleteModalOverlay' : modalId;
        var overlay = document.getElementById(overlayId);
        if (!overlay) {
            console.error('Modal overlay not found:', overlayId);
            return;
        }

        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        currentModal = overlay;

        // Обработчик закрытия по Escape (только если ещё не добавлен)
        if (!escapeHandlerBound) {
            document.addEventListener('keydown', handleEscape);
            escapeHandlerBound = true;
        }

        // Обработчик закрытия по клику на оверлей (только если ещё не добавлен)
        if (!overlayClickHandlerBound) {
            overlay.addEventListener('click', handleOverlayClick);
            overlayClickHandlerBound = true;
        }
    }

    /**
     * Закрыть модальное окно
     */
    function close(modalId) {
        var overlay;
        if (modalId) {
            var overlayId = modalId === 'modal' ? 'modalOverlay' :
                            modalId === 'deleteModal' ? 'deleteModalOverlay' : modalId;
            overlay = document.getElementById(overlayId);
        } else {
            overlay = currentModal;
        }
        if (!overlay) return;

        overlay.classList.remove('active');
        document.body.style.overflow = '';

        // Удаляем обработчики
        if (escapeHandlerBound) {
            document.removeEventListener('keydown', handleEscape);
            escapeHandlerBound = false;
        }
        if (overlayClickHandlerBound) {
            overlay.removeEventListener('click', handleOverlayClick);
            overlayClickHandlerBound = false;
        }

        currentModal = null;

        // Сброс формы если есть
        var form = overlay.querySelector('form');
        if (form) {
            form.reset();
        }
    }

    /**
     * Закрыть текущее модальное окно
     */
    function closeCurrent() {
        if (currentModal) {
            close();
        }
    }

    /**
     * Обработчик нажатия Escape
     */
    function handleEscape(e) {
        if (e.key === 'Escape') {
            closeCurrent();
        }
    }

    /**
     * Обработчик клика по оверлею
     */
    function handleOverlayClick(e) {
        if (e.target.classList.contains('modal') || e.target.classList.contains('modal-overlay')) {
            closeCurrent();
        }
    }

    /**
     * Установить заголовок модального окна
     */
    function setTitle(modalId, title) {
        var modal = document.getElementById(modalId);
        if (!modal) return;

        var titleEl = modal.querySelector('.modal-title');
        if (titleEl) {
            titleEl.textContent = title;
        }
    }

    /**
     * Установить состояние загрузки на кнопке
     */
    function setButtonLoading(btn, loading, loadingText) {
        if (!btn) return;

        if (loading) {
            // Сохраняем оригинальный текст
            if (!btn.dataset.originalText) {
                btn.dataset.originalText = btn.innerHTML;
            }
            btn.classList.add('btn-loading');
            btn.disabled = true;

            // Добавляем спиннер и текст
            var spinner = '<span class="btn-spinner"></span>';
            var text = loadingText || 'Загрузка...';
            btn.innerHTML = spinner + '<span class="btn-loading-text">' + text + '</span>';
        } else {
            btn.classList.remove('btn-loading');
            btn.disabled = false;

            // Восстанавливаем оригинальный текст
            if (btn.dataset.originalText) {
                btn.innerHTML = btn.dataset.originalText;
                delete btn.dataset.originalText;
            }
        }
    }

    /**
     * Показать диалог подтверждения удаления
     */
    function confirmDelete(itemName, onConfirm) {
        var overlay = document.getElementById('deleteModalOverlay');
        var modal = document.getElementById('deleteModal');

        if (!overlay || !modal) {
            // Fallback на стандартный confirm
            if (confirm('Удалить "' + itemName + '"?')) {
                onConfirm();
            }
            return;
        }

        // Устанавливаем название элемента
        var nameEl = modal.querySelector('.delete-item-name');
        if (nameEl) {
            nameEl.textContent = itemName || 'этот элемент';
        }

        // Устанавливаем обработчик подтверждения
        var confirmBtn = modal.querySelector('.btn-danger, [data-action="confirm-delete"]');
        var cancelBtn = modal.querySelector('.btn-secondary, [data-action="cancel-delete"]');

        function cleanup() {
            if (confirmBtn) {
                confirmBtn.removeEventListener('click', handleConfirm);
            }
            if (cancelBtn) {
                cancelBtn.removeEventListener('click', handleCancel);
            }
            close('deleteModal');
        }

        function handleConfirm() {
            cleanup();
            if (typeof onConfirm === 'function') {
                onConfirm();
            }
        }

        function handleCancel() {
            cleanup();
        }

        if (confirmBtn) {
            confirmBtn.addEventListener('click', handleConfirm);
        }
        if (cancelBtn) {
            cancelBtn.addEventListener('click', handleCancel);
        }

        // Открываем модалку
        open('deleteModal');
    }

    /**
     * Инициализация кнопок закрытия
     */
    function init() {
        // Сначала очищаем предыдущие обработчики (если init вызван повторно)
        destroy();

        // Инициализация кнопок закрытия
        var closeButtons = document.querySelectorAll('.modal-close, [data-modal-close]');
        closeButtons.forEach(function(btn) {
            var handler = function(e) {
                e.preventDefault();
                closeCurrent();
            };
            btn.addEventListener('click', handler);
            boundCloseHandlers.push({ element: btn, handler: handler });
        });

        // Инициализация кнопок открытия
        var openButtons = document.querySelectorAll('[data-modal-open]');
        openButtons.forEach(function(btn) {
            var handler = function(e) {
                e.preventDefault();
                var modalId = btn.getAttribute('data-modal-open');
                if (modalId) {
                    open(modalId);
                }
            };
            btn.addEventListener('click', handler);
            boundOpenHandlers.push({ element: btn, handler: handler });
        });
    }

    /**
     * Очистка всех обработчиков событий (предотвращение утечек памяти)
     */
    function destroy() {
        // Закрываем текущий модал если открыт
        if (currentModal) {
            close();
        }

        // Удаляем обработчики кнопок закрытия
        boundCloseHandlers.forEach(function(item) {
            item.element.removeEventListener('click', item.handler);
        });
        boundCloseHandlers = [];

        // Удаляем обработчики кнопок открытия
        boundOpenHandlers.forEach(function(item) {
            item.element.removeEventListener('click', item.handler);
        });
        boundOpenHandlers = [];

        // Удаляем глобальные обработчики
        if (escapeHandlerBound) {
            document.removeEventListener('keydown', handleEscape);
            escapeHandlerBound = false;
        }
    }

    // Публичный API
    return {
        init: init,
        destroy: destroy,
        open: open,
        close: close,
        closeCurrent: closeCurrent,
        setTitle: setTitle,
        setButtonLoading: setButtonLoading,
        confirmDelete: confirmDelete
    };
})();

// Глобальные функции для совместимости
function openModal(modalId) {
    AdminModals.open(modalId);
}

function closeModal(modalId) {
    AdminModals.close(modalId);
}

// Экспорт
window.AdminModals = AdminModals;
window.openModal = openModal;
window.closeModal = closeModal;


// ============= image-upload.js =============

/**
 * Admin Image Upload Module
 * Загрузка и обработка изображений
 */

var AdminImageUpload = (function() {
    'use strict';

    var MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
    var ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];

    /**
     * Валидация файла
     */
    function validateFile(file) {
        if (!file) {
            return { valid: false, error: 'Файл не выбран' };
        }

        if (!ALLOWED_TYPES.includes(file.type)) {
            return { valid: false, error: 'Недопустимый формат. Разрешены: JPG, PNG, GIF, WebP' };
        }

        if (file.size > MAX_FILE_SIZE) {
            return { valid: false, error: 'Файл слишком большой. Максимум 10MB' };
        }

        return { valid: true };
    }

    /**
     * Преобразовать файл в base64
     */
    function fileToBase64(file) {
        return new Promise(function(resolve, reject) {
            var reader = new FileReader();
            reader.onload = function() {
                resolve(reader.result);
            };
            reader.onerror = function() {
                reject(new Error('Ошибка чтения файла'));
            };
            reader.readAsDataURL(file);
        });
    }

    /**
     * Загрузить файл на сервер
     */
    async function uploadFile(file) {
        // Валидация
        var validation = validateFile(file);
        if (!validation.valid) {
            throw new Error(validation.error);
        }

        // Преобразование в base64
        var base64 = await fileToBase64(file);

        // Загрузка на сервер
        var result = await AdminAPI.upload(base64);

        if (result.success) {
            return result;
        } else {
            throw new Error(result.error || 'Ошибка загрузки');
        }
    }

    /**
     * Удалить файл с сервера
     */
    async function deleteFile(url) {
        if (!url) return;

        // Извлекаем имя файла из URL
        var filename = url.split('/').pop();
        if (!filename) return;

        try {
            await AdminAPI.deleteFile(filename);
        } catch (error) {
            console.error('Error deleting file:', error);
        }
    }

    /**
     * Инициализация поля загрузки изображения
     */
    function initUploadField(inputId, previewId, options) {
        options = options || {};
        var input = document.getElementById(inputId);
        var preview = document.getElementById(previewId);

        if (!input) return;

        input.addEventListener('change', async function(e) {
            var file = e.target.files[0];
            if (!file) return;

            // Валидация
            var validation = validateFile(file);
            if (!validation.valid) {
                if (typeof showToast === 'function') {
                    showToast(validation.error, 'error');
                }
                input.value = '';
                return;
            }

            // Показать превью локально
            if (preview) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    if (preview.tagName === 'IMG') {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    } else {
                        preview.style.backgroundImage = 'url(' + e.target.result + ')';
                    }
                };
                reader.readAsDataURL(file);
            }

            // Callback
            if (typeof options.onChange === 'function') {
                options.onChange(file);
            }
        });
    }

    /**
     * Создать кнопку удаления для изображения
     */
    function createRemoveButton(container, onRemove) {
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-icon danger image-remove-btn';
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
        btn.title = 'Удалить изображение';

        btn.addEventListener('click', function(e) {
            e.preventDefault();
            if (typeof onRemove === 'function') {
                onRemove();
            }
        });

        container.appendChild(btn);
        return btn;
    }

    // Публичный API
    return {
        validateFile: validateFile,
        fileToBase64: fileToBase64,
        uploadFile: uploadFile,
        deleteFile: deleteFile,
        initUploadField: initUploadField,
        createRemoveButton: createRemoveButton,
        MAX_FILE_SIZE: MAX_FILE_SIZE,
        ALLOWED_TYPES: ALLOWED_TYPES
    };
})();

// Экспорт
window.AdminImageUpload = AdminImageUpload;


// ============= wysiwyg.js =============

/**
 * Admin WYSIWYG Editor Module
 * Улучшенный редактор с удобным интерфейсом
 */

var AdminWYSIWYG = (function() {
    'use strict';

    var editor = null;
    var toolbar = null;
    var savedRange = null;

    // Конфигурация DOMPurify для всех операций
    var PURIFY_CONFIG = {
        ALLOWED_TAGS: ['p', 'br', 'strong', 'b', 'em', 'i', 'u', 'a', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'blockquote', 'span', 'div', 'font'],
        ALLOWED_ATTR: ['href', 'target', 'class', 'style', 'color']
    };

    // Доступные цвета
    var COLORS = [
        { name: 'Зелёный', value: '#00ff88' },
        { name: 'Красный', value: '#ff4757' },
        { name: 'Синий', value: '#4d7cff' },
        { name: 'Жёлтый', value: '#ffd93d' },
        { name: 'Розовый', value: '#ff6b9d' },
        { name: 'Оранжевый', value: '#ff9f43' },
        { name: 'Белый', value: '#ffffff' }
    ];

    // =================================================================
    // SELECTION HELPERS
    // =================================================================

    /**
     * Сохранить текущее выделение
     */
    function saveSelection() {
        var sel = window.getSelection();
        if (sel.rangeCount > 0) {
            savedRange = sel.getRangeAt(0).cloneRange();
            return savedRange;
        }
        return null;
    }

    /**
     * Восстановить выделение
     */
    function restoreSelection() {
        if (savedRange) {
            var sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(savedRange);
            return true;
        }
        return false;
    }

    /**
     * Проверить, находится ли выделение внутри редактора
     */
    function isSelectionInEditor(editorEl) {
        editorEl = editorEl || editor;
        if (!editorEl) return false;

        var sel = window.getSelection();
        if (!sel.rangeCount) return false;

        var range = sel.getRangeAt(0);
        return editorEl.contains(range.commonAncestorContainer);
    }

    /**
     * Проверить, есть ли выделенный текст
     */
    function hasSelection() {
        var sel = window.getSelection();
        return sel.rangeCount > 0 && !sel.getRangeAt(0).collapsed;
    }

    // =================================================================
    // FORMATTING
    // =================================================================

    /**
     * Применить форматирование через execCommand (работает надёжнее)
     */
    function execFormat(command, value) {
        document.execCommand(command, false, value || null);
    }

    /**
     * Применить цвет к тексту
     */
    function applyColor(color) {
        if (!editor) return;

        restoreSelection();

        if (!hasSelection()) {
            showToast('Сначала выделите текст', 'warning');
            return;
        }

        // Используем execCommand для foreColor - самый надёжный способ
        document.execCommand('foreColor', false, color);

        // Скрываем палитру
        hideColorPicker();

        editor.focus();
    }

    /**
     * Удалить цвет с выделенного текста
     */
    function removeColor() {
        if (!editor) return;

        restoreSelection();

        // Удаляем цвет через removeFormat
        document.execCommand('removeFormat', false, null);

        hideColorPicker();
        editor.focus();
    }

    /**
     * Проверить, применён ли стиль к выделению
     */
    function isFormatApplied(tagName) {
        var sel = window.getSelection();
        if (!sel.rangeCount) return false;

        var container = sel.getRangeAt(0).commonAncestorContainer;
        var parent = container.nodeType === Node.TEXT_NODE ? container.parentNode : container;

        while (parent && parent !== editor) {
            if (parent.tagName && parent.tagName.toLowerCase() === tagName.toLowerCase()) {
                return true;
            }
            parent = parent.parentNode;
        }

        return false;
    }

    /**
     * Проверить, есть ли цвет на выделении
     */
    function hasColorApplied() {
        var sel = window.getSelection();
        if (!sel.rangeCount) return false;

        var container = sel.getRangeAt(0).commonAncestorContainer;
        var parent = container.nodeType === Node.TEXT_NODE ? container.parentNode : container;

        while (parent && parent !== editor) {
            if (parent.style && parent.style.color) {
                return parent.style.color;
            }
            if (parent.tagName === 'FONT' && parent.getAttribute('color')) {
                return parent.getAttribute('color');
            }
            parent = parent.parentNode;
        }

        return false;
    }

    // =================================================================
    // MAIN FORMAT FUNCTION
    // =================================================================

    /**
     * Форматирование выделенного текста
     */
    function formatText(command, value) {
        if (!editor) return;

        // Фокусируем редактор и восстанавливаем выделение
        editor.focus();
        restoreSelection();

        switch (command) {
            case 'bold':
                execFormat('bold');
                break;
            case 'italic':
                execFormat('italic');
                break;
            case 'underline':
                execFormat('underline');
                break;
            case 'strikeThrough':
                execFormat('strikeThrough');
                break;

            case 'h2':
                execFormat('formatBlock', '<h2>');
                break;
            case 'h3':
                execFormat('formatBlock', '<h3>');
                break;
            case 'p':
                execFormat('formatBlock', '<p>');
                break;
            case 'quote':
                execFormat('formatBlock', '<blockquote>');
                break;

            case 'ul':
                execFormat('insertUnorderedList');
                break;
            case 'ol':
                execFormat('insertOrderedList');
                break;

            case 'link':
                insertLink();
                break;
            case 'unlink':
                execFormat('unlink');
                break;

            case 'removeFormat':
                execFormat('removeFormat');
                break;

            case 'color':
                applyColor(value || '#00ff88');
                break;

            default:
                execFormat(command, value);
        }

        // Сохраняем новое выделение и обновляем тулбар
        saveSelection();
        updateToolbarState();
    }

    /**
     * Вставить ссылку
     */
    function insertLink() {
        var sel = window.getSelection();
        var selectedText = sel.toString();

        var url = prompt('Введите URL ссылки:', 'https://');
        if (!url || url === 'https://') return;

        restoreSelection();

        if (selectedText) {
            execFormat('createLink', url);
        } else {
            // Нет выделения - вставляем ссылку с URL как текстом
            var linkHtml = '<a href="' + url + '">' + url + '</a>';
            execFormat('insertHTML', linkHtml);
        }
    }

    // =================================================================
    // COLOR PICKER
    // =================================================================

    /**
     * Показать/скрыть палитру цветов
     */
    function toggleColorPicker(btn) {
        var picker = btn.querySelector('.color-picker-dropdown');

        if (picker) {
            // Уже есть - переключаем видимость
            picker.classList.toggle('visible');
        } else {
            // Создаём палитру
            picker = document.createElement('div');
            picker.className = 'color-picker-dropdown visible';

            var html = '<div class="color-picker-colors">';
            COLORS.forEach(function(c) {
                html += '<button type="button" class="color-swatch" data-color="' + c.value + '" title="' + c.name + '" style="background-color: ' + c.value + '"></button>';
            });
            html += '</div>';
            html += '<button type="button" class="color-remove-btn" data-color-remove>Убрать цвет</button>';

            picker.innerHTML = html;
            btn.appendChild(picker);

            // Обработчики клика на цвет
            picker.querySelectorAll('.color-swatch').forEach(function(swatch) {
                swatch.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                });
                swatch.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    var color = this.getAttribute('data-color');
                    applyColor(color);
                });
            });

            // Убрать цвет
            picker.querySelector('[data-color-remove]').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                removeColor();
            });
        }

        // Закрываем другие палитры
        document.querySelectorAll('.color-picker-dropdown.visible').forEach(function(p) {
            if (p !== picker) p.classList.remove('visible');
        });
    }

    /**
     * Скрыть все палитры цветов
     */
    function hideColorPicker() {
        document.querySelectorAll('.color-picker-dropdown').forEach(function(p) {
            p.classList.remove('visible');
        });
    }

    // =================================================================
    // TOOLBAR
    // =================================================================

    /**
     * Обновить состояние кнопок тулбара
     */
    function updateToolbarState() {
        if (!toolbar) return;

        var buttons = toolbar.querySelectorAll('.toolbar-btn');
        buttons.forEach(function(btn) {
            btn.classList.remove('active');
        });

        // Проверяем активные стили
        try {
            if (document.queryCommandState('bold')) {
                activateButton('bold');
            }
            if (document.queryCommandState('italic')) {
                activateButton('italic');
            }
            if (document.queryCommandState('underline')) {
                activateButton('underline');
            }
            if (document.queryCommandState('insertUnorderedList')) {
                activateButton('ul');
            }
            if (document.queryCommandState('insertOrderedList')) {
                activateButton('ol');
            }
        } catch (e) {
            // Fallback для браузеров без поддержки queryCommandState
        }

        // Проверяем блочное форматирование
        if (isFormatApplied('h2')) {
            activateButton('h2');
        }
        if (isFormatApplied('h3')) {
            activateButton('h3');
        }
        if (isFormatApplied('blockquote')) {
            activateButton('quote');
        }
        if (isFormatApplied('a')) {
            activateButton('link');
        }

        // Проверяем цвет
        var color = hasColorApplied();
        if (color) {
            var colorBtn = toolbar.querySelector('[data-command="showColorPicker"]');
            if (colorBtn) {
                colorBtn.classList.add('active');
            }
        }
    }

    /**
     * Активировать кнопку в тулбаре
     */
    function activateButton(command) {
        if (!toolbar) return;
        var btn = toolbar.querySelector('[data-command="' + command + '"]');
        if (btn) btn.classList.add('active');
    }

    /**
     * Инициализация тулбара
     */
    function initToolbar() {
        if (!toolbar) return;

        // Предотвращаем повторную инициализацию
        if (toolbar.dataset.initialized === 'true') {
            return;
        }
        toolbar.dataset.initialized = 'true';

        var buttons = toolbar.querySelectorAll('[data-command]');
        buttons.forEach(function(btn) {
            // Предотвращаем потерю фокуса при нажатии
            btn.addEventListener('mousedown', function(e) {
                e.preventDefault();
            });

            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                var command = this.getAttribute('data-command');
                var value = this.getAttribute('data-value');

                if (!editor) return;

                // Спецобработка для палитры цветов
                if (command === 'showColorPicker') {
                    toggleColorPicker(this);
                    return;
                }

                formatText(command, value);
                editor.focus();
            });
        });

        // Закрытие палитры при клике вне
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.toolbar-btn-color')) {
                hideColorPicker();
            }
        });
    }

    // =================================================================
    // INITIALIZATION
    // =================================================================

    /**
     * Обработка вставки - очистка форматирования
     */
    function handlePaste(e) {
        e.preventDefault();

        var text = '';
        if (e.clipboardData || window.clipboardData) {
            var html = (e.clipboardData || window.clipboardData).getData('text/html');
            if (html && typeof DOMPurify !== 'undefined') {
                text = DOMPurify.sanitize(html, PURIFY_CONFIG);
            } else {
                text = (e.clipboardData || window.clipboardData).getData('text/plain');
                text = text.replace(/\n/g, '<br>');
            }
        }

        document.execCommand('insertHTML', false, text);
    }

    /**
     * Инициализация редактора с тулбаром
     */
    function initWithToolbar(editorId) {
        var editorEl = typeof editorId === 'string' ? document.getElementById(editorId) : editorId;
        if (!editorEl) return;

        editor = editorEl;
        editorEl.setAttribute('contenteditable', 'true');

        // Находим тулбар
        var toolbarEl = editorEl.previousElementSibling;
        if (toolbarEl && toolbarEl.classList.contains('editor-toolbar')) {
            toolbar = toolbarEl;
            initToolbar();
        }

        // Сохраняем выделение при потере фокуса
        editorEl.addEventListener('blur', function() {
            saveSelection();
        });

        // При фокусе обновляем активный редактор
        editorEl.addEventListener('focus', function() {
            editor = editorEl;
            var nearToolbar = editorEl.previousElementSibling;
            if (nearToolbar && nearToolbar.classList.contains('editor-toolbar')) {
                toolbar = nearToolbar;
            }
        });

        // Обновляем состояние при изменениях
        editorEl.addEventListener('keyup', function() {
            saveSelection();
            updateToolbarState();
        });

        editorEl.addEventListener('mouseup', function() {
            saveSelection();
            updateToolbarState();
        });

        // Горячие клавиши
        editorEl.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key.toLowerCase()) {
                    case 'b':
                        e.preventDefault();
                        formatText('bold');
                        break;
                    case 'i':
                        e.preventDefault();
                        formatText('italic');
                        break;
                    case 'u':
                        e.preventDefault();
                        formatText('underline');
                        break;
                }
            }
        });

        // Обработка вставки
        editorEl.addEventListener('paste', handlePaste);
    }

    /**
     * Получить HTML контент редактора
     */
    function getContent(editorId) {
        var editorEl;

        if (editorId) {
            editorEl = typeof editorId === 'string' ? document.getElementById(editorId) : editorId;
        } else {
            editorEl = editor;
        }

        if (!editorEl) return '';

        var content = editorEl.innerHTML;

        // Очищаем через DOMPurify если доступен
        if (typeof DOMPurify !== 'undefined') {
            content = DOMPurify.sanitize(content, PURIFY_CONFIG);
        }

        return content;
    }

    /**
     * Установить HTML контент редактора
     */
    function setContent(html, editorId) {
        var editorEl;

        if (editorId) {
            editorEl = typeof editorId === 'string' ? document.getElementById(editorId) : editorId;
        } else {
            editorEl = editor;
        }

        if (!editorEl) return;

        // Очищаем через DOMPurify если доступен
        if (typeof DOMPurify !== 'undefined') {
            html = DOMPurify.sanitize(html, PURIFY_CONFIG);
        }

        editorEl.innerHTML = html || '';
    }

    /**
     * Очистить редактор
     */
    function clear() {
        if (editor) {
            editor.innerHTML = '';
        }
    }

    /**
     * Получить текущий редактор
     */
    function getEditor() {
        return editor;
    }

    // =================================================================
    // HTML GENERATORS
    // =================================================================

    /**
     * Генерировать HTML тулбара
     */
    function getToolbarHTML() {
        return '<div class="editor-toolbar">' +
            '<button type="button" class="toolbar-btn" data-command="bold" title="Жирный (Ctrl+B)"><strong>B</strong></button>' +
            '<button type="button" class="toolbar-btn" data-command="italic" title="Курсив (Ctrl+I)"><em>I</em></button>' +
            '<button type="button" class="toolbar-btn" data-command="underline" title="Подчёркнутый (Ctrl+U)"><u>U</u></button>' +
            '<span class="toolbar-divider"></span>' +
            '<button type="button" class="toolbar-btn" data-command="h2" title="Заголовок H2">H2</button>' +
            '<button type="button" class="toolbar-btn" data-command="h3" title="Подзаголовок H3">H3</button>' +
            '<button type="button" class="toolbar-btn" data-command="p" title="Обычный текст">P</button>' +
            '<span class="toolbar-divider"></span>' +
            '<button type="button" class="toolbar-btn" data-command="ul" title="Маркированный список">' +
                '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="9" y1="6" x2="20" y2="6"/><line x1="9" y1="12" x2="20" y2="12"/><line x1="9" y1="18" x2="20" y2="18"/><circle cx="4" cy="6" r="1.5" fill="currentColor"/><circle cx="4" cy="12" r="1.5" fill="currentColor"/><circle cx="4" cy="18" r="1.5" fill="currentColor"/></svg>' +
            '</button>' +
            '<button type="button" class="toolbar-btn" data-command="ol" title="Нумерованный список">' +
                '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="10" y1="6" x2="20" y2="6"/><line x1="10" y1="12" x2="20" y2="12"/><line x1="10" y1="18" x2="20" y2="18"/><text x="4" y="8" font-size="8" fill="currentColor">1</text><text x="4" y="14" font-size="8" fill="currentColor">2</text><text x="4" y="20" font-size="8" fill="currentColor">3</text></svg>' +
            '</button>' +
            '<span class="toolbar-divider"></span>' +
            '<button type="button" class="toolbar-btn" data-command="link" title="Вставить ссылку">' +
                '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>' +
            '</button>' +
            '<button type="button" class="toolbar-btn" data-command="quote" title="Цитата">' +
                '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 17h3l2-4V7H5v6h3zm8 0h3l2-4V7h-6v6h3z"/></svg>' +
            '</button>' +
            '<span class="toolbar-divider"></span>' +
            '<button type="button" class="toolbar-btn toolbar-btn-color" data-command="showColorPicker" title="Цвет текста">' +
                '<span class="color-indicator">A</span>' +
            '</button>' +
            '<button type="button" class="toolbar-btn" data-command="removeFormat" title="Очистить форматирование">' +
                '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>' +
            '</button>' +
        '</div>';
    }

    /**
     * Генерировать HTML редактора с тулбаром
     */
    function getEditorHTML(id, content, placeholder) {
        return getToolbarHTML() +
            '<div class="wysiwyg-editor" id="' + id + '" contenteditable="true" data-placeholder="' + (placeholder || 'Начните писать...') + '">' +
                (content || '') +
            '</div>';
    }

    // Legacy init function
    function init(editorId, toolbarId) {
        editor = typeof editorId === 'string' ? document.getElementById(editorId) : editorId;
        toolbar = typeof toolbarId === 'string' ? document.getElementById(toolbarId) : toolbarId;

        if (!editor) {
            return;
        }

        editor.setAttribute('contenteditable', 'true');

        if (toolbar) {
            initToolbar();
        }

        editor.addEventListener('paste', handlePaste);
        editor.addEventListener('keyup', function() {
            saveSelection();
            updateToolbarState();
        });
        editor.addEventListener('mouseup', function() {
            saveSelection();
            updateToolbarState();
        });
    }

    // Публичный API
    return {
        init: init,
        initWithToolbar: initWithToolbar,
        formatText: formatText,
        insertLink: insertLink,
        getContent: getContent,
        setContent: setContent,
        clear: clear,
        getEditor: getEditor,
        updateToolbarState: updateToolbarState,
        getToolbarHTML: getToolbarHTML,
        getEditorHTML: getEditorHTML,
        isFormatApplied: isFormatApplied,
        saveSelection: saveSelection,
        restoreSelection: restoreSelection
    };
})();

// Экспорт
window.AdminWYSIWYG = AdminWYSIWYG;


// ============= dragdrop.js =============

/**
 * Admin Drag & Drop Module
 * Универсальный модуль для сортировки элементов перетаскиванием
 */
var AdminDragDrop = (function() {
    'use strict';

    var draggedItem = null;
    var draggedIndex = -1;
    var containers = {};
    var currentDragOver = null; // Кэш текущего drag-over элемента для производительности

    /**
     * Инициализация drag & drop для контейнера
     * @param {string} containerId - ID контейнера
     * @param {string} itemSelector - CSS селектор элементов
     * @param {function} onReorder - Callback при изменении порядка (newOrder: string[])
     */
    function init(containerId, itemSelector, onReorder) {
        var container = document.getElementById(containerId);
        if (!container) return;

        // Сохраняем конфигурацию
        containers[containerId] = {
            selector: itemSelector,
            onReorder: onReorder
        };

        // Добавляем обработчики событий через делегирование
        container.addEventListener('dragstart', handleDragStart);
        container.addEventListener('dragend', handleDragEnd);
        container.addEventListener('dragover', handleDragOver);
        container.addEventListener('dragleave', handleDragLeave);
        container.addEventListener('drop', handleDrop);
    }

    /**
     * Обновить draggable атрибуты после рендера
     */
    function refresh(containerId) {
        var config = containers[containerId];
        if (!config) return;

        var container = document.getElementById(containerId);
        if (!container) return;

        var items = container.querySelectorAll(config.selector);
        items.forEach(function(item, index) {
            item.setAttribute('draggable', 'true');
            item.dataset.index = index;
        });
    }

    /**
     * Добавить drag handle к элементу
     */
    function addDragHandle(element) {
        if (element.querySelector('.drag-handle')) return;

        var handle = document.createElement('div');
        handle.className = 'drag-handle';
        handle.innerHTML = window.SharedIcons ? window.SharedIcons.get('grip') :
            '<svg viewBox="0 0 24 24" fill="currentColor"><circle cx="9" cy="6" r="1.5"/><circle cx="15" cy="6" r="1.5"/><circle cx="9" cy="12" r="1.5"/><circle cx="15" cy="12" r="1.5"/><circle cx="9" cy="18" r="1.5"/><circle cx="15" cy="18" r="1.5"/></svg>';
        handle.title = 'Перетащите для изменения порядка';

        // Вставляем в начало элемента
        element.insertBefore(handle, element.firstChild);
    }

    function handleDragStart(e) {
        var item = e.target.closest('[draggable="true"]');
        if (!item) return;

        draggedItem = item;
        draggedIndex = parseInt(item.dataset.index, 10);

        // Добавляем класс с небольшой задержкой для анимации
        setTimeout(function() {
            if (draggedItem) {
                draggedItem.classList.add('dragging');
            }
        }, 0);

        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', draggedIndex.toString());
    }

    function handleDragEnd(e) {
        if (draggedItem) {
            draggedItem.classList.remove('dragging');
        }

        // Очищаем кэшированный drag-over элемент (без querySelectorAll)
        if (currentDragOver) {
            currentDragOver.classList.remove('drag-over');
            currentDragOver = null;
        }

        draggedItem = null;
        draggedIndex = -1;
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';

        var item = e.target.closest('[draggable="true"]');
        if (!item || item === draggedItem) return;

        // Используем кэш вместо querySelectorAll для производительности
        if (currentDragOver && currentDragOver !== item) {
            currentDragOver.classList.remove('drag-over');
        }

        if (item !== currentDragOver) {
            item.classList.add('drag-over');
            currentDragOver = item;
        }
    }

    function handleDragLeave(e) {
        var item = e.target.closest('[draggable="true"]');
        if (item && !item.contains(e.relatedTarget)) {
            item.classList.remove('drag-over');
        }
    }

    function handleDrop(e) {
        e.preventDefault();

        var targetItem = e.target.closest('[draggable="true"]');
        if (!targetItem || targetItem === draggedItem || !draggedItem) return;

        var container = targetItem.parentElement;
        var containerId = container.id;
        var config = containers[containerId];

        if (!config) return;

        var targetIndex = parseInt(targetItem.dataset.index, 10);

        // Перемещаем элемент в DOM
        if (draggedIndex < targetIndex) {
            container.insertBefore(draggedItem, targetItem.nextSibling);
        } else {
            container.insertBefore(draggedItem, targetItem);
        }

        // Обновляем индексы
        var items = container.querySelectorAll(config.selector);
        items.forEach(function(item, index) {
            item.dataset.index = index;
        });

        // Собираем новый порядок ID
        var newOrder = [];
        items.forEach(function(item) {
            var id = item.dataset.id;
            if (id) {
                newOrder.push(id);
            }
        });

        // Убираем класс drag-over и очищаем кэш
        targetItem.classList.remove('drag-over');
        currentDragOver = null;

        // Вызываем callback
        if (config.onReorder && newOrder.length > 0) {
            config.onReorder(newOrder);
        }
    }

    /**
     * Удалить обработчики для контейнера
     */
    function destroy(containerId) {
        var container = document.getElementById(containerId);
        if (container) {
            container.removeEventListener('dragstart', handleDragStart);
            container.removeEventListener('dragend', handleDragEnd);
            container.removeEventListener('dragover', handleDragOver);
            container.removeEventListener('dragleave', handleDragLeave);
            container.removeEventListener('drop', handleDrop);
        }
        delete containers[containerId];
    }

    // Публичный API
    return {
        init: init,
        refresh: refresh,
        addDragHandle: addDragHandle,
        destroy: destroy
    };
})();

// Экспорт
window.AdminDragDrop = AdminDragDrop;


// ============= validation.js =============

/**
 * Admin Form Validation Module
 * Валидация форм перед отправкой
 */
var AdminValidation = (function() {
    'use strict';

    /**
     * Правила валидации
     */
    var rules = {
        required: function(value) {
            return value !== null && value !== undefined && String(value).trim() !== '';
        },
        minLength: function(value, min) {
            return String(value).trim().length >= min;
        },
        maxLength: function(value, max) {
            return String(value).trim().length <= max;
        },
        email: function(value) {
            var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return !value || emailRegex.test(value);
        },
        url: function(value) {
            if (!value) return true;
            try {
                new URL(value);
                return true;
            } catch (e) {
                return false;
            }
        },
        number: function(value) {
            return !value || !isNaN(parseFloat(value));
        },
        positiveNumber: function(value) {
            return !value || (parseFloat(value) >= 0);
        }
    };

    /**
     * Сообщения об ошибках
     */
    var messages = {
        required: 'Это поле обязательно для заполнения',
        minLength: 'Минимальная длина: {0} символов',
        maxLength: 'Максимальная длина: {0} символов',
        email: 'Введите корректный email',
        url: 'Введите корректный URL',
        number: 'Введите число',
        positiveNumber: 'Число должно быть положительным'
    };

    /**
     * Валидация поля
     * @param {string} fieldId - ID поля
     * @param {Array} fieldRules - Массив правил [{rule: 'required'}, {rule: 'minLength', value: 3}]
     * @returns {Object} {valid: boolean, error: string|null}
     */
    function validateField(fieldId, fieldRules) {
        var field = document.getElementById(fieldId);
        if (!field) return { valid: true, error: null };

        var value = field.value;

        for (var i = 0; i < fieldRules.length; i++) {
            var ruleConfig = fieldRules[i];
            var ruleName = ruleConfig.rule;
            var ruleValue = ruleConfig.value;
            var customMessage = ruleConfig.message;

            if (rules[ruleName]) {
                var isValid = rules[ruleName](value, ruleValue);
                if (!isValid) {
                    var errorMessage = customMessage || messages[ruleName];
                    if (errorMessage && ruleValue !== undefined) {
                        errorMessage = errorMessage.replace('{0}', ruleValue);
                    }
                    return { valid: false, error: errorMessage };
                }
            }
        }

        return { valid: true, error: null };
    }

    /**
     * Валидация формы
     * @param {Object} fieldsConfig - Конфигурация полей {fieldId: [{rule: 'required'}]}
     * @returns {Object} {valid: boolean, errors: {fieldId: string}}
     */
    function validateForm(fieldsConfig) {
        var errors = {};
        var isValid = true;

        Object.keys(fieldsConfig).forEach(function(fieldId) {
            var result = validateField(fieldId, fieldsConfig[fieldId]);
            if (!result.valid) {
                errors[fieldId] = result.error;
                isValid = false;
            }
        });

        return { valid: isValid, errors: errors };
    }

    /**
     * Показать ошибку для поля
     */
    function showFieldError(fieldId, message) {
        var field = document.getElementById(fieldId);
        if (!field) return;

        // Добавляем класс ошибки
        field.classList.add('form-input-error');

        // Удаляем старое сообщение об ошибке
        var existingError = field.parentElement.querySelector('.form-error-message');
        if (existingError) {
            existingError.remove();
        }

        // Добавляем новое сообщение
        if (message) {
            var errorEl = document.createElement('div');
            errorEl.className = 'form-error-message';
            errorEl.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>' + window.escapeHtml(message);
            field.parentElement.appendChild(errorEl);
        }
    }

    /**
     * Убрать ошибку с поля
     */
    function clearFieldError(fieldId) {
        var field = document.getElementById(fieldId);
        if (!field) return;

        field.classList.remove('form-input-error');

        var existingError = field.parentElement.querySelector('.form-error-message');
        if (existingError) {
            existingError.remove();
        }
    }

    /**
     * Показать все ошибки формы
     */
    function showFormErrors(errors) {
        Object.keys(errors).forEach(function(fieldId) {
            showFieldError(fieldId, errors[fieldId]);
        });

        // Фокус на первое поле с ошибкой
        var firstErrorField = Object.keys(errors)[0];
        if (firstErrorField) {
            var field = document.getElementById(firstErrorField);
            if (field) {
                field.focus();
                field.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    }

    /**
     * Очистить все ошибки формы
     */
    function clearFormErrors(fieldsConfig) {
        Object.keys(fieldsConfig).forEach(function(fieldId) {
            clearFieldError(fieldId);
        });
    }

    /**
     * Валидация и показ ошибок
     * @returns {boolean} - Форма валидна?
     */
    function validate(fieldsConfig) {
        // Сначала очищаем старые ошибки
        clearFormErrors(fieldsConfig);

        // Валидируем
        var result = validateForm(fieldsConfig);

        // Показываем ошибки если есть
        if (!result.valid) {
            showFormErrors(result.errors);

            // Показываем toast с первой ошибкой
            var firstError = Object.values(result.errors)[0];
            if (firstError && window.showToast) {
                window.showToast(firstError, 'error');
            }
        }

        return result.valid;
    }

    /**
     * Добавить live валидацию к полю
     */
    function addLiveValidation(fieldId, fieldRules) {
        var field = document.getElementById(fieldId);
        if (!field) return;

        field.addEventListener('blur', function() {
            var result = validateField(fieldId, fieldRules);
            if (!result.valid) {
                showFieldError(fieldId, result.error);
            } else {
                clearFieldError(fieldId);
            }
        });

        field.addEventListener('input', function() {
            // Убираем ошибку при вводе
            clearFieldError(fieldId);
        });
    }

    // Публичный API
    return {
        validate: validate,
        validateForm: validateForm,
        validateField: validateField,
        showFieldError: showFieldError,
        clearFieldError: clearFieldError,
        showFormErrors: showFormErrors,
        clearFormErrors: clearFormErrors,
        addLiveValidation: addLiveValidation,
        rules: rules,
        messages: messages
    };
})();

// Экспорт
window.AdminValidation = AdminValidation;


// ============= search.js =============

/**
 * Admin Search Module
 * Поиск и фильтрация элементов в списках
 */
var AdminSearch = (function() {
    'use strict';

    var searchConfigs = {};
    var debounceTimers = {};

    /**
     * Инициализация поиска
     * @param {string} inputId - ID поля ввода
     * @param {string} containerId - ID контейнера с элементами
     * @param {Object} options - Настройки
     * @param {string} options.itemSelector - CSS селектор элементов
     * @param {string} options.searchAttribute - Атрибут для поиска (по умолчанию data-search)
     * @param {function} options.onFilter - Callback при фильтрации
     * @param {number} options.debounce - Задержка в мс (по умолчанию 200)
     */
    function init(inputId, containerId, options) {
        var input = document.getElementById(inputId);
        if (!input) return;

        options = options || {};

        var config = {
            containerId: containerId,
            itemSelector: options.itemSelector || '[data-id]',
            searchAttribute: options.searchAttribute || 'data-search',
            onFilter: options.onFilter,
            debounce: options.debounce || 200
        };

        searchConfigs[inputId] = config;

        // Обработчик ввода
        input.addEventListener('input', function() {
            handleInput(inputId, input.value);
        });

        // Кнопка очистки
        var searchBox = input.closest('.search-box');
        if (searchBox) {
            var clearBtn = searchBox.querySelector('.search-clear');
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    input.value = '';
                    handleInput(inputId, '');
                    input.focus();
                });
            }

            // Обновляем состояние кнопки очистки
            updateClearButton(searchBox, input.value);
        }
    }

    /**
     * Обработка ввода с debounce
     */
    function handleInput(inputId, value) {
        var config = searchConfigs[inputId];
        if (!config) return;

        // Обновляем кнопку очистки
        var input = document.getElementById(inputId);
        var searchBox = input ? input.closest('.search-box') : null;
        if (searchBox) {
            updateClearButton(searchBox, value);
        }

        // Debounce
        if (debounceTimers[inputId]) {
            clearTimeout(debounceTimers[inputId]);
        }

        debounceTimers[inputId] = setTimeout(function() {
            filterItems(config, value);
        }, config.debounce);
    }

    /**
     * Обновить состояние кнопки очистки
     */
    function updateClearButton(searchBox, value) {
        if (value && value.trim()) {
            searchBox.classList.add('has-value');
        } else {
            searchBox.classList.remove('has-value');
        }
    }

    /**
     * Фильтрация элементов
     */
    function filterItems(config, query) {
        var container = document.getElementById(config.containerId);
        if (!container) return;

        query = query.toLowerCase().trim();
        var items = container.querySelectorAll(config.itemSelector);
        var visibleCount = 0;
        var totalCount = items.length;

        items.forEach(function(item) {
            // Пропускаем сообщения о пустом списке
            if (item.classList.contains('empty-message') || item.classList.contains('empty-state')) {
                return;
            }

            var searchText = '';

            // Получаем текст для поиска
            if (item.hasAttribute(config.searchAttribute)) {
                searchText = item.getAttribute(config.searchAttribute);
            } else {
                searchText = item.textContent;
            }

            searchText = searchText.toLowerCase();

            var matches = !query || searchText.includes(query);

            if (matches) {
                item.style.display = '';
                item.classList.remove('search-hidden');
                visibleCount++;
            } else {
                item.style.display = 'none';
                item.classList.add('search-hidden');
            }
        });

        // Показываем сообщение если ничего не найдено
        updateEmptyMessage(container, visibleCount, query);

        // Вызываем callback
        if (config.onFilter) {
            config.onFilter({
                query: query,
                visible: visibleCount,
                total: totalCount
            });
        }
    }

    /**
     * Показать/скрыть сообщение о пустом результате
     */
    function updateEmptyMessage(container, visibleCount, query) {
        var emptyMessage = container.querySelector('.search-empty-message');

        if (visibleCount === 0 && query) {
            if (!emptyMessage) {
                emptyMessage = document.createElement('div');
                emptyMessage.className = 'empty-message search-empty-message';
                container.appendChild(emptyMessage);
            }
            emptyMessage.textContent = 'По запросу "' + query + '" ничего не найдено';
            emptyMessage.style.display = '';
        } else if (emptyMessage) {
            emptyMessage.style.display = 'none';
        }
    }

    /**
     * Очистить поиск
     */
    function clear(inputId) {
        var input = document.getElementById(inputId);
        if (input) {
            input.value = '';
            handleInput(inputId, '');
        }
    }

    /**
     * Обновить поиск (после изменения данных)
     */
    function refresh(inputId) {
        var input = document.getElementById(inputId);
        if (input && searchConfigs[inputId]) {
            filterItems(searchConfigs[inputId], input.value);
        }
    }

    /**
     * Уничтожить поиск
     */
    function destroy(inputId) {
        if (debounceTimers[inputId]) {
            clearTimeout(debounceTimers[inputId]);
        }
        delete searchConfigs[inputId];
        delete debounceTimers[inputId];
    }

    // Публичный API
    return {
        init: init,
        clear: clear,
        refresh: refresh,
        destroy: destroy
    };
})();

// Экспорт
window.AdminSearch = AdminSearch;


// ============= renderers/stats.js =============

/**
 * Admin Stats Renderer
 * Рендеринг статистики посещений
 */

var AdminStatsRenderer = (function() {
    'use strict';

    var elements = {};

    /**
     * Инициализация элементов
     */
    function init() {
        elements = {
            totalViews: document.getElementById('statTotalViews'),
            todayViews: document.getElementById('statTodayViews'),
            weekViews: document.getElementById('statWeekViews'),
            uniqueVisitors: document.getElementById('statUniqueVisitors'),
            topSections: document.getElementById('pagesStatsList'),
            chartCanvas: document.getElementById('statsChart')
        };
    }

    /**
     * Рендеринг статистики
     */
    function render(stats) {
        if (!stats) return;

        // Основные метрики
        if (elements.totalViews) {
            elements.totalViews.textContent = formatNumber(stats.total_views || 0);
        }
        if (elements.todayViews) {
            elements.todayViews.textContent = formatNumber(stats.today_views || 0);
        }
        if (elements.weekViews) {
            elements.weekViews.textContent = formatNumber(stats.week_views || 0);
        }
        if (elements.uniqueVisitors) {
            elements.uniqueVisitors.textContent = formatNumber(stats.unique_visitors || 0);
        }

        // Топ секций
        if (elements.topSections && stats.sections) {
            renderTopSections(stats.sections);
        }

        // График
        if (elements.chartCanvas && stats.chart_data) {
            renderChart(stats.chart_data);
        }
    }

    /**
     * Рендеринг топ секций
     */
    function renderTopSections(sections) {
        var sectionNames = {
            'hero': 'Главная',
            'services': 'Услуги',
            'masters': 'Мастера',
            'quality': 'Качество',
            'blog': 'Блог',
            'faq': 'FAQ',
            'booking': 'Запись',
            'podology': 'Подология',
            'location': 'Контакты',
            'social': 'Соцсети'
        };

        var sortedSections = Object.entries(sections)
            .sort(function(a, b) { return b[1] - a[1]; })
            .slice(0, 6);

        if (sortedSections.length === 0) {
            elements.topSections.innerHTML = '<p class="empty-message">Нет данных</p>';
            return;
        }

        var maxViews = sortedSections[0][1];

        var html = sortedSections.map(function(item, index) {
            var key = item[0];
            var views = item[1];
            var name = sectionNames[key] || key;
            var percent = maxViews > 0 ? Math.round((views / maxViews) * 100) : 0;

            return '<div class="page-stat-row">' +
                '<span class="page-stat-name">' + escapeHtml(name) + '</span>' +
                '<div class="page-stat-bar-wrap">' +
                    '<div class="page-stat-bar" style="width: ' + percent + '%"></div>' +
                '</div>' +
                '<span class="page-stat-count">' + views + '</span>' +
            '</div>';
        }).join('');

        elements.topSections.innerHTML = html;
    }

    /**
     * Рендеринг графика (простая реализация без библиотек)
     */
    function renderChart(chartData) {
        var canvas = elements.chartCanvas;
        if (!canvas || !canvas.getContext) return;

        // Устанавливаем размеры canvas на основе родительского контейнера
        var wrapper = canvas.parentElement;
        if (wrapper) {
            var rect = wrapper.getBoundingClientRect();
            var dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
        }

        var ctx = canvas.getContext('2d');
        var dpr = window.devicePixelRatio || 1;
        ctx.scale(dpr, dpr);

        var width = canvas.width / dpr;
        var height = canvas.height / dpr;
        var padding = 50;
        var paddingBottom = 30;

        // Очистка
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (!chartData || chartData.length === 0) {
            // Показываем сообщение если нет данных
            ctx.fillStyle = '#666';
            ctx.font = '14px Manrope, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Нет данных для отображения', width / 2, height / 2);
            return;
        }

        // Находим максимальное значение (с защитой от пустого массива)
        var views = chartData.map(function(d) { return d.views || 0; });
        var maxViews = views.length > 0 ? Math.max.apply(null, views) : 0;
        if (maxViews === 0) maxViews = 1;

        var chartWidth = width - padding - 20;
        var chartHeight = height - padding - paddingBottom;
        var barWidth = chartWidth / chartData.length;
        var barGap = 4;

        // Рисуем линии сетки
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
        ctx.lineWidth = 1;
        for (var i = 0; i <= 4; i++) {
            var y = padding + (chartHeight / 4) * i;
            ctx.beginPath();
            ctx.moveTo(padding, y);
            ctx.lineTo(width - 20, y);
            ctx.stroke();
        }

        // Подписи оси Y
        ctx.fillStyle = '#666';
        ctx.font = '11px Manrope, sans-serif';
        ctx.textAlign = 'right';
        for (var i = 0; i <= 4; i++) {
            var value = Math.round(maxViews * (4 - i) / 4);
            var y = padding + (chartHeight / 4) * i;
            ctx.fillText(formatNumber(value), padding - 10, y + 4);
        }

        // Рисуем бары с градиентом
        chartData.forEach(function(data, index) {
            var barHeight = Math.max(2, (data.views / maxViews) * chartHeight);
            var x = padding + index * barWidth + barGap;
            var y = height - paddingBottom - barHeight;
            var w = barWidth - barGap * 2;

            // Градиент для бара
            var gradient = ctx.createLinearGradient(x, y, x, y + barHeight);
            gradient.addColorStop(0, '#00ff88');
            gradient.addColorStop(1, 'rgba(0, 255, 136, 0.4)');
            ctx.fillStyle = gradient;

            // Скругленные углы сверху
            var radius = Math.min(4, w / 2);
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + w - radius, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + radius);
            ctx.lineTo(x + w, y + barHeight);
            ctx.lineTo(x, y + barHeight);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.fill();

            // Значение над баром
            if (data.views > 0) {
                ctx.fillStyle = '#fff';
                ctx.font = '10px Manrope, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(data.views, x + w / 2, y - 6);
            }
        });

        // Подписи дат
        ctx.fillStyle = '#888';
        ctx.font = '10px Manrope, sans-serif';
        ctx.textAlign = 'center';

        chartData.forEach(function(data, index) {
            var x = padding + index * barWidth + barWidth / 2;
            var date = new Date(data.date);
            var label = date.getDate() + '/' + (date.getMonth() + 1);

            // Показываем каждую дату или через одну если много баров
            if (chartData.length <= 7 || index % 2 === 0) {
                ctx.fillText(label, x, height - 10);
            }
        });
    }

    /**
     * Форматирование числа
     */
    function formatNumber(num) {
        if (num >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
        }
        if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }
        return String(num);
    }

    /**
     * Escape HTML
     */
    function escapeHtml(text) {
        if (typeof window.escapeHtml === 'function') {
            return window.escapeHtml(text);
        }
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Публичный API
    return {
        init: init,
        render: render
    };
})();

// Экспорт
window.AdminStatsRenderer = AdminStatsRenderer;


// ============= renderers/masters.js =============

/**
 * Admin Masters Renderer
 * Рендеринг списка мастеров с поддержкой drag & drop
 */

var AdminMastersRenderer = (function() {
    'use strict';

    var container = null;
    var dragDropInitialized = false;

    /**
     * Инициализация
     */
    function init() {
        container = document.getElementById('mastersGrid');
        initDragDrop();
    }

    /**
     * Инициализация drag & drop
     */
    function initDragDrop() {
        if (dragDropInitialized || !window.AdminDragDrop) return;

        AdminDragDrop.init('mastersGrid', '.master-card', function(newOrder) {
            reorderMasters(newOrder);
        });

        dragDropInitialized = true;
    }

    /**
     * Изменение порядка мастеров
     */
    function reorderMasters(newOrder) {
        var masters = AdminState.masters || [];

        // Создаём новый порядок
        var reordered = newOrder.map(function(id) {
            return masters.find(function(m) { return m.id === id; });
        }).filter(Boolean);

        // Добавляем поле order
        reordered.forEach(function(master, index) {
            master.order = index;
        });

        // Сохраняем
        AdminAPI.save('masters', { masters: reordered })
            .then(function() {
                AdminState.setMasters(reordered);
                if (window.showToast) {
                    showToast('Порядок сохранён', 'success');
                }
            })
            .catch(function(error) {
                if (window.showToast) {
                    showToast('Ошибка сохранения порядка', 'error');
                }
                render(); // Откат
            });
    }

    /**
     * Получить название уровня мастера
     */
    function getBadgeLabel(badge) {
        var labels = {
            'green': 'Green',
            'pink': 'Pink',
            'blue': 'Dark Blue'
        };
        return labels[badge] || 'Green';
    }

    /**
     * Рендеринг списка мастеров
     */
    function render() {
        if (!container) {
            container = document.getElementById('mastersGrid');
            if (!container) return;
        }

        var masters = AdminState.masters || [];

        if (masters.length === 0) {
            container.innerHTML = '<p class="empty-message">Нет мастеров. Нажмите "Добавить" чтобы создать.</p>';
            return;
        }

        var html = masters.map(function(master, index) {
            var photoHtml = master.photo
                ? '<img src="' + master.photo + '" alt="' + window.escapeHtml(master.name) + '">'
                : (master.initial || master.name.charAt(0));

            var searchText = [master.name, master.role, master.specialization].join(' ');

            return '<div class="master-card has-drag" data-id="' + master.id + '" data-index="' + index + '" data-search="' + window.escapeHtml(searchText) + '" draggable="true">' +
                '<div class="master-card-header">' +
                    '<div class="master-avatar ' + (master.photo ? 'has-photo' : '') + '">' +
                        photoHtml +
                    '</div>' +
                    '<div class="master-info">' +
                        '<h3 class="master-name">' + window.escapeHtml(master.name) + '</h3>' +
                        '<div class="master-role">' + window.escapeHtml(master.role || 'Мастер') + '</div>' +
                        '<span class="master-badge badge-' + (master.badge || 'green') + '">' + getBadgeLabel(master.badge) + '</span>' +
                    '</div>' +
                '</div>' +
                '<p class="master-specialization">' + window.escapeHtml(master.specialization || '') + '</p>' +
                '<div class="master-card-actions">' +
                    '<button class="btn btn-secondary" data-action="edit-master" data-id="' + master.id + '">' +
                        SharedIcons.get('edit') +
                        'Редактировать' +
                    '</button>' +
                    '<button class="btn btn-icon danger" data-action="delete-master" data-id="' + master.id + '" data-name="' + window.escapeHtml(master.name) + '" title="Удалить">' +
                        SharedIcons.get('delete') +
                    '</button>' +
                '</div>' +
                '<div class="drag-handle" title="Перетащите для изменения порядка">' + SharedIcons.get('grip') + '</div>' +
            '</div>';
        }).join('');

        container.innerHTML = html;

        // Обновляем drag & drop после рендера
        if (window.AdminDragDrop) {
            AdminDragDrop.refresh('mastersGrid');
        }
    }

    // Публичный API
    return {
        init: init,
        render: render,
        getBadgeLabel: getBadgeLabel,
        reorderMasters: reorderMasters
    };
})();

// Экспорт
window.AdminMastersRenderer = AdminMastersRenderer;


// ============= renderers/services.js =============

/**
 * Admin Services Renderer
 * Рендеринг списка услуг с поддержкой drag & drop
 */

var AdminServicesRenderer = (function() {
    'use strict';

    var servicesList = null;
    var podologyList = null;
    var dragDropInitialized = {};

    /**
     * Инициализация
     */
    function init() {
        servicesList = document.getElementById('servicesList');
        podologyList = document.getElementById('podologyList');
        initDragDrop();
    }

    /**
     * Инициализация drag & drop для услуг
     */
    function initDragDrop() {
        if (!window.AdminDragDrop) return;

        if (!dragDropInitialized.services) {
            AdminDragDrop.init('servicesList', '.service-item', function(newOrder) {
                reorderServices(newOrder);
            });
            dragDropInitialized.services = true;
        }

        if (!dragDropInitialized.podology) {
            AdminDragDrop.init('podologyList', '.service-item', function(newOrder) {
                reorderPodology(newOrder);
            });
            dragDropInitialized.podology = true;
        }
    }

    /**
     * Изменение порядка услуг в категории
     */
    function reorderServices(newOrder) {
        var currentCategory = AdminState.currentCategory || 'main';
        var services = AdminState.services || {};

        if (!services.categories) return;

        var categoryIndex = services.categories.findIndex(function(c) {
            return c.id === currentCategory;
        });

        if (categoryIndex === -1) return;

        var category = services.categories[categoryIndex];
        var reordered = newOrder.map(function(id) {
            return category.services.find(function(s) { return String(s.id) === String(id); });
        }).filter(Boolean);

        services.categories[categoryIndex].services = reordered;

        AdminAPI.save('services', services)
            .then(function() {
                AdminState.setServices(services);
                if (window.showToast) {
                    showToast('Порядок сохранён', 'success');
                }
            })
            .catch(function(error) {
                if (window.showToast) {
                    showToast('Ошибка сохранения порядка', 'error');
                }
                render();
            });
    }

    /**
     * Изменение порядка услуг подологии
     */
    function reorderPodology(newOrder) {
        var services = AdminState.services || {};

        if (!services.podology || !services.podology.services) return;

        var reordered = newOrder.map(function(id) {
            return services.podology.services.find(function(s) { return String(s.id) === String(id); });
        }).filter(Boolean);

        services.podology.services = reordered;

        AdminAPI.save('services', services)
            .then(function() {
                AdminState.setServices(services);
                if (window.showToast) {
                    showToast('Порядок сохранён', 'success');
                }
            })
            .catch(function(error) {
                if (window.showToast) {
                    showToast('Ошибка сохранения порядка', 'error');
                }
                renderPodology();
            });
    }

    /**
     * Рендеринг услуг категории
     */
    function render() {
        if (!servicesList) {
            servicesList = document.getElementById('servicesList');
            if (!servicesList) return;
        }

        var currentCategory = AdminState.currentCategory || 'main';
        var services = AdminState.services || {};
        var category = null;

        if (services.categories) {
            category = services.categories.find(function(c) {
                return c.id === currentCategory;
            });
        }

        if (!category || !category.services || category.services.length === 0) {
            servicesList.innerHTML = '<p class="empty-message">Нет услуг в этой категории</p>';
            return;
        }

        var html = category.services.map(function(service, index) {
            return '<div class="service-item" data-id="' + service.id + '" data-index="' + index + '" data-search="' + escapeAttr(service.name) + '" draggable="true">' +
                '<div class="drag-handle" title="Перетащите для изменения порядка">' + SharedIcons.get('grip') + '</div>' +
                '<span class="service-name">' + escapeHtml(service.name) + '</span>' +
                '<div class="service-prices">' +
                    '<span class="price-tag price-green">' + (service.priceGreen || 0) + ' ₽</span>' +
                    '<span class="price-tag price-pink">' + (service.pricePink || 0) + ' ₽</span>' +
                    '<span class="price-tag price-blue">' + (service.priceBlue || 0) + ' ₽</span>' +
                '</div>' +
                '<div class="service-actions">' +
                    '<button class="btn btn-icon" data-action="edit-service" data-category="' + currentCategory + '" data-index="' + index + '" title="Редактировать">' +
                        SharedIcons.get('edit') +
                    '</button>' +
                    '<button class="btn btn-icon danger" data-action="delete-service" data-category="' + currentCategory + '" data-index="' + index + '" data-name="' + escapeAttr(service.name) + '" title="Удалить">' +
                        SharedIcons.get('delete') +
                    '</button>' +
                '</div>' +
            '</div>';
        }).join('');

        servicesList.innerHTML = html;

        if (window.AdminDragDrop) {
            AdminDragDrop.refresh('servicesList');
        }
    }

    /**
     * Рендеринг услуг подологии
     */
    function renderPodology() {
        if (!podologyList) {
            podologyList = document.getElementById('podologyList');
            if (!podologyList) return;
        }

        var services = AdminState.services || {};
        var podologyServices = (services.podology && services.podology.services) || [];

        if (podologyServices.length === 0) {
            podologyList.innerHTML = '<p class="empty-message">Нет услуг подологии</p>';
            return;
        }

        var html = podologyServices.map(function(service, index) {
            return '<div class="service-item" data-id="' + service.id + '" data-index="' + index + '" data-search="' + escapeAttr(service.name) + '" draggable="true">' +
                '<div class="drag-handle" title="Перетащите для изменения порядка">' + SharedIcons.get('grip') + '</div>' +
                '<span class="service-name">' + escapeHtml(service.name) + '</span>' +
                '<div class="service-prices">' +
                    '<span class="price-tag price-single">' + escapeHtml(service.price) + '</span>' +
                '</div>' +
                '<div class="service-actions">' +
                    '<button class="btn btn-icon" data-action="edit-podology" data-index="' + index + '" title="Редактировать">' +
                        SharedIcons.get('edit') +
                    '</button>' +
                    '<button class="btn btn-icon danger" data-action="delete-podology" data-index="' + index + '" data-name="' + escapeAttr(service.name) + '" title="Удалить">' +
                        SharedIcons.get('delete') +
                    '</button>' +
                '</div>' +
            '</div>';
        }).join('');

        podologyList.innerHTML = html;

        if (window.AdminDragDrop) {
            AdminDragDrop.refresh('podologyList');
        }
    }

    /**
     * Escape HTML
     */
    function escapeHtml(text) {
        if (!text) return '';
        if (typeof window.escapeHtml === 'function') {
            return window.escapeHtml(text);
        }
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Публичный API
    return {
        init: init,
        render: render,
        renderPodology: renderPodology,
        reorderServices: reorderServices,
        reorderPodology: reorderPodology
    };
})();

// Экспорт
window.AdminServicesRenderer = AdminServicesRenderer;


// ============= renderers/articles.js =============

/**
 * Admin Articles Renderer
 * Рендеринг списка статей с поддержкой drag & drop
 */

var AdminArticlesRenderer = (function() {
    'use strict';

    var container = null;
    var dragDropInitialized = false;

    /**
     * Инициализация
     */
    function init() {
        container = document.getElementById('articlesGrid');
        initDragDrop();
    }

    /**
     * Инициализация drag & drop
     */
    function initDragDrop() {
        if (dragDropInitialized || !window.AdminDragDrop) return;

        AdminDragDrop.init('articlesGrid', '.article-card', function(newOrder) {
            reorderArticles(newOrder);
        });

        dragDropInitialized = true;
    }

    /**
     * Изменение порядка статей
     */
    function reorderArticles(newOrder) {
        var articles = AdminState.articles || [];

        var reordered = newOrder.map(function(id) {
            return articles.find(function(a) { return a.id === id; });
        }).filter(Boolean);

        reordered.forEach(function(article, index) {
            article.order = index;
        });

        AdminAPI.save('articles', { articles: reordered })
            .then(function() {
                AdminState.setArticles(reordered);
                if (window.showToast) {
                    showToast('Порядок сохранён', 'success');
                }
            })
            .catch(function(error) {
                if (window.showToast) {
                    showToast('Ошибка сохранения порядка', 'error');
                }
                render();
            });
    }

    /**
     * Рендеринг списка статей
     */
    function render() {
        if (!container) {
            container = document.getElementById('articlesGrid');
            if (!container) return;
        }

        var articles = AdminState.articles || [];

        if (articles.length === 0) {
            container.innerHTML = '<p class="empty-message">Нет статей. Нажмите "Добавить" чтобы создать.</p>';
            return;
        }

        var html = articles.map(function(article, index) {
            var imageHtml = article.image
                ? '<img src="' + article.image + '" alt="' + escapeHtml(article.title) + '">'
                : SharedIcons.get('image');

            var searchText = [article.title, article.tag, article.excerpt].join(' ');

            return '<div class="article-card has-drag" data-id="' + article.id + '" data-index="' + index + '" data-search="' + escapeAttr(searchText) + '" draggable="true">' +
                '<div class="article-image">' +
                    imageHtml +
                '</div>' +
                '<div class="article-content">' +
                    '<div class="article-meta">' +
                        '<span class="article-tag">' + escapeHtml(article.tag || 'Статья') + '</span>' +
                        '<span class="article-date">' + SharedHelpers.formatDate(article.date) + '</span>' +
                    '</div>' +
                    '<h3 class="article-title">' + escapeHtml(article.title) + '</h3>' +
                    '<p class="article-excerpt">' + escapeHtml(article.excerpt || '') + '</p>' +
                    '<div class="article-actions">' +
                        '<button class="btn btn-secondary" data-action="edit-article" data-id="' + article.id + '">' +
                            SharedIcons.get('edit') +
                            'Редактировать' +
                        '</button>' +
                        '<button class="btn btn-icon danger" data-action="delete-article" data-id="' + article.id + '" data-name="' + escapeAttr(article.title) + '" title="Удалить">' +
                            SharedIcons.get('delete') +
                        '</button>' +
                    '</div>' +
                '</div>' +
                '<div class="drag-handle" title="Перетащите для изменения порядка">' + SharedIcons.get('grip') + '</div>' +
            '</div>';
        }).join('');

        container.innerHTML = html;

        if (window.AdminDragDrop) {
            AdminDragDrop.refresh('articlesGrid');
        }
    }

    // escapeHtml теперь используется из SharedHelpers (helpers.js)

    // Публичный API
    return {
        init: init,
        render: render,
        reorderArticles: reorderArticles
    };
})();

// Экспорт
window.AdminArticlesRenderer = AdminArticlesRenderer;


// ============= renderers/faq.js =============

/**
 * Admin FAQ Renderer
 * Рендеринг списка FAQ с поддержкой drag & drop
 */

var AdminFaqRenderer = (function() {
    'use strict';

    var container = null;
    var dragDropInitialized = false;

    /**
     * Инициализация
     */
    function init() {
        container = document.getElementById('faqList');
        initDragDrop();
    }

    /**
     * Инициализация drag & drop
     */
    function initDragDrop() {
        if (dragDropInitialized || !window.AdminDragDrop) return;

        AdminDragDrop.init('faqList', '.faq-admin-item', function(newOrder) {
            reorderFaq(newOrder);
        });

        dragDropInitialized = true;
    }

    /**
     * Изменение порядка FAQ
     */
    function reorderFaq(newOrder) {
        var faq = AdminState.faq || [];

        var reordered = newOrder.map(function(id) {
            return faq.find(function(f) { return f.id === id; });
        }).filter(Boolean);

        reordered.forEach(function(item, index) {
            item.order = index;
        });

        AdminAPI.save('faq', { faq: reordered })
            .then(function() {
                AdminState.setFaq(reordered);
                if (window.showToast) {
                    showToast('Порядок сохранён', 'success');
                }
            })
            .catch(function(error) {
                if (window.showToast) {
                    showToast('Ошибка сохранения порядка', 'error');
                }
                render();
            });
    }

    /**
     * Рендеринг списка FAQ
     */
    function render() {
        if (!container) {
            container = document.getElementById('faqList');
            if (!container) return;
        }

        var faq = AdminState.faq || [];

        if (faq.length === 0) {
            container.innerHTML = '<p class="empty-message">Нет вопросов. Нажмите "Добавить" чтобы создать.</p>';
            return;
        }

        var html = faq.map(function(item, index) {
            var searchText = [item.question, item.answer].join(' ');

            return '<div class="faq-admin-item has-drag" data-id="' + item.id + '" data-index="' + index + '" data-search="' + escapeAttr(searchText) + '" draggable="true">' +
                '<div class="drag-handle" title="Перетащите для изменения порядка">' + SharedIcons.get('grip') + '</div>' +
                '<div class="faq-admin-content">' +
                    '<h3 class="faq-admin-question">' + escapeHtml(item.question) + '</h3>' +
                    '<p class="faq-admin-answer">' + escapeHtml(item.answer) + '</p>' +
                '</div>' +
                '<div class="faq-admin-actions">' +
                    '<button class="btn btn-secondary" data-action="edit-faq" data-id="' + item.id + '">' +
                        SharedIcons.get('edit') +
                        'Редактировать' +
                    '</button>' +
                    '<button class="btn btn-icon danger" data-action="delete-faq" data-id="' + item.id + '" data-name="' + escapeAttr(item.question) + '" title="Удалить">' +
                        SharedIcons.get('delete') +
                    '</button>' +
                '</div>' +
            '</div>';
        }).join('');

        container.innerHTML = html;

        if (window.AdminDragDrop) {
            AdminDragDrop.refresh('faqList');
        }
    }

    // escapeHtml теперь используется из SharedHelpers (helpers.js)

    // Публичный API
    return {
        init: init,
        render: render,
        reorderFaq: reorderFaq
    };
})();

// Экспорт
window.AdminFaqRenderer = AdminFaqRenderer;


// ============= renderers/social.js =============

/**
 * Admin Social Renderer
 * Рендеринг соцсетей и контактов
 */

var AdminSocialRenderer = (function() {
    'use strict';

    var elements = {};

    /**
     * Инициализация
     */
    function init() {
        elements = {
            socialLinksList: document.getElementById('socialLinksList'),
            contactPhone: document.getElementById('contactPhone'),
            contactEmail: document.getElementById('contactEmail'),
            contactAddress: document.getElementById('contactAddress')
        };
    }

    /**
     * Рендеринг соцсетей и контактов
     */
    function render() {
        var social = AdminState.social || {};

        // Заполняем контактную информацию
        if (elements.contactPhone) {
            elements.contactPhone.value = social.phone || '';
        }
        if (elements.contactEmail) {
            elements.contactEmail.value = social.email || '';
        }
        if (elements.contactAddress) {
            elements.contactAddress.value = social.address || '';
        }

        // Рендерим список соцсетей
        if (!elements.socialLinksList) {
            elements.socialLinksList = document.getElementById('socialLinksList');
            if (!elements.socialLinksList) return;
        }

        var socialLinks = social.social || [];

        if (socialLinks.length === 0) {
            elements.socialLinksList.innerHTML = '<p class="empty-message">Нет настроенных соцсетей</p>';
            return;
        }

        var html = socialLinks.map(function(link) {
            var inactiveClass = link.active ? '' : 'inactive';
            var toggleClass = link.active ? 'active' : '';
            var toggleText = link.active ? 'Вкл' : 'Выкл';

            return '<div class="social-link-item ' + inactiveClass + '" data-id="' + link.id + '">' +
                '<div class="social-link-icon ' + link.icon + '">' +
                    SharedIcons.getSocial(link.icon) +
                '</div>' +
                '<div class="social-link-info">' +
                    '<div class="social-link-name">' + window.escapeHtml(link.name) + '</div>' +
                    '<input type="text" ' +
                        'class="social-link-url-input" ' +
                        'data-social-id="' + link.id + '" ' +
                        'value="' + window.escapeHtml(link.url || '') + '" ' +
                        'placeholder="Введите URL для ' + window.escapeHtml(link.name) + '">' +
                '</div>' +
                '<div class="social-link-toggle">' +
                    '<div class="toggle ' + toggleClass + '" data-social-id="' + link.id + '" data-action="toggle-social"></div>' +
                    '<span>' + toggleText + '</span>' +
                '</div>' +
            '</div>';
        }).join('');

        elements.socialLinksList.innerHTML = html;
    }

    /**
     * Переключение активности соцсети
     */
    function toggleActive(id) {
        var social = AdminState.social;
        if (!social || !social.social) return;

        var link = social.social.find(function(s) {
            return s.id === id;
        });

        if (link) {
            link.active = !link.active;
            render();
        }
    }

    /**
     * Сохранение соцсетей
     */
    async function save() {
        var social = AdminState.social;

        // Собираем данные из формы
        if (elements.contactPhone) {
            social.phone = elements.contactPhone.value.trim();
        }
        if (elements.contactEmail) {
            social.email = elements.contactEmail.value.trim();
        }
        if (elements.contactAddress) {
            social.address = elements.contactAddress.value.trim();
        }

        // Собираем URL соцсетей из инпутов
        var urlInputs = document.querySelectorAll('.social-link-url-input');
        urlInputs.forEach(function(input) {
            var socialId = input.dataset.socialId;
            if (social.social) {
                var link = social.social.find(function(s) {
                    return s.id === socialId;
                });
                if (link) {
                    link.url = input.value.trim();
                }
            }
        });

        try {
            await AdminAPI.save('social', social);
            showToast('Настройки сохранены', 'success');
        } catch (error) {
            console.error('Error saving social:', error);
            showToast('Ошибка сохранения', 'error');
        }
    }

    // Публичный API
    return {
        init: init,
        render: render,
        toggleActive: toggleActive,
        save: save
    };
})();

// Экспорт
window.AdminSocialRenderer = AdminSocialRenderer;


// ============= renderers/shop-categories.js =============

/**
 * Shop Categories Renderer
 * Отображение списка категорий товаров
 */

var AdminShopCategoriesRenderer = (function() {
    'use strict';

    var container = null;

    function init() {
        container = document.getElementById('shopCategoriesGrid');
    }

    function render() {
        if (!container) {
            container = document.getElementById('shopCategoriesGrid');
            if (!container) return;
        }

        var categories = AdminState.shopCategories || [];

        if (categories.length === 0) {
            container.innerHTML = '<div class="empty-state">' +
                '<p>Категории ещё не добавлены</p>' +
                '<p class="empty-hint">Нажмите "Добавить" для создания первой категории</p>' +
            '</div>';
            return;
        }

        var html = categories
            .sort(function(a, b) { return (a.order || 0) - (b.order || 0); })
            .map(function(cat) {
                var productsCount = (AdminState.products || []).filter(function(p) {
                    return p.categoryId === cat.id;
                }).length;

                var iconHtml = SharedIcons.get(cat.icon || 'folder');
                var isInactive = cat.active === false;
                var statusBadge = isInactive
                    ? '<span class="category-card-badge inactive">Скрыта</span>'
                    : '';

                var productWord = getProductWord(productsCount);
                var descriptionHtml = cat.description
                    ? '<p class="category-card-description">' + escapeHtml(cat.description) + '</p>'
                    : '';

                return '<div class="shop-category-card' + (isInactive ? ' inactive' : '') + '" data-id="' + escapeAttr(cat.id) + '">' +
                    '<div class="category-card-icon">' + iconHtml + '</div>' +
                    '<div class="category-card-info">' +
                        '<h3 class="category-card-name">' +
                            escapeHtml(cat.name) +
                            statusBadge +
                        '</h3>' +
                        descriptionHtml +
                        '<span class="category-card-count">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>' +
                            productsCount + ' ' + productWord +
                        '</span>' +
                    '</div>' +
                    '<div class="category-card-actions">' +
                        '<button class="btn btn-icon" data-action="edit-shop-category" data-id="' + escapeAttr(cat.id) + '" title="Редактировать">' +
                            SharedIcons.get('edit') +
                        '</button>' +
                        '<button class="btn btn-icon danger" data-action="delete-shop-category" data-id="' + escapeAttr(cat.id) + '" title="Удалить">' +
                            SharedIcons.get('delete') +
                        '</button>' +
                    '</div>' +
                '</div>';
            }).join('');

        container.innerHTML = html;
    }

    // escapeHtml теперь используется из SharedHelpers (helpers.js)

    function getProductWord(count) {
        var n = Math.abs(count) % 100;
        var n1 = n % 10;
        if (n > 10 && n < 20) return 'товаров';
        if (n1 > 1 && n1 < 5) return 'товара';
        if (n1 === 1) return 'товар';
        return 'товаров';
    }

    return {
        init: init,
        render: render
    };
})();

window.AdminShopCategoriesRenderer = AdminShopCategoriesRenderer;


// ============= renderers/shop-products.js =============

/**
 * Shop Products Renderer
 * Отображение таблицы товаров с пагинацией
 */

var AdminShopProductsRenderer = (function() {
    'use strict';

    var container = null;
    var currentPage = 1;
    var itemsPerPage = 10;
    var filterCategory = 'all';

    function init() {
        container = document.getElementById('productsTableBody');

        // Filter change handler
        var filterSelect = document.getElementById('productsFilterCategory');
        if (filterSelect) {
            filterSelect.addEventListener('change', function(e) {
                setFilter(e.target.value);
            });
        }
    }

    function render() {
        if (!container) {
            container = document.getElementById('productsTableBody');
            if (!container) return;
        }

        // Update filter select options
        updateFilterOptions();

        var products = AdminState.products || [];

        // Filter by category
        if (filterCategory !== 'all') {
            products = products.filter(function(p) {
                return p.categoryId === filterCategory;
            });
        }

        // Sort by order
        products.sort(function(a, b) { return (a.order || 0) - (b.order || 0); });

        // Pagination
        var total = products.length;
        var totalPages = Math.ceil(total / itemsPerPage);
        var start = (currentPage - 1) * itemsPerPage;
        var end = start + itemsPerPage;
        var pageProducts = products.slice(start, end);

        if (pageProducts.length === 0) {
            container.innerHTML = '<tr><td colspan="5" class="empty-cell">' +
                '<div class="empty-state">' +
                    '<p>Товары ещё не добавлены</p>' +
                    '<p class="empty-hint">Нажмите "Добавить" для создания первого товара</p>' +
                '</div>' +
            '</td></tr>';
            renderPagination(0, 0);
            return;
        }

        var html = pageProducts.map(function(product) {
            var category = AdminState.findShopCategory(product.categoryId);
            var mainImage = null;
            if (product.images && product.images.length > 0) {
                mainImage = product.images.find(function(img) { return img.isMain; }) || product.images[0];
            }

            var statusClass = {
                active: 'success',
                draft: 'warning',
                archived: 'secondary'
            }[product.status] || 'secondary';

            var statusText = {
                active: 'Активен',
                draft: 'Черновик',
                archived: 'В архиве'
            }[product.status] || product.status;

            return '<tr>' +
                '<td>' +
                    '<div class="product-cell">' +
                        (mainImage
                            ? '<img src="' + escapeHtml(mainImage.url) + '" class="product-thumb" alt="">'
                            : '<div class="product-thumb-placeholder">' + SharedIcons.get('box') + '</div>') +
                        '<span class="product-cell-name">' + escapeHtml(product.name) + '</span>' +
                    '</div>' +
                '</td>' +
                '<td>' + (category ? escapeHtml(category.name) : '-') + '</td>' +
                '<td class="price-cell">' + SharedHelpers.formatPrice(product.price) + '</td>' +
                '<td><span class="status-badge ' + statusClass + '">' + statusText + '</span></td>' +
                '<td class="actions-cell">' +
                    '<button class="btn btn-icon" data-action="edit-product" data-id="' + escapeAttr(product.id) + '" title="Редактировать">' +
                        SharedIcons.get('edit') +
                    '</button>' +
                    '<button class="btn btn-icon danger" data-action="delete-product" data-id="' + escapeAttr(product.id) + '" title="Удалить">' +
                        SharedIcons.get('delete') +
                    '</button>' +
                '</td>' +
            '</tr>';
        }).join('');

        container.innerHTML = html;
        renderPagination(totalPages, total);
    }

    function updateFilterOptions() {
        var filterSelect = document.getElementById('productsFilterCategory');
        if (!filterSelect) return;

        var categories = AdminState.shopCategories || [];
        var html = '<option value="all">Все категории</option>';

        categories.forEach(function(cat) {
            var selected = filterCategory === cat.id ? ' selected' : '';
            html += '<option value="' + escapeHtml(cat.id) + '"' + selected + '>' +
                escapeHtml(cat.name) +
            '</option>';
        });

        filterSelect.innerHTML = html;
    }

    function renderPagination(totalPages, total) {
        var paginationEl = document.getElementById('productsPagination');
        if (!paginationEl) return;

        if (totalPages <= 1) {
            paginationEl.innerHTML = '';
            return;
        }

        var html = '<div class="pagination">' +
            '<span class="pagination-info">Показано ' + Math.min(itemsPerPage, total) + ' из ' + total + '</span>' +
            '<div class="pagination-buttons">';

        for (var i = 1; i <= totalPages; i++) {
            var activeClass = i === currentPage ? ' active' : '';
            html += '<button class="pagination-btn' + activeClass + '" onclick="AdminShopProductsRenderer.goToPage(' + i + ')">' + i + '</button>';
        }

        html += '</div></div>';
        paginationEl.innerHTML = html;
    }

    function setFilter(categoryId) {
        filterCategory = categoryId;
        currentPage = 1;
        render();
    }

    function goToPage(page) {
        currentPage = page;
        render();
    }

    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    return {
        init: init,
        render: render,
        setFilter: setFilter,
        goToPage: goToPage
    };
})();

window.AdminShopProductsRenderer = AdminShopProductsRenderer;


// ============= renderers/legal.js =============

/**
 * Admin Legal Renderer
 * Рендеринг юридических документов (политики, соглашения)
 */

var AdminLegalRenderer = (function() {
    'use strict';

    var elements = {};

    /**
     * Инициализация
     */
    function init() {
        elements = {
            legalDocumentsList: document.getElementById('legalDocumentsList')
        };
    }

    /**
     * Рендеринг списка документов
     */
    function render() {
        if (!elements.legalDocumentsList) {
            elements.legalDocumentsList = document.getElementById('legalDocumentsList');
            if (!elements.legalDocumentsList) return;
        }

        var documents = AdminState.legalDocuments || [];

        if (documents.length === 0) {
            elements.legalDocumentsList.innerHTML = '<p class="empty-message">Нет юридических документов</p>';
            return;
        }

        var html = documents.map(function(doc) {
            var statusClass = doc.active ? 'active' : 'inactive';
            var statusText = doc.active ? 'Активен' : 'Скрыт';
            var updatedAt = doc.updatedAt ? new Date(doc.updatedAt).toLocaleDateString('ru-RU') : '';

            return '<div class="legal-document-card ' + statusClass + '" data-id="' + doc.id + '">' +
                '<div class="legal-document-header">' +
                    '<div class="legal-document-info">' +
                        '<h3 class="legal-document-title">' + window.escapeHtml(doc.title) + '</h3>' +
                        '<div class="legal-document-meta">' +
                            '<span class="legal-document-slug">/legal/' + window.escapeHtml(doc.slug) + '</span>' +
                            (updatedAt ? '<span class="legal-document-date">Обновлён: ' + updatedAt + '</span>' : '') +
                        '</div>' +
                    '</div>' +
                    '<div class="legal-document-status">' +
                        '<span class="status-badge ' + statusClass + '">' + statusText + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="legal-document-preview">' +
                    getPreviewText(doc.content) +
                '</div>' +
                '<div class="legal-document-actions">' +
                    '<button class="btn btn-secondary btn-sm" data-action="edit-legal" data-id="' + doc.id + '">' +
                        SharedIcons.get('edit') +
                        '<span>Редактировать</span>' +
                    '</button>' +
                    '<button class="btn btn-outline btn-sm" data-action="toggle-legal" data-id="' + doc.id + '">' +
                        (doc.active ? SharedIcons.get('eyeOff') : SharedIcons.get('eye')) +
                        '<span>' + (doc.active ? 'Скрыть' : 'Показать') + '</span>' +
                    '</button>' +
                '</div>' +
            '</div>';
        }).join('');

        elements.legalDocumentsList.innerHTML = html;
    }

    /**
     * Получение превью текста (без HTML тегов)
     */
    function getPreviewText(html) {
        if (!html) return '';
        var div = document.createElement('div');
        div.innerHTML = html;
        var text = div.textContent || div.innerText || '';
        return text.length > 200 ? text.substring(0, 200) + '...' : text;
    }

    /**
     * Переключение активности документа
     */
    async function toggleActive(id) {
        var documents = AdminState.legalDocuments || [];
        var doc = documents.find(function(d) { return d.id === id; });

        if (doc) {
            doc.active = !doc.active;
            doc.updatedAt = new Date().toISOString();

            try {
                await AdminAPI.save('legal', { documents: documents });
                render();
                showToast('Статус документа изменён', 'success');
            } catch (error) {
                console.error('Error toggling legal document:', error);
                showToast('Ошибка сохранения', 'error');
            }
        }
    }

    // Публичный API
    return {
        init: init,
        render: render,
        toggleActive: toggleActive
    };
})();

// Экспорт
window.AdminLegalRenderer = AdminLegalRenderer;


// ============= forms/master-form.js =============

/**
 * Admin Master Form
 * Форма добавления/редактирования мастера
 */

var AdminMasterForm = (function() {
    'use strict';

    /**
     * Показать форму мастера
     */
    function show(master) {
        AdminState.editingItem = master || null;

        var title = master ? 'Редактировать мастера' : 'Добавить мастера';
        var principles = (master && master.principles) || ['', '', '', ''];

        var principlesHtml = principles.map(function(p, i) {
            return '<div class="principle-item">' +
                '<input type="text" class="form-input principle-input" value="' + window.escapeHtml(p) + '" placeholder="Принцип ' + (i + 1) + '">' +
                '<button type="button" class="btn btn-icon danger" data-action="remove-principle">' +
                    SharedIcons.get('close') +
                '</button>' +
            '</div>';
        }).join('');

        var html = '<form id="masterForm" class="admin-form">' +
            '<div class="form-group">' +
                '<label class="form-label">Фото</label>' +
                '<div class="image-upload ' + (master && master.photo ? 'has-image' : '') + '" id="masterPhotoUpload">' +
                    (master && master.photo ? '<img src="' + master.photo + '" alt="Фото">' : '') +
                    '<input type="file" accept="image/*" data-upload-target="masterPhoto">' +
                    SharedIcons.get('upload') +
                    '<span>Нажмите для загрузки фото</span>' +
                    (master && master.photo ? '<button type="button" class="remove-image" data-action="remove-image" data-target="masterPhoto">' + SharedIcons.get('close') + '</button>' : '') +
                '</div>' +
                '<input type="hidden" id="masterPhoto" value="' + (master && master.photo ? master.photo : '') + '">' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Имя *</label>' +
                '<input type="text" class="form-input" id="masterName" value="' + window.escapeHtml(master && master.name || '') + '" placeholder="Введите имя мастера" required>' +
            '</div>' +
            '<div class="form-row form-row-2">' +
                '<div class="form-group">' +
                    '<label class="form-label">Инициал</label>' +
                    '<input type="text" class="form-input" id="masterInitial" value="' + window.escapeHtml(master && master.initial || '') + '" placeholder="С" maxlength="1">' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label">Уровень</label>' +
                    '<select class="form-select" id="masterBadge">' +
                        '<option value="green" ' + (master && master.badge === 'green' ? 'selected' : '') + '>Green (начальный)</option>' +
                        '<option value="pink" ' + (master && master.badge === 'pink' ? 'selected' : '') + '>Pink (средний)</option>' +
                        '<option value="blue" ' + (master && master.badge === 'blue' ? 'selected' : '') + '>Dark Blue (высший)</option>' +
                    '</select>' +
                '</div>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Должность</label>' +
                '<input type="text" class="form-input" id="masterRole" value="' + window.escapeHtml(master && master.role || '') + '" placeholder="Мастер">' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Специализация</label>' +
                '<textarea class="form-textarea" id="masterSpecialization" placeholder="Описание специализации мастера...">' + window.escapeHtml(master && master.specialization || '') + '</textarea>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Принципы работы</label>' +
                '<div class="principles-list" id="principlesList">' +
                    principlesHtml +
                '</div>' +
                '<button type="button" class="btn btn-secondary add-principle" data-action="add-principle">' +
                    SharedIcons.get('plus') +
                    'Добавить принцип' +
                '</button>' +
            '</div>' +
        '</form>';

        AdminModals.setTitle('modal', title);
        var modalBody = document.getElementById('modalBody');
        if (modalBody) {
            modalBody.innerHTML = html;
        }
        AdminModals.open('modal');
    }

    /**
     * Сохранить мастера
     */
    async function save() {
        var nameEl = document.getElementById('masterName');
        var name = nameEl ? nameEl.value.trim() : '';

        if (!name) {
            showToast('Введите имя мастера', 'error');
            return;
        }

        var initialEl = document.getElementById('masterInitial');
        var badgeEl = document.getElementById('masterBadge');
        var roleEl = document.getElementById('masterRole');
        var specEl = document.getElementById('masterSpecialization');
        var photoEl = document.getElementById('masterPhoto');

        var initial = initialEl ? initialEl.value.trim() : '';
        var badge = badgeEl ? badgeEl.value : 'green';
        var role = roleEl ? roleEl.value.trim() : 'Мастер';
        var specialization = specEl ? specEl.value.trim() : '';
        var photo = photoEl ? photoEl.value : null;

        var principles = [];
        var principleInputs = document.querySelectorAll('.principle-input');
        principleInputs.forEach(function(input) {
            var val = input.value.trim();
            if (val) {
                principles.push(val);
            }
        });

        var masterData = {
            id: AdminState.editingItem ? AdminState.editingItem.id : 'master_' + Date.now(),
            name: name,
            initial: initial || name.charAt(0),
            badge: badge,
            role: role || 'Мастер',
            specialization: specialization,
            principles: principles,
            photo: photo,
            active: true
        };

        var masters = AdminState.masters || [];

        if (AdminState.editingItem) {
            var index = masters.findIndex(function(m) {
                return m.id === AdminState.editingItem.id;
            });
            if (index !== -1) {
                masters[index] = masterData;
            }
        } else {
            masters.push(masterData);
        }

        try {
            await AdminAPI.save('masters', { masters: masters });
            AdminState.setMasters(masters);
            showToast('Мастер сохранён', 'success');
            AdminModals.close('modal');
            AdminMastersRenderer.render();
        } catch (error) {
            showToast('Ошибка сохранения: ' + error.message, 'error');
        }
    }

    /**
     * Удалить мастера
     */
    async function remove(id) {
        if (!confirm('Вы уверены, что хотите удалить этого мастера?')) {
            return;
        }

        var masters = AdminState.masters.filter(function(m) {
            return m.id !== id;
        });

        try {
            await AdminAPI.save('masters', { masters: masters });
            AdminState.setMasters(masters);
            showToast('Мастер удалён', 'success');
            AdminMastersRenderer.render();
        } catch (error) {
            showToast('Ошибка удаления: ' + error.message, 'error');
        }
    }

    /**
     * Добавить поле принципа
     */
    function addPrinciple() {
        var list = document.getElementById('principlesList');
        if (!list) return;

        var count = list.querySelectorAll('.principle-item').length;

        var div = document.createElement('div');
        div.className = 'principle-item';
        div.innerHTML = '<input type="text" class="form-input principle-input" value="" placeholder="Принцип ' + (count + 1) + '">' +
            '<button type="button" class="btn btn-icon danger" data-action="remove-principle">' +
                SharedIcons.get('close') +
            '</button>';

        list.appendChild(div);
    }

    /**
     * Удалить поле принципа
     */
    function removePrinciple(button) {
        var item = button.closest('.principle-item');
        if (item) {
            item.remove();
        }
    }

    // Публичный API
    return {
        show: show,
        save: save,
        remove: remove,
        addPrinciple: addPrinciple,
        removePrinciple: removePrinciple
    };
})();

// Экспорт
window.AdminMasterForm = AdminMasterForm;


// ============= forms/service-form.js =============

/**
 * Admin Service Form
 * Форма добавления/редактирования услуги
 */

var AdminServiceForm = (function() {
    'use strict';

    /**
     * Показать форму услуги
     */
    function show(categoryId, index) {
        categoryId = categoryId || AdminState.currentCategory || 'main';

        var services = AdminState.services || {};
        var category = null;
        var service = null;

        if (services.categories) {
            category = services.categories.find(function(c) {
                return c.id === categoryId;
            });
        }

        if (category && index !== null && index !== undefined) {
            service = category.services[index];
        }

        AdminState.editingItem = {
            categoryId: categoryId,
            index: index,
            service: service
        };

        var title = service ? 'Редактировать услугу' : 'Добавить услугу';

        var html = '<form id="serviceForm" class="admin-form">' +
            '<div class="form-group">' +
                '<label class="form-label">Название услуги *</label>' +
                '<input type="text" class="form-input" id="serviceName" value="' + window.escapeHtml(service && service.name || '') + '" placeholder="Введите название услуги" required>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Цены по уровням мастеров</label>' +
                '<div class="form-row">' +
                    '<div class="form-group">' +
                        '<label class="form-label price-label-green">Green</label>' +
                        '<input type="number" class="form-input" id="priceGreen" value="' + (service && service.priceGreen || '') + '" placeholder="1000">' +
                    '</div>' +
                    '<div class="form-group">' +
                        '<label class="form-label price-label-pink">Pink</label>' +
                        '<input type="number" class="form-input" id="pricePink" value="' + (service && service.pricePink || '') + '" placeholder="1300">' +
                    '</div>' +
                    '<div class="form-group">' +
                        '<label class="form-label price-label-blue">Dark Blue</label>' +
                        '<input type="number" class="form-input" id="priceBlue" value="' + (service && service.priceBlue || '') + '" placeholder="1500">' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</form>';

        AdminModals.setTitle('modal', title);
        var modalBody = document.getElementById('modalBody');
        if (modalBody) {
            modalBody.innerHTML = html;
        }
        AdminModals.open('modal');
    }

    /**
     * Показать форму услуги подологии
     */
    function showPodology(index) {
        var services = AdminState.services || {};
        var podologyServices = (services.podology && services.podology.services) || [];
        var service = null;

        if (index !== null && index !== undefined) {
            service = podologyServices[index];
        }

        AdminState.editingItem = {
            type: 'podology',
            index: index,
            service: service
        };

        var title = service ? 'Редактировать услугу' : 'Добавить услугу подологии';

        var html = '<form id="podologyForm" class="admin-form">' +
            '<div class="form-group">' +
                '<label class="form-label">Название услуги *</label>' +
                '<input type="text" class="form-input" id="podologyName" value="' + window.escapeHtml(service && service.name || '') + '" placeholder="Введите название услуги" required>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Цена</label>' +
                '<input type="text" class="form-input" id="podologyPrice" value="' + window.escapeHtml(service && service.price || '') + '" placeholder="от 2000 ₽">' +
            '</div>' +
        '</form>';

        AdminModals.setTitle('modal', title);
        var modalBody = document.getElementById('modalBody');
        if (modalBody) {
            modalBody.innerHTML = html;
        }
        AdminModals.open('modal');
    }

    /**
     * Получить название категории
     */
    function getCategoryName(id) {
        var names = {
            main: 'Основные услуги',
            complex: 'Комплексные услуги',
            additional: 'Дополнительные услуги'
        };
        return names[id] || id;
    }

    /**
     * Сохранить услугу
     */
    async function save() {
        var editing = AdminState.editingItem || {};
        var categoryId = editing.categoryId;
        var index = editing.index;

        var nameEl = document.getElementById('serviceName');
        var name = nameEl ? nameEl.value.trim() : '';

        if (!name) {
            showToast('Введите название услуги', 'error');
            return;
        }

        var greenEl = document.getElementById('priceGreen');
        var pinkEl = document.getElementById('pricePink');
        var blueEl = document.getElementById('priceBlue');

        var priceGreen = parseInt(greenEl ? greenEl.value : 0, 10) || 0;
        var pricePink = parseInt(pinkEl ? pinkEl.value : 0, 10) || 0;
        var priceBlue = parseInt(blueEl ? blueEl.value : 0, 10) || 0;

        var serviceData = {
            id: editing.service ? editing.service.id : Date.now(),
            name: name,
            priceGreen: priceGreen,
            pricePink: pricePink,
            priceBlue: priceBlue
        };

        var services = AdminState.services || {};

        // Ensure categories exist
        if (!services.categories) {
            services.categories = [];
        }

        var category = services.categories.find(function(c) {
            return c.id === categoryId;
        });

        if (!category) {
            category = {
                id: categoryId,
                name: getCategoryName(categoryId),
                services: []
            };
            services.categories.push(category);
        }

        if (!category.services) {
            category.services = [];
        }

        if (index !== null && index !== undefined) {
            category.services[index] = serviceData;
        } else {
            category.services.push(serviceData);
        }

        try {
            await AdminAPI.save('services', services);
            AdminState.setServices(services);
            showToast('Услуга сохранена', 'success');
            AdminModals.close('modal');
            AdminServicesRenderer.render();
        } catch (error) {
            showToast('Ошибка сохранения: ' + error.message, 'error');
        }
    }

    /**
     * Сохранить услугу подологии
     */
    async function savePodology() {
        var editing = AdminState.editingItem || {};
        var index = editing.index;

        var nameEl = document.getElementById('podologyName');
        var name = nameEl ? nameEl.value.trim() : '';

        if (!name) {
            showToast('Введите название услуги', 'error');
            return;
        }

        var priceEl = document.getElementById('podologyPrice');
        var price = priceEl ? priceEl.value.trim() : 'Уточняйте';

        var serviceData = {
            id: editing.service ? editing.service.id : Date.now(),
            name: name,
            price: price || 'Уточняйте'
        };

        var services = AdminState.services || {};

        if (!services.podology) {
            services.podology = { services: [] };
        }
        if (!services.podology.services) {
            services.podology.services = [];
        }

        if (index !== null && index !== undefined) {
            services.podology.services[index] = serviceData;
        } else {
            services.podology.services.push(serviceData);
        }

        try {
            await AdminAPI.save('services', services);
            AdminState.setServices(services);
            showToast('Услуга сохранена', 'success');
            AdminModals.close('modal');
            AdminServicesRenderer.renderPodology();
        } catch (error) {
            showToast('Ошибка сохранения: ' + error.message, 'error');
        }
    }

    /**
     * Удалить услугу
     */
    async function remove(categoryId, index) {
        if (!confirm('Вы уверены, что хотите удалить эту услугу?')) {
            return;
        }

        var services = AdminState.services || {};
        var category = services.categories && services.categories.find(function(c) {
            return c.id === categoryId;
        });

        if (category && category.services) {
            category.services.splice(index, 1);
        }

        try {
            await AdminAPI.save('services', services);
            AdminState.setServices(services);
            showToast('Услуга удалена', 'success');
            AdminServicesRenderer.render();
        } catch (error) {
            showToast('Ошибка удаления: ' + error.message, 'error');
        }
    }

    /**
     * Удалить услугу подологии
     */
    async function removePodology(index) {
        if (!confirm('Вы уверены, что хотите удалить эту услугу?')) {
            return;
        }

        var services = AdminState.services || {};

        if (services.podology && services.podology.services) {
            services.podology.services.splice(index, 1);
        }

        try {
            await AdminAPI.save('services', services);
            AdminState.setServices(services);
            showToast('Услуга удалена', 'success');
            AdminServicesRenderer.renderPodology();
        } catch (error) {
            showToast('Ошибка удаления: ' + error.message, 'error');
        }
    }

    // Публичный API
    return {
        show: show,
        showPodology: showPodology,
        save: save,
        savePodology: savePodology,
        remove: remove,
        removePodology: removePodology
    };
})();

// Экспорт
window.AdminServiceForm = AdminServiceForm;


// ============= forms/article-form.js =============

/**
 * Admin Article Form
 * Форма добавления/редактирования статьи
 */

var AdminArticleForm = (function() {
    'use strict';

    /**
     * Показать форму статьи
     */
    function show(article) {
        AdminState.editingItem = article || null;

        var title = article ? 'Редактировать статью' : 'Добавить статью';
        var today = new Date().toISOString().split('T')[0];

        var html = '<form id="articleForm" class="admin-form">' +
            '<div class="form-group">' +
                '<label class="form-label">Изображение</label>' +
                '<div class="image-upload ' + (article && article.image ? 'has-image' : '') + '" id="articleImageUpload">' +
                    (article && article.image ? '<img src="' + article.image + '" alt="Изображение">' : '') +
                    '<input type="file" accept="image/*" data-upload-target="articleImage">' +
                    SharedIcons.get('upload') +
                    '<span>Нажмите для загрузки изображения</span>' +
                    (article && article.image ? '<button type="button" class="remove-image" data-action="remove-image" data-target="articleImage">' + SharedIcons.get('close') + '</button>' : '') +
                '</div>' +
                '<input type="hidden" id="articleImage" value="' + (article && article.image ? article.image : '') + '">' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Заголовок *</label>' +
                '<input type="text" class="form-input" id="articleTitle" value="' + window.escapeHtml(article && article.title || '') + '" placeholder="Введите заголовок статьи" required>' +
            '</div>' +
            '<div class="form-row form-row-2">' +
                '<div class="form-group">' +
                    '<label class="form-label">Тег/Категория</label>' +
                    '<input type="text" class="form-input" id="articleTag" value="' + window.escapeHtml(article && article.tag || '') + '" placeholder="Уход за волосами">' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label">Дата публикации</label>' +
                    '<input type="date" class="form-input" id="articleDate" value="' + (article && article.date || today) + '">' +
                '</div>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Краткое описание</label>' +
                '<textarea class="form-textarea" id="articleExcerpt" placeholder="Краткое описание для превью статьи...">' + window.escapeHtml(article && article.excerpt || '') + '</textarea>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Полный текст статьи</label>' +
                AdminWYSIWYG.getEditorHTML('articleContent', article && article.content || '', 'Начните писать текст статьи...') +
            '</div>' +
        '</form>';

        AdminModals.setTitle('modal', title);
        var modalBody = document.getElementById('modalBody');
        if (modalBody) {
            modalBody.innerHTML = html;
        }
        AdminModals.open('modal');

        // Инициализация редактора после рендеринга DOM
        requestAnimationFrame(function() {
            AdminWYSIWYG.initWithToolbar('articleContent');
        });
    }

    /**
     * Сохранить статью
     */
    async function save() {
        var titleEl = document.getElementById('articleTitle');
        var title = titleEl ? titleEl.value.trim() : '';

        if (!title) {
            showToast('Введите заголовок статьи', 'error');
            return;
        }

        var tagEl = document.getElementById('articleTag');
        var dateEl = document.getElementById('articleDate');
        var excerptEl = document.getElementById('articleExcerpt');
        var imageEl = document.getElementById('articleImage');

        var tag = tagEl ? tagEl.value.trim() : 'Статья';
        var date = dateEl ? dateEl.value : new Date().toISOString().split('T')[0];
        var excerpt = excerptEl ? excerptEl.value.trim() : '';
        var content = AdminWYSIWYG.getContent('articleContent');
        var image = imageEl ? imageEl.value : null;

        var articleData = {
            id: AdminState.editingItem ? AdminState.editingItem.id : 'article_' + Date.now(),
            title: title,
            tag: tag || 'Статья',
            date: date,
            excerpt: excerpt,
            content: content,
            image: image,
            active: true
        };

        var articles = AdminState.articles || [];

        if (AdminState.editingItem) {
            var index = articles.findIndex(function(a) {
                return a.id === AdminState.editingItem.id;
            });
            if (index !== -1) {
                articles[index] = articleData;
            }
        } else {
            articles.push(articleData);
        }

        try {
            await AdminAPI.save('articles', { articles: articles });
            AdminState.setArticles(articles);
            showToast('Статья сохранена', 'success');
            AdminModals.close('modal');
            AdminArticlesRenderer.render();
        } catch (error) {
            showToast('Ошибка сохранения: ' + error.message, 'error');
        }
    }

    /**
     * Удалить статью
     */
    async function remove(id) {
        if (!confirm('Вы уверены, что хотите удалить эту статью?')) {
            return;
        }

        var articles = AdminState.articles.filter(function(a) {
            return a.id !== id;
        });

        try {
            await AdminAPI.save('articles', { articles: articles });
            AdminState.setArticles(articles);
            showToast('Статья удалена', 'success');
            AdminArticlesRenderer.render();
        } catch (error) {
            showToast('Ошибка удаления: ' + error.message, 'error');
        }
    }

    // Публичный API
    return {
        show: show,
        save: save,
        remove: remove
    };
})();

// Экспорт
window.AdminArticleForm = AdminArticleForm;


// ============= forms/faq-form.js =============

/**
 * Admin FAQ Form
 * Форма добавления/редактирования FAQ
 */

var AdminFaqForm = (function() {
    'use strict';

    /**
     * Показать форму FAQ
     */
    function show(faqItem) {
        AdminState.editingItem = faqItem || null;

        var title = faqItem ? 'Редактировать вопрос' : 'Добавить вопрос';

        var html = '<form id="faqForm" class="admin-form">' +
            '<div class="form-group">' +
                '<label class="form-label">Вопрос *</label>' +
                '<input type="text" class="form-input" id="faqQuestion" value="' + window.escapeHtml(faqItem && faqItem.question || '') + '" placeholder="Введите вопрос" required>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Ответ *</label>' +
                '<textarea class="form-textarea" id="faqAnswer" placeholder="Введите ответ на вопрос..." rows="5">' + window.escapeHtml(faqItem && faqItem.answer || '') + '</textarea>' +
            '</div>' +
        '</form>';

        AdminModals.setTitle('modal', title);
        var modalBody = document.getElementById('modalBody');
        if (modalBody) {
            modalBody.innerHTML = html;
        }
        AdminModals.open('modal');
    }

    /**
     * Сохранить FAQ
     */
    async function save() {
        var questionEl = document.getElementById('faqQuestion');
        var question = questionEl ? questionEl.value.trim() : '';

        if (!question) {
            showToast('Введите вопрос', 'error');
            return;
        }

        var answerEl = document.getElementById('faqAnswer');
        var answer = answerEl ? answerEl.value.trim() : '';

        if (!answer) {
            showToast('Введите ответ', 'error');
            return;
        }

        var faqData = {
            id: AdminState.editingItem ? AdminState.editingItem.id : 'faq_' + Date.now(),
            question: question,
            answer: answer
        };

        var faq = AdminState.faq || [];

        if (AdminState.editingItem) {
            var index = faq.findIndex(function(f) {
                return f.id === AdminState.editingItem.id;
            });
            if (index !== -1) {
                faq[index] = faqData;
            }
        } else {
            faq.push(faqData);
        }

        try {
            await AdminAPI.save('faq', { faq: faq });
            AdminState.setFaq(faq);
            showToast('Вопрос сохранён', 'success');
            AdminModals.close('modal');
            AdminFaqRenderer.render();
        } catch (error) {
            showToast('Ошибка сохранения: ' + error.message, 'error');
        }
    }

    /**
     * Удалить FAQ
     */
    async function remove(id) {
        if (!confirm('Вы уверены, что хотите удалить этот вопрос?')) {
            return;
        }

        var faq = AdminState.faq.filter(function(f) {
            return f.id !== id;
        });

        try {
            await AdminAPI.save('faq', { faq: faq });
            AdminState.setFaq(faq);
            showToast('Вопрос удалён', 'success');
            AdminFaqRenderer.render();
        } catch (error) {
            showToast('Ошибка удаления: ' + error.message, 'error');
        }
    }

    // Публичный API
    return {
        show: show,
        save: save,
        remove: remove
    };
})();

// Экспорт
window.AdminFaqForm = AdminFaqForm;


// ============= forms/category-form.js =============

/**
 * Shop Category Form
 * Форма добавления/редактирования категории товаров
 */

var AdminCategoryForm = (function() {
    'use strict';

    // Группы иконок для выбора
    var iconGroups = [
        {
            name: 'Барбершоп',
            icons: ['scissors', 'razor', 'comb', 'beard', 'brush', 'wave']
        },
        {
            name: 'Косметика',
            icons: ['droplet', 'spray', 'bottle', 'jar', 'tube']
        },
        {
            name: 'Свойства',
            icons: ['star', 'heart', 'sparkles', 'shield', 'zap', 'award', 'crown']
        },
        {
            name: 'Природа',
            icons: ['leaf', 'flame', 'snowflake', 'sun', 'moon']
        },
        {
            name: 'Разное',
            icons: ['folder', 'box', 'tag', 'gift', 'coffee', 'tool', 'package', 'percent']
        }
    ];

    function show(category) {
        AdminState.editingItem = category || null;
        var title = category ? 'Редактировать категорию' : 'Добавить категорию';
        var currentIcon = category && category.icon || 'scissors';

        var html = '<form id="categoryForm" class="admin-form">' +
            '<div class="form-row">' +
                '<div class="form-group form-group-flex">' +
                    '<label class="form-label">Название *</label>' +
                    '<input type="text" class="form-input" id="categoryName" ' +
                        'value="' + window.escapeHtml(category && category.name || '') + '" ' +
                        'placeholder="Средства для волос" required>' +
                '</div>' +
                '<div class="form-group form-group-small">' +
                    '<label class="form-label">URL (slug)</label>' +
                    '<input type="text" class="form-input" id="categorySlug" ' +
                        'value="' + window.escapeHtml(category && category.slug || '') + '" ' +
                        'placeholder="hair-care">' +
                '</div>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Описание</label>' +
                '<textarea class="form-textarea" id="categoryDescription" rows="2" ' +
                    'placeholder="Краткое описание категории...">' +
                    window.escapeHtml(category && category.description || '') +
                '</textarea>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-checkbox">' +
                    '<input type="checkbox" id="categoryActive" ' + (category && category.active === false ? '' : 'checked') + '>' +
                    '<span class="checkbox-mark"></span>' +
                    '<span class="checkbox-label">Активная категория</span>' +
                '</label>' +
                '<p class="form-hint">Неактивные категории не отображаются на сайте</p>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Иконка</label>' +
                '<div class="icon-selector-grouped" id="iconSelector">' +
                    iconGroups.map(function(group) {
                        return '<div class="icon-group">' +
                            '<span class="icon-group-label">' + group.name + '</span>' +
                            '<div class="icon-group-icons">' +
                                group.icons.map(function(icon) {
                                    var activeClass = currentIcon === icon ? ' active' : '';
                                    return '<button type="button" class="icon-option' + activeClass + '" data-icon="' + icon + '" title="' + icon + '">' +
                                        SharedIcons.get(icon) +
                                    '</button>';
                                }).join('') +
                            '</div>' +
                        '</div>';
                    }).join('') +
                '</div>' +
                '<input type="hidden" id="categoryIcon" value="' + window.escapeHtml(currentIcon) + '">' +
            '</div>' +
        '</form>';

        AdminModals.setTitle('modal', title);
        document.getElementById('modalBody').innerHTML = html;
        AdminModals.open('modal');

        initForm(category);
    }

    function initForm(category) {
        // Auto-generate slug from name
        var nameInput = document.getElementById('categoryName');
        var slugInput = document.getElementById('categorySlug');

        if (nameInput && slugInput) {
            nameInput.addEventListener('input', function() {
                if (!category) {
                    slugInput.value = generateSlug(nameInput.value);
                }
            });
        }

        // Icon selector
        var iconSelector = document.getElementById('iconSelector');
        var iconInput = document.getElementById('categoryIcon');

        if (iconSelector) {
            iconSelector.addEventListener('click', function(e) {
                var option = e.target.closest('.icon-option');
                if (option) {
                    iconSelector.querySelectorAll('.icon-option').forEach(function(o) {
                        o.classList.remove('active');
                    });
                    option.classList.add('active');
                    iconInput.value = option.dataset.icon;
                }
            });
        }
    }

    async function save() {
        var name = document.getElementById('categoryName').value.trim();
        if (!name) {
            showToast('Введите название категории', 'error');
            return;
        }

        var slug = document.getElementById('categorySlug').value.trim() || generateSlug(name);
        var description = document.getElementById('categoryDescription').value.trim();
        var icon = document.getElementById('categoryIcon').value || 'scissors';
        var active = document.getElementById('categoryActive').checked;

        var categoryData = {
            id: AdminState.editingItem ? AdminState.editingItem.id : 'category_' + Date.now(),
            name: name,
            slug: slug,
            description: description,
            icon: icon,
            order: AdminState.editingItem ? AdminState.editingItem.order : AdminState.shopCategories.length + 1,
            active: active
        };

        var categories = AdminState.shopCategories.slice();

        if (AdminState.editingItem) {
            var index = categories.findIndex(function(c) {
                return c.id === AdminState.editingItem.id;
            });
            if (index !== -1) categories[index] = categoryData;
        } else {
            categories.push(categoryData);
        }

        try {
            await AdminAPI.save('shop/categories', { categories: categories });
            AdminState.setShopCategories(categories);
            showToast('Категория сохранена', 'success');
            AdminModals.close('modal');
            AdminShopCategoriesRenderer.render();
        } catch (error) {
            showToast('Ошибка: ' + error.message, 'error');
        }
    }

    async function remove(id) {
        // Check if category has products
        var productsInCategory = AdminState.products.filter(function(p) {
            return p.categoryId === id;
        });

        if (productsInCategory.length > 0) {
            showToast('Нельзя удалить категорию с товарами (' + productsInCategory.length + ' шт.)', 'error');
            return;
        }

        var category = AdminState.findShopCategory(id);
        if (!category) return;

        if (!confirm('Удалить категорию "' + category.name + '"?')) {
            return;
        }

        var categories = AdminState.shopCategories.filter(function(c) {
            return c.id !== id;
        });

        try {
            await AdminAPI.save('shop/categories', { categories: categories });
            AdminState.setShopCategories(categories);
            showToast('Категория удалена', 'success');
            AdminShopCategoriesRenderer.render();
        } catch (error) {
            showToast('Ошибка: ' + error.message, 'error');
        }
    }

    // generateSlug теперь используется из SharedHelpers (helpers.js)

    return {
        show: show,
        save: save,
        remove: remove
    };
})();

window.AdminCategoryForm = AdminCategoryForm;


// ============= forms/product-form.js =============

/**
 * Product Form
 * Форма добавления/редактирования товара
 */

var AdminProductForm = (function() {
    'use strict';

    var uploadedImages = [];

    function show(product) {
        AdminState.editingItem = product || null;
        uploadedImages = product && product.images ? product.images.slice() : [];

        var title = product ? 'Редактировать товар' : 'Добавить товар';

        var categoriesOptions = AdminState.shopCategories.map(function(cat) {
            var selected = product && product.categoryId === cat.id ? ' selected' : '';
            return '<option value="' + window.escapeHtml(cat.id) + '"' + selected + '>' +
                window.escapeHtml(cat.name) + '</option>';
        }).join('');

        var html = '<form id="productForm" class="admin-form">' +
            '<div class="form-group">' +
                '<label class="form-label">Изображения</label>' +
                '<div class="images-upload-area" id="imagesUploadArea">' +
                    '<div class="images-grid" id="imagesGrid"></div>' +
                    '<label class="image-upload-btn">' +
                        '<input type="file" accept="image/*" multiple id="productImagesInput">' +
                        SharedIcons.get('plus') +
                        '<span>Добавить</span>' +
                    '</label>' +
                '</div>' +
                '<p class="form-hint">Первое изображение будет главным. Перетащите для изменения порядка.</p>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Название *</label>' +
                '<input type="text" class="form-input" id="productName" ' +
                    'value="' + window.escapeHtml(product && product.name || '') + '" ' +
                    'placeholder="Помада для укладки" required>' +
            '</div>' +
            '<div class="form-row form-row-2">' +
                '<div class="form-group">' +
                    '<label class="form-label">Категория *</label>' +
                    '<select class="form-select" id="productCategory" required>' +
                        '<option value="">Выберите категорию</option>' +
                        categoriesOptions +
                    '</select>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label">Цена (₽) *</label>' +
                    '<input type="number" class="form-input" id="productPrice" ' +
                        'value="' + (product && product.price || '') + '" ' +
                        'placeholder="1500" min="0" required>' +
                '</div>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Описание</label>' +
                '<textarea class="form-textarea" id="productDescription" rows="5" ' +
                    'placeholder="Подробное описание товара...">' +
                    window.escapeHtml(product && product.description || '') +
                '</textarea>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Статус</label>' +
                '<select class="form-select" id="productStatus">' +
                    '<option value="active"' + (product && product.status === 'active' ? ' selected' : '') + '>Активен</option>' +
                    '<option value="draft"' + (product && product.status === 'draft' ? ' selected' : '') + '>Черновик</option>' +
                    '<option value="archived"' + (product && product.status === 'archived' ? ' selected' : '') + '>В архиве</option>' +
                '</select>' +
            '</div>' +
        '</form>';

        AdminModals.setTitle('modal', title);
        document.getElementById('modalBody').innerHTML = html;
        AdminModals.open('modal');

        renderImagesGrid();
        initImageUpload();
    }

    function renderImagesGrid() {
        var grid = document.getElementById('imagesGrid');
        if (!grid) return;

        if (uploadedImages.length === 0) {
            grid.innerHTML = '';
            return;
        }

        var html = uploadedImages.map(function(img, i) {
            return '<div class="image-preview" data-index="' + i + '" draggable="true">' +
                '<img src="' + window.escapeHtml(img.url) + '" alt="">' +
                (i === 0 ? '<span class="main-badge">Главное</span>' : '') +
                '<button type="button" class="remove-image-btn" data-index="' + i + '">' +
                    SharedIcons.get('close') +
                '</button>' +
            '</div>';
        }).join('');

        grid.innerHTML = html;
        initDragAndDrop();
    }

    function initImageUpload() {
        var input = document.getElementById('productImagesInput');
        var grid = document.getElementById('imagesGrid');
        if (!input || !grid) return;

        input.addEventListener('change', async function(e) {
            var files = Array.from(e.target.files);

            for (var i = 0; i < files.length; i++) {
                var file = files[i];
                try {
                    showToast('Загрузка изображения...', 'info');
                    var result = await AdminImageUpload.uploadFile(file);
                    if (result && result.url) {
                        uploadedImages.push({
                            url: result.url,
                            isMain: uploadedImages.length === 0,
                            order: uploadedImages.length + 1
                        });
                        renderImagesGrid();
                    }
                } catch (error) {
                    showToast('Ошибка загрузки: ' + error.message, 'error');
                }
            }

            input.value = '';
        });

        // Remove image handler
        grid.addEventListener('click', function(e) {
            var removeBtn = e.target.closest('.remove-image-btn');
            if (removeBtn) {
                var index = parseInt(removeBtn.dataset.index, 10);
                uploadedImages.splice(index, 1);
                // Update isMain
                if (uploadedImages.length > 0) {
                    uploadedImages.forEach(function(img, i) {
                        img.isMain = i === 0;
                        img.order = i + 1;
                    });
                }
                renderImagesGrid();
            }
        });
    }

    function initDragAndDrop() {
        var grid = document.getElementById('imagesGrid');
        if (!grid) return;

        var draggedItem = null;
        var draggedIndex = null;

        grid.querySelectorAll('.image-preview').forEach(function(preview) {
            preview.addEventListener('dragstart', function(e) {
                draggedItem = this;
                draggedIndex = parseInt(this.dataset.index, 10);
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            preview.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                draggedItem = null;
                draggedIndex = null;
            });

            preview.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });

            preview.addEventListener('drop', function(e) {
                e.preventDefault();
                if (!draggedItem || draggedItem === this) return;

                var targetIndex = parseInt(this.dataset.index, 10);

                // Reorder array
                var item = uploadedImages.splice(draggedIndex, 1)[0];
                uploadedImages.splice(targetIndex, 0, item);

                // Update isMain and order
                uploadedImages.forEach(function(img, i) {
                    img.isMain = i === 0;
                    img.order = i + 1;
                });

                renderImagesGrid();
            });
        });
    }

    async function save() {
        var name = document.getElementById('productName').value.trim();
        var categoryId = document.getElementById('productCategory').value;
        var price = parseInt(document.getElementById('productPrice').value, 10);
        var description = document.getElementById('productDescription').value.trim();
        var status = document.getElementById('productStatus').value;

        if (!name) {
            showToast('Введите название товара', 'error');
            return;
        }
        if (!categoryId) {
            showToast('Выберите категорию', 'error');
            return;
        }
        if (isNaN(price) || price < 0) {
            showToast('Введите корректную цену', 'error');
            return;
        }

        var now = new Date().toISOString();

        var productData = {
            id: AdminState.editingItem ? AdminState.editingItem.id : 'product_' + Date.now(),
            name: name,
            slug: generateSlug(name),
            description: description,
            price: price,
            categoryId: categoryId,
            images: uploadedImages,
            status: status,
            order: AdminState.editingItem ? AdminState.editingItem.order : AdminState.products.length + 1,
            createdAt: AdminState.editingItem ? AdminState.editingItem.createdAt : now,
            updatedAt: now
        };

        var products = AdminState.products.slice();

        if (AdminState.editingItem) {
            var index = products.findIndex(function(p) {
                return p.id === AdminState.editingItem.id;
            });
            if (index !== -1) products[index] = productData;
        } else {
            products.push(productData);
        }

        try {
            await AdminAPI.save('shop/products', { products: products });
            AdminState.setProducts(products);
            showToast('Товар сохранён', 'success');
            AdminModals.close('modal');
            AdminShopProductsRenderer.render();
        } catch (error) {
            showToast('Ошибка: ' + error.message, 'error');
        }
    }

    async function remove(id) {
        var product = AdminState.findProduct(id);
        if (!product) return;

        if (!confirm('Удалить товар "' + product.name + '"?')) {
            return;
        }

        var products = AdminState.products.filter(function(p) {
            return p.id !== id;
        });

        try {
            await AdminAPI.save('shop/products', { products: products });
            AdminState.setProducts(products);
            showToast('Товар удалён', 'success');
            AdminShopProductsRenderer.render();
        } catch (error) {
            showToast('Ошибка: ' + error.message, 'error');
        }
    }

    // generateSlug теперь используется из SharedHelpers (helpers.js)

    return {
        show: show,
        save: save,
        remove: remove
    };
})();

window.AdminProductForm = AdminProductForm;


// ============= forms/legal-form.js =============

/**
 * Admin Legal Form
 * Форма редактирования юридических документов
 */

var AdminLegalForm = (function() {
    'use strict';

    var currentDocumentId = null;

    /**
     * Показать форму редактирования
     */
    function show(legalDoc) {
        currentDocumentId = legalDoc ? legalDoc.id : null;

        var title = legalDoc ? 'Редактирование документа' : 'Новый документ';

        var formHtml = '<form id="legalForm" class="modal-form">' +
            '<div class="form-group">' +
                '<label class="form-label">Название документа *</label>' +
                '<input type="text" class="form-input" id="legalTitle" value="' + window.escapeHtml(legalDoc ? legalDoc.title : '') + '" required placeholder="Политика конфиденциальности">' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">URL-идентификатор (slug) *</label>' +
                '<input type="text" class="form-input" id="legalSlug" value="' + window.escapeHtml(legalDoc ? legalDoc.slug : '') + '" required placeholder="privacy" pattern="[a-z0-9-]+">' +
                '<small class="form-hint">Только латинские буквы, цифры и дефис. Будет доступен по адресу /legal/slug</small>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Содержимое документа *</label>' +
                AdminWYSIWYG.getEditorHTML('legalContent', legalDoc ? legalDoc.content : '', 'Введите текст документа...') +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-checkbox">' +
                    '<input type="checkbox" id="legalActive" ' + (legalDoc && legalDoc.active !== false ? 'checked' : '') + '>' +
                    '<span>Документ активен (отображается на сайте)</span>' +
                '</label>' +
            '</div>' +
        '</form>';

        AdminModals.setTitle('modal', title);
        var modalBody = document.getElementById('modalBody');
        if (modalBody) {
            modalBody.innerHTML = formHtml;
        }
        AdminModals.open('modal');

        // Инициализация WYSIWYG редактора с тулбаром
        // Используем requestAnimationFrame для гарантии что DOM обновился
        requestAnimationFrame(function() {
            AdminWYSIWYG.initWithToolbar('legalContent');
        });
    }

    /**
     * Сохранить документ
     */
    async function save() {
        var title = document.getElementById('legalTitle').value.trim();
        var slug = document.getElementById('legalSlug').value.trim().toLowerCase();
        var content = AdminWYSIWYG.getContent('legalContent');
        var active = document.getElementById('legalActive').checked;

        // Валидация
        if (!title) {
            showToast('Введите название документа', 'error');
            return;
        }

        if (!slug) {
            showToast('Введите URL-идентификатор', 'error');
            return;
        }

        if (!/^[a-z0-9-]+$/.test(slug)) {
            showToast('Slug может содержать только латинские буквы, цифры и дефис', 'error');
            return;
        }

        if (!content || content === '<br>') {
            showToast('Введите содержимое документа', 'error');
            return;
        }

        var documents = AdminState.legalDocuments || [];

        // Проверка уникальности slug
        var existingDoc = documents.find(function(d) {
            return d.slug === slug && d.id !== currentDocumentId;
        });

        if (existingDoc) {
            showToast('Документ с таким slug уже существует', 'error');
            return;
        }

        if (currentDocumentId) {
            // Редактирование существующего
            var index = documents.findIndex(function(d) { return d.id === currentDocumentId; });
            if (index !== -1) {
                documents[index].title = title;
                documents[index].slug = slug;
                documents[index].content = content;
                documents[index].active = active;
                documents[index].updatedAt = new Date().toISOString();
            }
        } else {
            // Создание нового
            var newDocument = {
                id: SharedHelpers.generateId('legal'),
                slug: slug,
                title: title,
                content: content,
                active: active,
                updatedAt: new Date().toISOString()
            };
            documents.push(newDocument);
        }

        try {
            await AdminAPI.save('legal', { documents: documents });
            AdminState.setLegalDocuments(documents);
            AdminModals.close('modal');
            AdminLegalRenderer.render();
            showToast('Документ сохранён', 'success');
        } catch (error) {
            console.error('Error saving legal document:', error);
            showToast('Ошибка сохранения', 'error');
        }
    }

    /**
     * Удалить документ
     */
    function remove(id) {
        var legalDoc = AdminState.findLegalDocument(id);
        if (!legalDoc) return;

        AdminModals.confirmDelete(
            legalDoc.title,
            async function() {
                var documents = AdminState.legalDocuments.filter(function(d) {
                    return d.id !== id;
                });

                try {
                    await AdminAPI.save('legal', { documents: documents });
                    AdminState.setLegalDocuments(documents);
                    AdminLegalRenderer.render();
                    showToast('Документ удалён', 'success');
                } catch (error) {
                    console.error('Error deleting legal document:', error);
                    showToast('Ошибка удаления', 'error');
                }
            }
        );
    }

    // generateId теперь используется из SharedHelpers (helpers.js)

    // Публичный API
    return {
        show: show,
        save: save,
        remove: remove
    };
})();

// Экспорт
window.AdminLegalForm = AdminLegalForm;


// ============= index.js =============

/**
 * Admin Panel Main Entry Point
 * Инициализация и координация всех модулей
 */

var AdminPanel = (function() {
    'use strict';

    // DOM элементы
    var elements = {};

    // Ссылки на document handlers для cleanup
    var boundDocumentHandlers = {
        click: null,
        change: null,
        keydown: null
    };

    /**
     * Инициализация DOM элементов
     */
    function initElements() {
        elements = {
            // Navigation
            navItems: document.querySelectorAll('.nav-item'),
            sections: document.querySelectorAll('.section'),
            pageTitle: document.getElementById('pageTitle'),
            pageDescription: document.getElementById('pageDescription'),
            addNewBtn: document.getElementById('addNewBtn'),

            // Service tabs
            serviceTabs: document.querySelectorAll('.tab'),

            // Modals
            modalOverlay: document.getElementById('modalOverlay'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modalTitle'),
            modalBody: document.getElementById('modalBody'),
            modalClose: document.getElementById('modalClose'),
            modalCancel: document.getElementById('modalCancel'),
            modalSave: document.getElementById('modalSave'),

            // Delete modal
            deleteModalOverlay: document.getElementById('deleteModalOverlay'),
            deleteMessage: document.getElementById('deleteMessage'),
            deleteModalClose: document.getElementById('deleteModalClose'),
            deleteCancel: document.getElementById('deleteCancel'),
            deleteConfirm: document.getElementById('deleteConfirm'),

            // Social
            saveSocialBtn: document.getElementById('saveSocialBtn'),

            // Toast
            toastContainer: document.getElementById('toastContainer')
        };
    }

    /**
     * Загрузка всех данных
     */
    async function loadData() {
        try {
            var data = await AdminAPI.loadAllData();

            // Обновляем состояние (с проверкой на null от API)
            AdminState.setMasters((data.masters && data.masters.masters) || []);
            AdminState.setServices(data.services || {});
            AdminState.setArticles((data.articles && data.articles.articles) || []);
            AdminState.setFaq((data.faq && data.faq.faq) || []);
            AdminState.setSocial(data.social || {});
            AdminState.setShopCategories((data.shopCategories && data.shopCategories.categories) || []);
            AdminState.setProducts((data.products && data.products.products) || []);
            AdminState.setLegalDocuments((data.legal && data.legal.documents) || []);

            // Рендеринг
            renderCurrentSection();

            // Статистика
            if (data.stats) {
                AdminStatsRenderer.render(data.stats);
            }

            showToast('Данные загружены', 'success');
        } catch (error) {
            console.error('Error loading data:', error);
            showToast('Ошибка загрузки данных', 'error');
        }
    }

    /**
     * Рендеринг текущей секции
     */
    function renderCurrentSection() {
        var section = AdminState.currentSection;

        switch (section) {
            case 'stats':
                loadStats();
                break;
            case 'masters':
                AdminMastersRenderer.render();
                break;
            case 'services':
                AdminServicesRenderer.render();
                break;
            case 'podology':
                AdminServicesRenderer.renderPodology();
                break;
            case 'articles':
                AdminArticlesRenderer.render();
                break;
            case 'faq':
                AdminFaqRenderer.render();
                break;
            case 'social':
                AdminSocialRenderer.render();
                break;
            case 'shop-categories':
                AdminShopCategoriesRenderer.render();
                break;
            case 'shop-products':
                AdminShopProductsRenderer.render();
                break;
            case 'legal':
                AdminLegalRenderer.render();
                break;
        }
    }

    /**
     * Загрузка статистики
     */
    async function loadStats() {
        try {
            var stats = await AdminAPI.get('stats');
            AdminStatsRenderer.render(stats);
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    // =================================================================
    // NAVIGATION
    // =================================================================

    /**
     * Переключение секции
     */
    function switchSection(section) {
        AdminState.currentSection = section;

        // Обновляем навигацию
        elements.navItems.forEach(function(item) {
            item.classList.toggle('active', item.dataset.section === section);
        });

        // Скрываем все секции
        elements.sections.forEach(function(sec) {
            sec.classList.remove('active');
        });

        // Конфигурация секций
        var sectionConfig = {
            stats: {
                element: '#statsSection',
                title: 'Статистика',
                description: 'Аналитика посещений сайта',
                hideAddBtn: true
            },
            masters: {
                element: '#mastersSection',
                title: 'Мастера',
                description: 'Управление командой барберов',
                addText: 'Добавить мастера'
            },
            services: {
                element: '#servicesSection',
                title: 'Услуги',
                description: 'Прайс-лист барбершопа',
                addText: 'Добавить услугу'
            },
            podology: {
                element: '#podologySection',
                title: 'Подология',
                description: 'Услуги подологического кабинета',
                addText: 'Добавить услугу'
            },
            articles: {
                element: '#articlesSection',
                title: 'Статьи',
                description: 'Блог и полезные материалы',
                addText: 'Добавить статью'
            },
            faq: {
                element: '#faqSection',
                title: 'FAQ',
                description: 'Часто задаваемые вопросы',
                addText: 'Добавить вопрос'
            },
            social: {
                element: '#socialSection',
                title: 'Соцсети и контакты',
                description: 'Настройка социальных сетей и контактной информации',
                hideAddBtn: true
            },
            'shop-categories': {
                element: '#shopCategoriesSection',
                title: 'Категории товаров',
                description: 'Управление категориями интернет-магазина',
                addText: 'Добавить категорию'
            },
            'shop-products': {
                element: '#shopProductsSection',
                title: 'Товары',
                description: 'Управление товарами интернет-магазина',
                addText: 'Добавить товар'
            },
            legal: {
                element: '#legalSection',
                title: 'Юридические документы',
                description: 'Политики, соглашения и правовая информация',
                addText: 'Добавить документ'
            }
        };

        var config = sectionConfig[section];
        if (config) {
            var sectionEl = document.querySelector(config.element);
            if (sectionEl) {
                sectionEl.classList.add('active');
            }

            if (elements.pageTitle) {
                elements.pageTitle.textContent = config.title;
            }
            if (elements.pageDescription) {
                elements.pageDescription.textContent = config.description;
            }

            // Кнопка добавления
            if (elements.addNewBtn) {
                elements.addNewBtn.style.display = config.hideAddBtn ? 'none' : 'flex';
                var addBtnText = elements.addNewBtn.querySelector('span');
                if (addBtnText && config.addText) {
                    addBtnText.textContent = config.addText;
                }
            }
        }

        renderCurrentSection();
    }

    /**
     * Переключение категории услуг
     */
    function switchServiceCategory(category) {
        AdminState.currentCategory = category;

        elements.serviceTabs.forEach(function(tab) {
            tab.classList.toggle('active', tab.dataset.category === category);
        });

        AdminServicesRenderer.render();
    }

    // =================================================================
    // EVENT DELEGATION
    // =================================================================

    /**
     * Инициализация делегирования событий
     */
    function initEventDelegation() {
        // Глобальный обработчик кликов (сохраняем ссылку для cleanup)
        boundDocumentHandlers.click = function(e) {
            var target = e.target.closest('[data-action]');
            if (!target) return;

            var action = target.getAttribute('data-action');
            var id = target.getAttribute('data-id');
            var category = target.getAttribute('data-category');
            var index = target.getAttribute('data-index');

            switch (action) {
                // Masters
                case 'edit-master':
                    editMaster(id);
                    break;
                case 'delete-master':
                    AdminMasterForm.remove(id);
                    break;

                // Services
                case 'edit-service':
                    AdminServiceForm.show(category, parseInt(index, 10));
                    break;
                case 'delete-service':
                    AdminServiceForm.remove(category, parseInt(index, 10));
                    break;

                // Podology
                case 'edit-podology':
                    AdminServiceForm.showPodology(parseInt(index, 10));
                    break;
                case 'delete-podology':
                    AdminServiceForm.removePodology(parseInt(index, 10));
                    break;

                // Articles
                case 'edit-article':
                    editArticle(id);
                    break;
                case 'delete-article':
                    AdminArticleForm.remove(id);
                    break;

                // FAQ
                case 'edit-faq':
                    editFaq(id);
                    break;
                case 'delete-faq':
                    AdminFaqForm.remove(id);
                    break;

                // Social
                case 'toggle-social':
                    var socialId = target.getAttribute('data-social-id');
                    AdminSocialRenderer.toggleActive(socialId);
                    break;

                // Image upload
                case 'remove-image':
                    var imageTarget = target.getAttribute('data-target');
                    removeImage(imageTarget);
                    break;

                // Master principles
                case 'add-principle':
                    AdminMasterForm.addPrinciple();
                    break;
                case 'remove-principle':
                    AdminMasterForm.removePrinciple(target);
                    break;

                // Shop categories
                case 'edit-shop-category':
                    editShopCategory(id);
                    break;
                case 'delete-shop-category':
                    AdminCategoryForm.remove(id);
                    break;

                // Shop products
                case 'edit-product':
                    editProduct(id);
                    break;
                case 'delete-product':
                    AdminProductForm.remove(id);
                    break;

                // Legal documents
                case 'edit-legal':
                    editLegalDocument(id);
                    break;
                case 'delete-legal':
                    AdminLegalForm.remove(id);
                    break;
                case 'toggle-legal':
                    AdminLegalRenderer.toggleActive(id);
                    break;
            }
        };
        document.addEventListener('click', boundDocumentHandlers.click);

        // Обработчик загрузки изображений (сохраняем ссылку для cleanup)
        boundDocumentHandlers.change = function(e) {
            var target = e.target;
            if (target.matches('[data-upload-target]')) {
                var inputId = target.getAttribute('data-upload-target');
                handleImageUpload(e, inputId);
            }
        };
        document.addEventListener('change', boundDocumentHandlers.change);
    }

    // =================================================================
    // CRUD HELPERS
    // =================================================================

    function editMaster(id) {
        var master = AdminState.findMaster(id);
        if (master) {
            AdminMasterForm.show(master);
        }
    }

    function editArticle(id) {
        var article = AdminState.findArticle(id);
        if (article) {
            AdminArticleForm.show(article);
        }
    }

    function editFaq(id) {
        var faqItem = AdminState.findFaq(id);
        if (faqItem) {
            AdminFaqForm.show(faqItem);
        }
    }

    function editShopCategory(id) {
        var category = AdminState.findShopCategory(id);
        if (category) {
            AdminCategoryForm.show(category);
        }
    }

    function editProduct(id) {
        var product = AdminState.findProduct(id);
        if (product) {
            AdminProductForm.show(product);
        }
    }

    function editLegalDocument(id) {
        var document = AdminState.findLegalDocument(id);
        if (document) {
            AdminLegalForm.show(document);
        }
    }

    // =================================================================
    // IMAGE HANDLING
    // =================================================================

    async function handleImageUpload(event, inputId) {
        var file = event.target.files && event.target.files[0];
        if (!file) return;

        if (!file.type.startsWith('image/')) {
            showToast('Пожалуйста, выберите изображение', 'error');
            return;
        }

        if (file.size > 5 * 1024 * 1024) {
            showToast('Файл слишком большой (максимум 5 МБ)', 'error');
            return;
        }

        showToast('Загрузка изображения...', 'success');

        try {
            var result = await AdminImageUpload.uploadFile(file);

            if (result.success) {
                var input = document.getElementById(inputId);
                if (input) {
                    input.value = result.url;
                }

                var uploadDiv = event.target.closest('.image-upload');
                if (uploadDiv) {
                    uploadDiv.classList.add('has-image');

                    var img = uploadDiv.querySelector('img');
                    if (!img) {
                        img = document.createElement('img');
                        uploadDiv.appendChild(img);
                    }
                    img.src = result.url;
                    img.alt = 'Загруженное изображение';

                    if (!uploadDiv.querySelector('.remove-image')) {
                        var removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.className = 'remove-image';
                        removeBtn.setAttribute('data-action', 'remove-image');
                        removeBtn.setAttribute('data-target', inputId);
                        removeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
                        uploadDiv.appendChild(removeBtn);
                    }
                }

                showToast('Изображение загружено', 'success');
            } else {
                showToast('Ошибка загрузки: ' + (result.error || 'Неизвестная ошибка'), 'error');
            }
        } catch (error) {
            console.error('Upload error:', error);
            showToast('Ошибка загрузки изображения', 'error');
        }
    }

    function removeImage(inputId) {
        var input = document.getElementById(inputId);
        if (input) {
            input.value = '';
        }

        var uploadDiv = document.getElementById(inputId + 'Upload');
        if (!uploadDiv && input) {
            uploadDiv = input.closest('.form-group').querySelector('.image-upload');
        }

        if (uploadDiv) {
            uploadDiv.classList.remove('has-image');
            var img = uploadDiv.querySelector('img');
            if (img) img.remove();
            var removeBtn = uploadDiv.querySelector('.remove-image');
            if (removeBtn) removeBtn.remove();
        }
    }

    // =================================================================
    // EVENT LISTENERS
    // =================================================================

    function initEventListeners() {
        // Navigation
        elements.navItems.forEach(function(item) {
            item.addEventListener('click', function() {
                switchSection(item.dataset.section);
            });
        });

        // Service tabs
        elements.serviceTabs.forEach(function(tab) {
            tab.addEventListener('click', function() {
                switchServiceCategory(tab.dataset.category);
            });
        });

        // Add new button
        if (elements.addNewBtn) {
            elements.addNewBtn.addEventListener('click', function() {
                switch (AdminState.currentSection) {
                    case 'masters':
                        AdminMasterForm.show();
                        break;
                    case 'services':
                        AdminServiceForm.show(AdminState.currentCategory);
                        break;
                    case 'podology':
                        AdminServiceForm.showPodology();
                        break;
                    case 'articles':
                        AdminArticleForm.show();
                        break;
                    case 'faq':
                        AdminFaqForm.show();
                        break;
                    case 'shop-categories':
                        AdminCategoryForm.show();
                        break;
                    case 'shop-products':
                        AdminProductForm.show();
                        break;
                    case 'legal':
                        AdminLegalForm.show();
                        break;
                }
            });
        }

        // Modal controls
        if (elements.modalClose) {
            elements.modalClose.addEventListener('click', function() {
                AdminModals.close('modal');
            });
        }
        if (elements.modalCancel) {
            elements.modalCancel.addEventListener('click', function() {
                AdminModals.close('modal');
            });
        }
        if (elements.modalOverlay) {
            elements.modalOverlay.addEventListener('click', function(e) {
                if (e.target === elements.modalOverlay) {
                    AdminModals.close('modal');
                }
            });
        }

        // Modal save
        if (elements.modalSave) {
            elements.modalSave.addEventListener('click', function() {
                switch (AdminState.currentSection) {
                    case 'masters':
                        AdminMasterForm.save();
                        break;
                    case 'services':
                        AdminServiceForm.save();
                        break;
                    case 'podology':
                        AdminServiceForm.savePodology();
                        break;
                    case 'articles':
                        AdminArticleForm.save();
                        break;
                    case 'faq':
                        AdminFaqForm.save();
                        break;
                    case 'shop-categories':
                        AdminCategoryForm.save();
                        break;
                    case 'shop-products':
                        AdminProductForm.save();
                        break;
                    case 'legal':
                        AdminLegalForm.save();
                        break;
                }
            });
        }

        // Escape key (сохраняем ссылку для cleanup)
        boundDocumentHandlers.keydown = function(e) {
            if (e.key === 'Escape') {
                AdminModals.closeCurrent();
            }
        };
        document.addEventListener('keydown', boundDocumentHandlers.keydown);

        // Save social button
        if (elements.saveSocialBtn) {
            elements.saveSocialBtn.addEventListener('click', function() {
                AdminSocialRenderer.save();
            });
        }
    }

    // =================================================================
    // INITIALIZATION
    // =================================================================

    /**
     * Инициализация админ-панели после логина
     */
    function initAdminPanel() {
        initElements();

        // Инициализация модулей
        AdminModals.init();
        AdminStatsRenderer.init();
        AdminMastersRenderer.init();
        AdminServicesRenderer.init();
        AdminArticlesRenderer.init();
        AdminFaqRenderer.init();
        AdminSocialRenderer.init();
        AdminShopCategoriesRenderer.init();
        AdminShopProductsRenderer.init();
        AdminLegalRenderer.init();

        // Инициализация поиска
        if (window.AdminSearch) {
            AdminSearch.init('mastersSearch', 'mastersGrid');
            AdminSearch.init('articlesSearch', 'articlesGrid');
            AdminSearch.init('faqSearch', 'faqList');
        }

        // Инициализация логаута
        AdminAuth.initLogoutButton();

        // Event listeners
        initEventListeners();
        initEventDelegation();

        // Загрузка данных и переход на статистику
        loadData();
        switchSection('stats');
    }

    /**
     * Главная точка входа
     */
    async function init() {
        await AdminAuth.init(
            // onAuthenticated
            function() {
                initAdminPanel();
            },
            // onNotAuthenticated
            function() {
                AdminAuth.initLoginForm(function() {
                    initAdminPanel();
                });
            }
        );
    }

    /**
     * Очистка ресурсов и event listeners
     */
    function destroy() {
        // Удаляем document listeners
        if (boundDocumentHandlers.click) {
            document.removeEventListener('click', boundDocumentHandlers.click);
            boundDocumentHandlers.click = null;
        }
        if (boundDocumentHandlers.change) {
            document.removeEventListener('change', boundDocumentHandlers.change);
            boundDocumentHandlers.change = null;
        }
        if (boundDocumentHandlers.keydown) {
            document.removeEventListener('keydown', boundDocumentHandlers.keydown);
            boundDocumentHandlers.keydown = null;
        }

        // Уничтожаем drag-drop если доступен
        if (window.AdminDragDrop && AdminDragDrop.destroy) {
            AdminDragDrop.destroy('mastersGrid');
            AdminDragDrop.destroy('faqList');
            AdminDragDrop.destroy('shopCategoriesGrid');
            AdminDragDrop.destroy('shopProductsGrid');
        }

        // Сбрасываем состояние
        if (window.AdminState && AdminState.reset) {
            AdminState.reset();
        }

        // Очищаем кэш элементов
        elements = {};
    }

    // Запуск при готовности DOM
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // Публичный API (для совместимости с onclick в HTML)
    return {
        // Navigation
        switchSection: switchSection,
        switchServiceCategory: switchServiceCategory,

        // Masters
        editMaster: editMaster,
        deleteMaster: function(id) { AdminMasterForm.remove(id); },
        showMasterForm: function(id) {
            var master = id ? AdminState.findMaster(id) : null;
            AdminMasterForm.show(master);
        },

        // Services
        editService: function(categoryId, index) {
            AdminServiceForm.show(categoryId, index);
        },
        deleteService: function(categoryId, index) {
            AdminServiceForm.remove(categoryId, index);
        },
        editPodologyService: function(index) {
            AdminServiceForm.showPodology(index);
        },
        deletePodologyService: function(index) {
            AdminServiceForm.removePodology(index);
        },

        // Articles
        editArticle: editArticle,
        deleteArticle: function(id) { AdminArticleForm.remove(id); },
        showArticleForm: function(id) {
            var article = id ? AdminState.findArticle(id) : null;
            AdminArticleForm.show(article);
        },

        // FAQ
        editFaq: editFaq,
        deleteFaq: function(id) { AdminFaqForm.remove(id); },
        showFaqForm: function(id) {
            var faqItem = id ? AdminState.findFaq(id) : null;
            AdminFaqForm.show(faqItem);
        },

        // Social
        toggleSocialActive: function(id) {
            AdminSocialRenderer.toggleActive(id);
        },
        saveSocial: function() {
            AdminSocialRenderer.save();
        },

        // Image handling
        handleImageUpload: handleImageUpload,
        removeImage: removeImage,

        // Master principles
        addPrinciple: function() { AdminMasterForm.addPrinciple(); },
        removePrinciple: function(btn) { AdminMasterForm.removePrinciple(btn); },

        // Shop categories
        editShopCategory: editShopCategory,
        deleteShopCategory: function(id) { AdminCategoryForm.remove(id); },
        showCategoryForm: function(id) {
            var category = id ? AdminState.findShopCategory(id) : null;
            AdminCategoryForm.show(category);
        },

        // Shop products
        editProduct: editProduct,
        deleteProduct: function(id) { AdminProductForm.remove(id); },
        showProductForm: function(id) {
            var product = id ? AdminState.findProduct(id) : null;
            AdminProductForm.show(product);
        },

        // WYSIWYG
        formatText: function(command) {
            AdminWYSIWYG.formatText(command);
        },

        // Reload
        loadData: loadData,

        // Cleanup
        destroy: destroy
    };
})();

// Экспорт
window.AdminPanel = AdminPanel;
